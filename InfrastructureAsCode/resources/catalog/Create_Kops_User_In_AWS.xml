<?xml version="1.0" encoding="UTF-8"?>
<job
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="urn:proactive:jobdescriptor:3.14" xsi:schemaLocation="urn:proactive:jobdescriptor:3.14 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.14/schedulerjob.xsd"  name="Create_Kops_User_In_AWS" projectName="Kubernetes Workflows" tags="AWS,IAM,Kops,Kubernetes,K8S" priority="normal" onTaskError="suspendTask"  maxNumberOfExecution="1"  >
  <variables>
    <variable name="AWS_ACCESS_KEY" value="my_aws_access_key" model="PA:NOT_EMPTY_STRING" description="AWS access key to be used by AWS CLI" group="AWS Subscription" advanced="false" hidden="false"/>
    <variable name="AWS_SECRET_KEY" value="$AWS_ACCESS_KEY" model="PA:CREDENTIAL" description="AWS secret key to be used by AWS CLI" group="AWS Subscription" advanced="false" hidden="false"/>
    <variable name="AWS_REGION" value="eu-west-3" model="PA:NOT_EMPTY_STRING" description="AWS region to be used by AWS CLI" group="AWS Subscription" advanced="true" hidden="false"/>
    <variable name="AWS_IAM_USER_NAME" value="kops" model="PA:NOT_EMPTY_STRING" description="Name of the user to be created for Kops" group="Kubernetes Parameters" advanced="false" hidden="false"/>
    <variable name="AWS_IAM_GROUP_NAME" value="kops" model="PA:NOT_EMPTY_STRING" description="Name of the user group to be created for Kops" group="Kubernetes Parameters" advanced="false" hidden="false"/>
  </variables>
  <description>
    <![CDATA[ A workflow that creates a user and a group in AWS to be used by Kops. The privileges of the user and its group are configured to fit the requirements of Kops.
The workflow requires Docker to be installed in the underlying host where it will be executed, since AWS CLI runs inside a docker container (activeeon/k8s-tools). ]]>
  </description>
  <genericInformation>
    <info name="bucketName" value="it-infrastructure-as-code"/>
    <info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/amazon.png"/>
    <info name="group" value="admin"/>
    <info name="Documentation" value="https://kops.sigs.k8s.io/"/>
  </genericInformation>
  <taskFlow>
    <task name="Create_AWS_IAM_User" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A bash task that creates a user and a group in AWS to be used by Kops. The privileges of the user and its group are configured to fit the requirements of Kops.
The task requires Docker to be installed in the underlying host where it will be executed, since AWS CLI runs inside a docker container (activeeon/k8s-tools). ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/amazon.png"/>
      </genericInformation>
      <depends>
        <task ref="Read_AWS_Credentials"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
mkdir -p /tmp/kops/$variables_PA_JOB_ID/.aws
mkdir -p /tmp/kops/$variables_PA_JOB_ID/.kube

AWS_DIR=/tmp/kops/$variables_PA_JOB_ID/.aws
KUBE_DIR=/tmp/kops/$variables_PA_JOB_ID/.kube

echo "[default]" > $AWS_DIR/config
echo "region=$variables_AWS_REGION" >> $AWS_DIR/config
echo "output=json" >> $AWS_DIR/config

echo "[default]" > $AWS_DIR/credentials
echo "aws_access_key_id=$variables_AWS_ACCESS_KEY" >> $AWS_DIR/credentials
echo "aws_secret_access_key=$variables_AWS_ACCESS_SECRET" >> $AWS_DIR/credentials

# Alias for executing Kops, Kubectl and aws commands
K8S_TOOLS="docker run --rm -i -v $AWS_DIR:/root/.aws -v $KUBE_DIR:/root/.kube activeeon/k8s-tools"

################### CREATE KOPS user in AWS ################### 
USER_NAME=$variables_AWS_IAM_USER_NAME
GROUP_NAME=$variables_AWS_IAM_GROUP_NAME

$K8S_TOOLS aws iam get-user --user-name $USER_NAME
if [ $? -eq 0 ]; then
    echo "User $USER_NAME already exists"
else
    $K8S_TOOLS aws iam get-group --group-name $GROUP_NAME
    if [ $? -eq 0 ]; then
        echo "Group $GROUP_NAME already exists"
    else
        $K8S_TOOLS aws iam create-group --group-name $GROUP_NAME
        $K8S_TOOLS aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonEC2FullAccess --group-name $GROUP_NAME
        $K8S_TOOLS aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonRoute53FullAccess --group-name $GROUP_NAME
        $K8S_TOOLS aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess --group-name $GROUP_NAME
        $K8S_TOOLS aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/IAMFullAccess --group-name $GROUP_NAME
        $K8S_TOOLS aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonVPCFullAccess --group-name $GROUP_NAME
        $K8S_TOOLS aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonSQSFullAccess --group-name $GROUP_NAME
        $K8S_TOOLS aws iam attach-group-policy --policy-arn arn:aws:iam::aws:policy/AmazonEventBridgeFullAccess --group-name $GROUP_NAME
        $K8S_TOOLS aws iam create-user --user-name $USER_NAME
        $K8S_TOOLS aws iam add-user-to-group --user-name $USER_NAME --group-name $GROUP_NAME
        $K8S_TOOLS aws iam create-access-key --user-name $USER_NAME
    fi
fi
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            840.984375
        </positionTop>
        <positionLeft>
            573.25
        </positionLeft>
      </metadata>
    </task>
    <task name="Read_AWS_Credentials" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A groovy task that reads the AWS access credentials from the ProActive buit-in vault (called 3rd Party Credentials vault) ]]>
      </description>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
variables.put("AWS_ACCESS_SECRET",credentials.get(variables.get("AWS_ACCESS_KEY")))
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            715
        </positionTop>
        <positionLeft>
            574.25
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2725px;
            height:3120px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-710px;left:-568.25px"><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1452" style="top: 840.984px; left: 573.25px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A bash task that creates a user and a group in AWS to be used by Kops. The privileges of the user and its group are configured to fit the requirements of Kops.
The task requires Docker to be installed in the underlying host where it will be executed, since AWS CLI runs inside a docker container (activeeon/k8s-tools)."><img src="/automation-dashboard/styles/patterns/img/wf-icons/amazon.png" width="20px">&nbsp;<span class="name">Create_AWS_IAM_User</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" id="jsPlumb_1_1455" style="top: 715px; left: 574.25px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A groovy task that reads the AWS access credentials from the ProActive buit-in vault (called 3rd Party Credentials vault)"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Read_AWS_Credentials</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><svg style="position:absolute;left:636.5px;top:754.5px" width="22" height="87" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 86 C -10 36 11 50 1 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.73415625,64.94400000000002 L5.108873024641382,45.2593132664724 L-2.139615276695144,50.956629945873985 L-8.878497029484652,44.66477229316754 L-2.73415625,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.73415625,64.94400000000002 L5.108873024641382,45.2593132664724 L-2.139615276695144,50.956629945873985 L-8.878497029484652,44.66477229316754 L-2.73415625,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 637px; top: 871px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 637px; top: 831px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 638px; top: 745px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>
