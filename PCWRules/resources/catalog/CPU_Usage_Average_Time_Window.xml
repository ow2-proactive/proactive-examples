<?xml version="1.0" encoding="UTF-8"?>
<rule
        xmlns="urn:proactive:ruledescriptor:dev" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="urn:proactive:ruledescriptor:dev /org/ow2/proactive/cloud_watch/ruledescriptor/dev/ruleschema.xsd">

    <variables>
        <variable name="nodeUrlVar" value="service:jmx:rmi:///jndi/rmi://tryqa.activeeon.com:59885/rmnode" />
        <variable name="timeWindow" value="10s" />
        <variable name="bucketNameOfWorkflowAsActionVar" value="basic-examples" />
        <variable name="workflowNameAsActionVar" value="Native_Task_Linux" />
        <variable name="thresholdPercentCPUMetric" value="70" />
        <variable name="pollingPeriodInSecondsVar" value="60" />
        <variable name="calmPeriodInSecondsVar" value="120" />
        <variable name="usageCombinedCPUMetric" value="sigar:Type=CpuUsage Combined" />
    </variables>

    <ruleImplementation>
        <pollingClass value="Jmx_Metrics">
            <parameters>
                <parameter name="jmxCredentialsFile" value="#pathToCredentialFileVar" />
                <parameter name="nodeUrl" value="#nodeUrlVar" />
                <parameter name="pollingPeriodInSeconds" value="#pollingPeriodInSecondsVar" />
                <parameter name="calmPeriodInSeconds" value="#calmPeriodInSecondsVar" />
            </parameters>
        </pollingClass>
        <kpis> <kpi>#usageCombinedCPUMetric</kpi> </kpis>
        <droolContent>
        <![CDATA[
package org.ow2.proactive.cloud_watch.rules
import java.util.*;
import  org.ow2.proactive.cloud_watch.model.*;
import  org.ow2.proactive.cloud_watch.service.*;
global org.ow2.proactive.cloud_watch.action.ActionExecutorFromCatalog executorWorkflowFromCatalog;
declare NodeMetrics
 @role( event )
end

rule #autogenerated_rule_id when
    exists   kpi : NodeMetrics( url == "#nodeUrlVar" )
    result : Number( (doubleValue * 100) > #thresholdPercentCPUMetric ) from accumulate(
    NodeMetrics($metric : metrics["#usageCombinedCPUMetric"]) over window:time(#timeWindow), average( $metric ) )

then
    Map<String, String> parameters = new HashMap();
    parameters.put("credentialsPath","#pathToCredentialFileVar");
    executorWorkflowFromCatalog.submitToScheduler(parameters, "#autogenerated_rule_id", "{'bucket_name':'#bucketNameOfWorkflowAsActionVar','workflow_name':'#workflowNameAsActionVar','variables':{}}");
end
]]>
        </droolContent>
    </ruleImplementation>
</rule>
