<?xml version="1.0" encoding="UTF-8"?>
<rule xmlns="urn:proactive:ruledescriptor:1.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="urn:proactive:ruledescriptor:1.0 /org/ow2/proactive/cloud_watch/ruledescriptor/1.0/ruleschema.xsd">
    <name>NodeIsUpRule</name>

    <variables>
        <variable name="nodeUrlVar" value="localhost" />
        <variable name="pathToCredentialFileVar" value="/home/cperMaster/opt/proactive/scheduling/config/authentication/admin_user.cred" />
        <variable name="bucketNameOfWorkflowAsActionVar" value="cloud-automation" />
        <variable name="workflowNameAsActionVar" value="PCW_action_wf" />
        <variable name="pollingPeriodInSecondsVar" value="30" />
        <variable name="calmPeriodInSecondsVar" value="120" />
    </variables>

    <ruleImplementation>
        <pollingClass value="Ping">
            <parameters>
                <parameter name="jmxCredentialsFile" value="#pathToCredentialFileVar" />
                <parameter name="nodeUrl" value="#nodeUrlVar" />
                <parameter name="pollingPeriodInSeconds" value="#pollingPeriodInSecondsVar" />
                <parameter name="calmPeriodInSeconds" value="#calmPeriodInSecondsVar" />
            </parameters>
        </pollingClass>
        <kpis> <kpi>upAndRunning</kpi> </kpis>
        <droolContent>
            <![CDATA[
package org.ow2.proactive.cloud_watch.rules 
 import java.util.*;  
 import  org.ow2.proactive.cloud_watch.model.*; 
import  org.ow2.proactive.cloud_watch.service.*; 
global org.ow2.proactive.cloud_watch.action.ActionExecutor actionExecutorCloudAutomationService; 
declare isNodeAction 
 nodeMetrics: NodeMetrics 
end 
 
rule NodeIsUpRule when
  exists  kpi : NodeMetrics( url == "#nodeUrlVar" )
  $metric : NodeMetrics(metrics["upAndRunning"]  == true) 
 
then 
    System.out.println("In then condition of ping rule"); 
    Map<String, String> parameters = new HashMap(); 
 parameters.put("credentialsPath","#pathToCredentialFileVar"); 
    actionExecutorCloudAutomationService.execute(parameters, "NodeIsUpRule", "{'bucket_name':'#bucketNameOfWorkflowAsActionVar','workflow_name':'#workflowNameAsActionVar','variables':{}}");
end 
]]>
        </droolContent>
    </ruleImplementation>
</rule>