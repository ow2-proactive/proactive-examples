<?xml version="1.0" encoding="UTF-8"?>
<job
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="urn:proactive:jobdescriptor:3.14" xsi:schemaLocation="urn:proactive:jobdescriptor:3.14 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.14/schedulerjob.xsd"  name="Azure_HDInsight_Create_Spark_Cluster" tags="Azure,Big Data,Data Streaming,Spark,HDInsight" projectName="08. Azure HDInsight Spark Workflows" priority="normal" onTaskError="suspendTask"  maxNumberOfExecution="1"  >
  <variables>
    <variable name="USE_JSON_INPUT_FILE" value="false" model="PA:Boolean" description="A boolean variable indicating whether the input parameters of the workflow are provided in a JSON file placed in the global data space. If not, the workflow will consider the input variables form." group="Input File Parameters" advanced="false" hidden="false"/>
    <variable name="JSON_INPUT_FILE" value=""  description="A JSON file placed in the global data space, which contains all input parameters of the workflow." group="Input File Parameters" advanced="false" hidden="false"/>
    <variable name="JSON_INPUT_FILE_HANDLER" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;true&#39; ?  showVar(&#39;JSON_INPUT_FILE&#39;) &amp;&amp; hideGroup(&#39;Subscription Parameters&#39;) &amp;&amp; hideGroup(&#39;Deployment Parameters&#39;) &amp;&amp; hideGroup(&#39;Spark Cluster Parameters&#39;) &amp;&amp; hideGroup(&#39;Script Action&#39;) &amp;&amp; hideGroup(&#39;ProActive Node Parameters&#39;) &amp;&amp; hideGroup(&#39;Number of Workers&#39;) &amp;&amp;  (models[&#39;JSON_INPUT_FILE&#39;] = &#39;PA:GLOBAL_FILE&#39;) instanceof T(String) : hideVar(&#39;JSON_INPUT_FILE&#39;))" description="A hidden variable that allows to have a dynamic form for input parameters, i.e., variables will appear/disappear dynamically depending on the value of variable &#39;USE_JSON_INPUT_FILE&#39;."  advanced="false" hidden="true"/>
    <variable name="SUBSCRIPTION_ID" value="change-it-and-put-your-azure-subscription-id" model="PA:NOT_EMPTY_STRING" description="The subscription id of your Microsoft Azure account." group="Subscription Parameters" advanced="false" hidden="false"/>
    <variable name="TENANT_ID" value="change-it-and-put-your-azure-tenant-id" model="PA:NOT_EMPTY_STRING" description="The tenant id of your Microsoft Azure account." group="Subscription Parameters" advanced="true" hidden="false"/>
    <variable name="APP_ID" value="change-it-and-put-your-azure-client-application-id" model="PA:NOT_EMPTY_STRING" description="ID of a HDInsights client application." group="Subscription Parameters" advanced="true" hidden="false"/>
    <variable name="PASSWORD" value="ENC(L/ks1WBUEKZZ2K0wm+3i1A==)" model="PA:HIDDEN" description="Secret key needed to access a HDInsight client application." group="Subscription Parameters" advanced="true" hidden="false"/>
    <variable name="AUTHENTICATION_ENDPOINT" value="https://login.microsoftonline.com" model="PA:URL" description="Hidden variable that contains the authentication endpoint of Azure REST API."  advanced="false" hidden="true"/>
    <variable name="MANAGEMENT_ENDPOINT" value="https://management.azure.com" model="PA:URL" description="Hidden variable that contains the REST endpoint for managing Azure HDInsight clusters."  advanced="false" hidden="true"/>
    <variable name="RESOURCE_GROUP_NAME" value="RG-of-${CLUSTER_NAME}" model="PA:NOT_EMPTY_STRING" description="Hidden variable that contains the name of the Resource Group where the Spark cluster will be created. If the value of this variable is changed, it must be also changed in the workflows &#39;Azure_HDInsight_Scale_Spark_Cluster&#39; and &#39;Azure_HDInsight_Delete_Spark_Cluster&#39;" group="Deployment Parameters" advanced="false" hidden="true"/>
    <variable name="RESOURCE_GROUP_LOCATION" value="westeurope" model="PA:NOT_EMPTY_STRING" description="The region of Azure Cloud where the Resource Group will be created" group="Deployment Parameters" advanced="true" hidden="false"/>
    <variable name="DEPLOYMENT_NAME" value="Deployment-of-${CLUSTER_NAME}" model="PA:NOT_EMPTY_STRING" description="Hidden variable that contains the name of the Deployment for the Spark cluster. If the value of this variable is changed, it must be also changed in the workflows &#39;Azure_HDInsight_Scale_Spark_Cluster&#39; and &#39;Azure_HDInsight_Delete_Spark_Cluster&#39;" group="Deployment Parameters" advanced="false" hidden="true"/>
    <variable name="ARM_TEMPLATE" value="Azure_HDInsight_Spark_ARM_Template.json" model="PA:GLOBAL_FILE" description="Microsoft Azure ARM template (a JSON file), which is used to create the Spark cluster. This file must be placed in the global data space." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_NAME" value="activeeon-spark-cluster-${PA_JOB_ID}" model="PA:NOT_EMPTY_STRING" description="Name of the Spark cluster to be created." group="Spark Cluster Parameters" advanced="false" hidden="false"/>
    <variable name="CLUSTER_USER" value="act-usr" model="PA:NOT_EMPTY_STRING" description="User login needed to access the Web dashboard of the Spark cluster." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_PASSWORD" value="ENC(7ZqKwLLZE5B3S4BZoPq1wg==)" model="PA:HIDDEN" description="User password needed to access the Web dashboard of the Spark cluster." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_SSH_USER" value="act-usr" model="PA:NOT_EMPTY_STRING" description="User login needed to access the head node of the Spark cluster, remotely via SSH." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_SSH_PASSWORD" value="ENC(vIn1k0HbSAYteZas59YECw==)" model="PA:HIDDEN" description="User password needed to access the head node of the Spark cluster, remotely via SSH." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="HEAD_NODE_VM_SIZE" value="Standard_E4_v3" model="PA:LIST(Standard_A4_v2,Standard_A8_v2,Standard_E2_v3, Standard_E4_v3,Standard_E8_v3,Standard_E16_v3,Standard_E20_v3,Standard_E32_v3,Standard_E48_v3)" description="Size of the VM of Spark head node. If the list of VM sizes is changed, it must be also changed in the ARM template (provided in the variable &#39;ARM_TEMPLATE&#39;)." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="WORKER_NODE_VM_SIZE" value="Standard_E4_v3" model="PA:LIST(Standard_A4_v2,Standard_A8_v2,Standard_E2_v3, Standard_E4_v3,Standard_E8_v3,Standard_E16_v3,Standard_E20_v3,Standard_E32_v3,Standard_E48_v3)" description="Size of the VM of Spark worker node. If the list of VM sizes is changed, it must be also changed in the ARM template (provided in the variable &#39;ARM_TEMPLATE&#39;)." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="AUTOSCALING" value="true" model="PA:Boolean" description="Boolean value indicating whether the autoscaling feature (of HDInsight Spark) is activated or not." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="NUMBER_OF_WORKERS" value="2" model="PA:INTEGER" description="Number of Spark workers (to be used when the autoscaling feature is set to false)." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="MIN_WORKERS" value="1" model="PA:INTEGER" description="Minimal number of Spark workers (to be used when the autoscaling feature is set to true)." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="MAX_WORKERS" value="3" model="PA:INTEGER" description="Maximal number of Spark workers (to be used when the autoscaling feature is set to true)." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="AUTOSCALING_MODE" value="load" model="PA:LIST(load)" description="Autoscaling mode (only the &#39;load&#39; mode is supported by this workflow)." group="Number of Workers" advanced="true" hidden="false"/>
    <variable name="AUTOSCALING_NODES_HANDLER_1" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;false&#39; &amp;&amp; variables[&#39;AUTOSCALING&#39;] == &#39;false&#39; ?  showVar(&#39;NUMBER_OF_WORKERS&#39;) : hideVar(&#39;NUMBER_OF_WORKERS&#39;))" description="SPEL expression handling the variables to show with respect to the autoscaling setting." group="Number of Workers" advanced="false" hidden="true"/>
    <variable name="AUTOSCALING_NODES_HANDLER_2" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;false&#39; &amp;&amp; variables[&#39;AUTOSCALING&#39;] == &#39;true&#39; ?  showVar(&#39;MIN_WORKERS&#39;) &amp;&amp; showVar(&#39;MAX_WORKERS&#39;) &amp;&amp; showVar(&#39;AUTOSCALING_MODE&#39;) : hideVar(&#39;MIN_WORKERS&#39;) &amp;&amp; hideVar(&#39;MAX_WORKERS&#39;) &amp;&amp; hideVar(&#39;AUTOSCALING_MODE&#39;))" description="SPEL expression handling the variables to show with respect to the autoscaling setting."  advanced="false" hidden="true"/>
    <variable name="SCRIPT_ACTION" value="false" model="PA:Boolean" description="Boolean value indicating whether one or more script actions have to be executed when the Spark cluster is deployed." group="Script Action" advanced="true" hidden="false"/>
    <variable name="HEAD_NODE_SCRIPTS_JSON" value="[ {  &quot;name&quot;: &quot;Script A&quot;, &quot;uri&quot;: &quot;http://script.host:8080/scriptA&quot;,   &quot;parameters&quot;: &quot;p1 p2&quot;},  { &quot;name&quot;: &quot;script B&quot;, &quot;uri&quot;: &quot;http://script.host:8080/scriptB&quot;,  &quot;parameters&quot;: &quot;p1 p2 p3&quot; }]" model="PA:JSON" description="JSON payload describing the script actions to be executed in the head nodes of Spark (used when the &#39;SCRIPT_ACTION&#39; variable is set to true)." group="Script Action" advanced="true" hidden="false"/>
    <variable name="WORKER_NODE_SCRIPTS_JSON" value="[ ]" model="PA:JSON" description="JSON payload describing the script actions to be executed in the worker nodes of Spark (used when the &#39;SCRIPT_ACTION&#39; variable is set to true)." group="Script Action" advanced="true" hidden="false"/>
    <variable name="SCRIPT_ACTION_HANDLER" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;false&#39; &amp;&amp; variables[&#39;SCRIPT_ACTION&#39;] == &#39;true&#39; ?  showVar(&#39;HEAD_NODE_SCRIPTS_JSON&#39;) &amp;&amp; showVar(&#39;WORKER_NODE_SCRIPTS_JSON&#39;) : hideVar(&#39;HEAD_NODE_SCRIPTS_JSON&#39;) &amp;&amp; hideVar(&#39;WORKER_NODE_SCRIPTS_JSON&#39;))" description="SPEL expression handling the variables to show with respect to the SCRIPT_ACTION setting."  advanced="false" hidden="true"/>
    <variable name="PROACTIVE_NODE_CREDENTIALS" value="change-it-and-add-a-proactive-user-credentials" model="PA:CREDENTIAL" description="Credentials (login/password) of a ProActive user that will be used to deploy ProActive nodes in Spark head and worker machines. Must be added to the third-party credentials vault (the user login is the key and the password is the credential)." group="ProActive Node Parameters" advanced="false" hidden="false"/>
    <variable name="PROACTIVE_NODE_SOURCE_NAME" value="${CLUSTER_NAME}" model="PA:NOT_EMPTY_STRING" description="Name of the Node Source for ProActive nodes that will be deployed in the Spark cluster." group="ProActive Node Parameters" advanced="true" hidden="false"/>
    <variable name="HEAD_NODE_SCRIPT_NAME" value="Install_ProActive_Node_In_HN" model="PA:NOT_EMPTY_STRING" description="Hidden variable indicating the name of the script action that will deploy ProActive nodes in Spark head machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="HEAD_NODE_SCRIPT_URI" value="https://gist.github.com/activeeon-bot/5cf5f44d65df2cc1fe2c4ce3c552705b/raw/Install_ProActive_Node.sh" model="PA:URI" description="Hidden variable indicating the URI of the script action that will deploy ProActive nodes in Spark head machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="WORKER_NODE_SCRIPT_NAME" value="Install_ProActive_Node_In_WN" model="PA:NOT_EMPTY_STRING" description="Hidden variable indicating the name of the script action that will deploy ProActive nodes in Spark worker machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="WORKER_NODE_SCRIPT_URI" value="https://gist.github.com/activeeon-bot/5cf5f44d65df2cc1fe2c4ce3c552705b/raw/Install_ProActive_Node.sh" model="PA:URI" description="Hidden variable indicating the URI of the script action that will deploy ProActive nodes in Spark worker machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="NUMBER_OF_PROACTIVE_NODES" value="1" model="PA:INTEGER" description="Hidden variable indicating the number of ProActive nodes to be deployed in Spark head and worker machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="SCALE_WORKFLOW" value="big-data/Azure_HDInsight_Scale_Spark_Cluster" model="PA:CATALOG_OBJECT" description="Hidden variable indicating the workflow (in ProActive catalog) to be executed when the signal &#39;Scale_Nodes&#39; is triggered."  advanced="false" hidden="true"/>
    <variable name="DELETE_WORKFLOW" value="big-data/Azure_HDInsight_Delete_Spark_Cluster" model="PA:CATALOG_OBJECT" description="Hidden variable indicating the workflow (in ProActive catalog) to be executed when the signal &#39;Delete_Cluster&#39; is triggered."  advanced="false" hidden="true"/>
  </variables>
  <description>
    <![CDATA[ A workflow that uses Azure REST API to create a HDInsight Spark Cluster. It requires as input the variable ARM_TEMPLATE, which takes as value an Azure ARM template. A ready-to-use template called "Azure_HDInsight_Spark_ARM_Template.json" is provided in the global dataspace. Furthermore, the workflow customizes the ARM template with respect to the provided input variables.
Once the Spark cluster is deployed successfully, the workflow produces as job results: (i) URL of the Web UI of the HDInsight Spark cluster, (ii) SSH host of the head node (i.e., master) of the cluster, (iii) SSH port of the head node (i.e., master) of the cluster, and (iv) a file containing the set of input variables.
Use the Workflow Azure_HDInsight_Spark_Send_Signal${SIGNAL_TO_SEND} to manage the HDInsight cluster, i.e., perform scale or delete operations. ]]>
  </description>
  <genericInformation>
    <info name="bucketName" value="big-data"/>
    <info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
    <info name="group" value="public-objects"/>
  </genericInformation>
  <taskFlow>
    <task name="hdinsight_deploy_spark" fork="true">
      <description>
        <![CDATA[ A task performing a PUT request to Azure HDInsight REST API in order to deploy a Spark cluster, which name is given as input.
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01" inherited="false" description="Path of the request (relative to the base url)"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="CONTENT_TYPE" value="application/json;charset = UTF-8" inherited="false" description="Content-Type of the request"/>
        <variable name="REQUEST_BODY" value="${ARM_TEMPLATE_CONTENT}" inherited="false"    advanced="false" hidden="false" description="A JSON parameter containing the request body."/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="." inherited="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false" description="HTTP Authorization request header that contains the credentials to authenticate the user to the server"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
      </genericInformation>
      <depends>
        <task ref="azure-create_resource_group"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    DEPLOYMENT_NAME=variables.get("DEPLOYMENT_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01"
    variables.put("REQUEST_BODY", variables.get("ARM_TEMPLATE"))
    variables.put("PATH", PATH)
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given().contentType(variables.get("CONTENT_TYPE"))

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

requestBody = variables.get("REQUEST_BODY")
if (requestBody != null && !requestBody.isEmpty()) {
    
    if (!requestBody.startsWith("{")){
        File jsonFile = new File(requestBody);
        restCall = restCall.body(jsonFile)
    }
    else{
        restCall = restCall.body(requestBody)
    }    
}

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}

response = restCall.put(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            593.9488220214844
        </positionTop>
        <positionLeft>
            514.8153076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="azure_authenticate" fork="true">
      <description>
        <![CDATA[ A task performing a POST request to Azure REST API in order to authenticate to Azure and acquire an authentication token. ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${AUTHENTICATION_ENDPOINT}" inherited="false" model="PA:URL" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/${TENANT_ID}/oauth2/token" inherited="false" description="Path of the request (relative to the base url)"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="CONTENT_TYPE" value="application/x-www-form-urlencoded" inherited="false" description="Content-Type of the request"/>
        <variable name="REQUEST_BODY" value="&amp;grant_type=client_credentials&amp;client_id=${APP_ID}&amp;client_secret=%PASSWORD%&amp;resource=https%3A%2F%2Fmanagement.azure.com%2F" inherited="false" description="A JSON parameter containing the request body."/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="." inherited="false"    advanced="false" hidden="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/azure_icon.png"/>
      </genericInformation>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given().contentType(variables.get("CONTENT_TYPE"))

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

if (variables.get("REQUEST_BODY") != null && !variables.get("REQUEST_BODY").isEmpty()) {
    restCall = restCall.body(variables.get("REQUEST_BODY").replace("%PASSWORD%",variables.get("PASSWORD")))
}

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}
response = restCall.post(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}

variables.put("ACCESS_TOKEN",result)
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
   
// =========== Manage Azure Access token ============
def slurper = new JsonSlurper()
jsonData = slurper.parseText(JsonOutput.toJson(result))

access_token=jsonData.access_token
variables.put("ACCESS_TOKEN",access_token)
println variables.get("ACCESS_TOKEN")

expires_on=jsonData.expires_on
variables.put("EXPIRES_ON",expires_on)
println variables.get("EXPIRES_ON")


// =========== Check ProActive user credentials ============
def username = variables.get("PROACTIVE_NODE_CREDENTIALS")
def pwd = credentials.get(username)

def restUrl = variables.get("PA_SCHEDULER_REST_URL")
def post = new URL(restUrl +"/scheduler/login/").openConnection()
def message = "username=${username}&password=${pwd}"
post.setRequestMethod("POST")
post.setDoOutput(true)
post.getOutputStream().write(message.getBytes("UTF-8"))
def postRC = post.getResponseCode();
if (postRC.equals(200)) {
    sessionid=post.getInputStream().getText()
    variables.put("PROACTIVE_SESSION_ID",sessionid)
    println(variables.get("PROACTIVE_SESSION_ID"))
} else {
   throw new RuntimeException("Wrong credentials for user "+ username) 
}

variables.put("PROACTIVE_USER",username)
variables.put("PROACTIVE_PASSWORD",pwd)
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            80.866455078125
        </positionTop>
        <positionLeft>
            513.8067626953125
        </positionLeft>
      </metadata>
    </task>
    <task name="hdinsight_check_deployment" fork="true">
      <description>
        <![CDATA[ A task performing a Get request to Azure HDInsight REST API in order to  check the status of the deployment, which name is given as input.
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01" inherited="false" description="Path of the request (relative to the base url)"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="." inherited="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false" description="HTTP Authorization request header that contains the credentials to authenticate the user to the server"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
      </genericInformation>
      <depends>
        <task ref="hdinsight_deploy_spark"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    DEPLOYMENT_NAME=variables.get("DEPLOYMENT_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01"
    variables.put("PATH", PATH)
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given()

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("PARAM_")}).forEach({entry -> restCall = restCall.param(entry.getKey().replace("PARAM_",""), entry.getValue()) });

if (debug) {
    println "-------------- REQUEST ------------------"
	restCall = restCall.log().all()
}

response = restCall.get(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(HttpStatus.SC_OK)
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            721.9601898193359
        </positionTop>
        <positionLeft>
            514.8153076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="azure-create_resource_group" fork="true">
      <description>
        <![CDATA[ A task performing a PUT request to Azure HDInsight REST API in order to create a Resource Group, which name is given as input.
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}?api-version=2020-10-01" inherited="false" description="Path of the request (relative to the base url)"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="CONTENT_TYPE" value="application/json;charset = UTF-8" inherited="false" description="Content-Type of the request"/>
        <variable name="REQUEST_BODY" value="{&quot;location&quot;: &quot;${RESOURCE_GROUP_LOCATION}&quot;}" inherited="false"    advanced="false" hidden="false" description="A JSON parameter containing the request body."/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="." inherited="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false" description="HTTP Authorization request header that contains the credentials to authenticate the user to the server"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/hdinsight.png"/>
      </genericInformation>
      <depends>
        <task ref="prepare_arm_template_params"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}?api-version=2020-10-01"
    
    RESOURCE_GROUP_LOCATION=variables.get("RESOURCE_GROUP_LOCATION")
    REQUEST_BODY="{\"location\": \"${RESOURCE_GROUP_LOCATION}\"}"

    variables.put("PATH", PATH)
    variables.put("REQUEST_BODY", REQUEST_BODY)
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given().contentType(variables.get("CONTENT_TYPE"))

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

if (variables.get("REQUEST_BODY") != null && !variables.get("REQUEST_BODY").isEmpty()) {
    restCall = restCall.body(variables.get("REQUEST_BODY"))
}

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}

response = restCall.put(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            468.93463134765625
        </positionTop>
        <positionLeft>
            514.8010864257812
        </positionLeft>
      </metadata>
    </task>
    <task name="hdinsight_get_spark_cluster_info" maxNumberOfExecution="3" fork="true">
      <description>
        <![CDATA[ A task that performs iteratively a GET request to Azure HDInsight REST API, in order to get information about the cluster deployment status. If the deployment status is "Succeeded". The cluster Web UI, SSH host and SSH port are extracted and provided as job results, then the loop stops. 
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.HDInsight/clusters/${CLUSTER_NAME}?api-version=2018-06-01-preview" inherited="false" description="Path of the request (relative to the base url)"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="." inherited="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false" description="HTTP Authorization request header that contains the credentials to authenticate the user to the server"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
      </genericInformation>
      <depends>
        <task ref="hdinsight_check_deployment"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    CLUSTER_NAME=variables.get("CLUSTER_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.HDInsight/clusters/${CLUSTER_NAME}?api-version=2018-06-01-preview"
    variables.put("PATH", PATH)
}

sleep(30000)
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given()

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("PARAM_")}).forEach({entry -> restCall = restCall.param(entry.getKey().replace("PARAM_",""), entry.getValue()) });

if (debug) {
    println "-------------- REQUEST ------------------"
	restCall = restCall.log().all()
}

response = restCall.get(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(HttpStatus.SC_OK)
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow >
        <loop target="hdinsight_get_spark_cluster_info">
          <script>
            <code language="groovy">
              <![CDATA[
provisioningState = variables.get("PROVISIONING_STATE")
if (provisioningState=="InProgress"){
   loop= "* * * * *" 
} else if (provisioningState=="Failed" || provisioningState=="Canceled"){
   loop=false
   throw new Exception("HDInsight Spark cluster deployment "+ provisioningState)
} else {
   loop=false
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
    
def slurper = new JsonSlurper()
    
jsonData = slurper.parseText(JsonOutput.toJson(result))

provisioningState=jsonData.properties.provisioningState

variables.put("PROVISIONING_STATE",provisioningState)

println variables.get("PROVISIONING_STATE")

if (provisioningState=="Succeeded"){
    
    LinkedHashMap resMap = [:]
    
    SSHEndpoint=jsonData.properties.connectivityEndpoints[0]
    WebUIEndpoint=jsonData.properties.connectivityEndpoints[1]
    
    println "_____________________CLUSTER NAME________________"
    resMap.put("SPARK_CLUSTER_NAME",variables.get("CLUSTER_NAME"))
    
    println "_____________________WEB UI ENDPOINT________________"
    println WebUIEndpoint
    println "Name: " + WebUIEndpoint.name
    println "Location: " + WebUIEndpoint.location
    println "Protocol: " + WebUIEndpoint.protocol
    println "Port: " + WebUIEndpoint.port
    sparkWebUI = WebUIEndpoint.name.toLowerCase() + "://" + WebUIEndpoint.location + ":" + WebUIEndpoint.port
    resMap.put("SPARK_WEB_ENDPOINT",sparkWebUI)
    
    schedulerapi.connect()
	schedulerapi.addExternalEndpointUrl(variables.get("PA_JOB_ID"), "Spark Web UI", sparkWebUI , "/automation-dashboard/styles/patterns/img/wf-icons/spark.png")
    
    println "_____________________SSH ENDPOINT________________"
    println SSHEndpoint
    println "Name: " + SSHEndpoint.name
    println "Location: " + SSHEndpoint.location
    println "Protocol: " + SSHEndpoint.protocol
    println "Port: " + SSHEndpoint.port
    resMap.put("SPARK_SSH_Host", SSHEndpoint.location)
    resMap.put("SPARK_SSH_Port", SSHEndpoint.port)
    
    println "_____________________HEAD NODE TOKEN________________"
    resMap.put("SPARK_HEAD_NODE_TOKEN",variables.get("CLUSTER_NAME")+"-hn")
    resMap.put("SPARK_WORKER_NODE_TOKEN",variables.get("CLUSTER_NAME")+"-wn")
    
    resultMap.putAll(resMap)
}
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            850.9658737182617
        </positionTop>
        <positionLeft>
            514.8010864257812
        </positionLeft>
      </metadata>
    </task>
    <task name="get_input_parameters" preciousResult="true"
    fork="true">
      <description>
        <![CDATA[ The simplest task, ran by a Groovy engine. ]]>
      </description>
      <depends>
        <task ref="hdinsight_get_spark_cluster_info"/>
      </depends>
      <inputFiles>
        <files  includes="${ARM_TEMPLATE}" accessMode="transferFromGlobalSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
import javax.ws.rs.core.MediaType

def jsonSlurper = new JsonSlurper()
def jsonData = jsonSlurper.parseText('{"Main_Parameters": {},"Advanced_Parameters": {},"Hidden_Parameters": {}}')

// Add main variables
jsonData.Main_Parameters.put("SUBSCRIPTION_ID",variables.get("SUBSCRIPTION_ID"))
jsonData.Main_Parameters.put("CLUSTER_NAME",variables.get("CLUSTER_NAME"))
jsonData.Main_Parameters.put("AUTOSCALING",variables.get("AUTOSCALING"))
if (variables.get("AUTOSCALING").toLowerCase()=="true"){
    jsonData.Main_Parameters.put("MIN_WORKERS",variables.get("MIN_WORKERS"))
    jsonData.Main_Parameters.put("MAX_WORKERS",variables.get("MAX_WORKERS"))
} else {
    jsonData.Main_Parameters.put("NUMBER_OF_WORKERS",variables.get("NUMBER_OF_WORKERS"))
}
jsonData.Main_Parameters.put("PROACTIVE_NODE_CREDENTIALS",variables.get("PROACTIVE_NODE_CREDENTIALS"))

// Add advanced variables
jsonData.Advanced_Parameters.put("TENANT_ID",variables.get("TENANT_ID"))
jsonData.Advanced_Parameters.put("APP_ID",variables.get("APP_ID"))
jsonData.Advanced_Parameters.put("PASSWORD","******")
jsonData.Advanced_Parameters.put("ARM_TEMPLATE",variables.get("ARM_TEMPLATE"))
jsonData.Advanced_Parameters.put("RESOURCE_GROUP_LOCATION",variables.get("RESOURCE_GROUP_LOCATION"))
jsonData.Advanced_Parameters.put("CLUSTER_USER",variables.get("CLUSTER_USER"))
jsonData.Advanced_Parameters.put("CLUSTER_PASSWORD","******")
jsonData.Advanced_Parameters.put("CLUSTER_SSH_USER",variables.get("CLUSTER_SSH_USER"))
jsonData.Advanced_Parameters.put("CLUSTER_SSH_PASSWORD","******")
jsonData.Advanced_Parameters.put("HEAD_NODE_VM_SIZE",variables.get("HEAD_NODE_VM_SIZE"))
jsonData.Advanced_Parameters.put("WORKER_NODE_VM_SIZE",variables.get("WORKER_NODE_VM_SIZE"))
jsonData.Advanced_Parameters.put("AUTOSCALING_MODE",variables.get("AUTOSCALING_MODE"))
jsonData.Advanced_Parameters.put("SCRIPT_ACTION",variables.get("SCRIPT_ACTION"))
if (variables.get("SCRIPT_ACTION").toLowerCase()=="true"){    
    jsonData.Advanced_Parameters.put("HEAD_NODE_SCRIPTS_JSON",variables.get("HEAD_NODE_SCRIPTS_JSON"))
    jsonData.Advanced_Parameters.put("WORKER_NODE_SCRIPTS_JSON",variables.get("WORKER_NODE_SCRIPTS_JSON"))
}
jsonData.Main_Parameters.put("PROACTIVE_NODE_SOURCE_NAME",variables.get("PROACTIVE_NODE_SOURCE_NAME"))

// Add hidden variables
jsonData.Hidden_Parameters.put("AUTHENTICATION_ENDPOINT",variables.get("AUTHENTICATION_ENDPOINT"))
jsonData.Hidden_Parameters.put("MANAGEMENT_ENDPOINT",variables.get("MANAGEMENT_ENDPOINT"))
jsonData.Hidden_Parameters.put("RESOURCE_GROUP_NAME",variables.get("RESOURCE_GROUP_NAME"))
jsonData.Hidden_Parameters.put("DEPLOYMENT_NAME",variables.get("DEPLOYMENT_NAME"))
jsonData.Hidden_Parameters.put("HEAD_NODE_SCRIPT_NAME",variables.get("HEAD_NODE_SCRIPT_NAME"))
jsonData.Hidden_Parameters.put("HEAD_NODE_SCRIPT_URI",variables.get("HEAD_NODE_SCRIPT_URI"))
jsonData.Hidden_Parameters.put("WORKER_NODE_SCRIPT_NAME",variables.get("WORKER_NODE_SCRIPT_NAME"))
jsonData.Hidden_Parameters.put("WORKER_NODE_SCRIPT_URI",variables.get("WORKER_NODE_SCRIPT_URI"))
jsonData.Hidden_Parameters.put("NUMBER_OF_PROACTIVE_NODES",variables.get("NUMBER_OF_PROACTIVE_NODES"))
jsonData.Hidden_Parameters.put("SCALE_WORKFLOW",variables.get("SCALE_WORKFLOW"))
jsonData.Hidden_Parameters.put("DELETE_WORKFLOW",variables.get("DELETE_WORKFLOW"))


// Generate JSON file
def jsonFile = new File("Azure_HDInsight_Spark_Cluster_Parameters.json")
jsonFile.write(JsonOutput.prettyPrint(JsonOutput.toJson(jsonData)))

result = jsonFile.bytes
resultMetadata.put("file.name", "Azure_HDInsight_Spark_Cluster_Parameters.json")
resultMetadata.put("content.type", MediaType.APPLICATION_JSON.toString())
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.scheduler.common.job.JobVariable

// Initiate workflow signals
def signals = ['Delete_Cluster']

if (variables.get("AUTOSCALING").toLowerCase()=="false"){
   signals.add("Scale_Nodes") 
}

signalapi.readyForSignal("Delete_Cluster")

if (signals.contains("Scale_Nodes")){
    List <JobVariable> scaleVariables = new java.util.ArrayList<JobVariable>()
    scaleVariables.add(new JobVariable("SCALING_OPERATION", "Scale_UP", "PA:LIST(Scale_UP,Scale_DOWN)", "Type of the scaling operation (up or down)", "Scaling parameters", false, false))
    scaleVariables.add(new JobVariable("NUMBER_OF_WORKERS", "1" , "PA:Integer", "Number of workers concerned by the scale operation", "Scaling parameters", false, false))

    signalapi.readyForSignal("Scale_Nodes", scaleVariables)    
}

variables.put("SIGNALS",signals)


// Force regenerating a new Azure Access Token to check the Spark sluster state regularly
variables.put("GENERATE_NEW_TOKEN","true")
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            977.9971160888672
        </positionTop>
        <positionLeft>
            514.8153076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="wait_for_signals" fork="true">
      <description>
        <![CDATA[ A template task that sends a ready notification for all the signals specified in the variable SIGNALS, then loops until one signal among those specified is received by the job. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/signal-wait.png"/>
        <info name="TASK.DOCUMENTATION" value="user/ProActiveUserGuide.html#_task_signal_api"/>
      </genericInformation>
      <depends>
        <task ref="get_input_parameters"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
signals = variables.get("SIGNALS")

receivedSignals = signalapi.checkForSignals(signals.toSet())
println(receivedSignals)

if (receivedSignals.containsKey("Delete_Cluster")) {
    variables.put("SIGNAL_ACTION","DELETE_CLUSTER")
    println("Deleting Spark cluster ...")
} else if (receivedSignals.containsKey("Scale_Nodes")){
    scalingOperation = receivedSignals.get("Scale_Nodes").get("SCALING_OPERATION")
    numberOfWorkers = receivedSignals.get("Scale_Nodes").get("NUMBER_OF_WORKERS")
    variables.put("SIGNAL_ACTION","SCALE_NODES")
    variables.put("SCALING_OPERATION",scalingOperation)
    variables.put("NUMBER_OF_WORKERS",numberOfWorkers)
    
    println(scalingOperation+ " the cluster nodes to "+numberOfWorkers)
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"></controlFlow>
      <metadata>
        <positionTop>
            1102.98291015625
        </positionTop>
        <positionLeft>
            515.8096313476562
        </positionLeft>
      </metadata>
    </task>
    <task name="submit_job_and_wait" fork="true">
      <description>
        <![CDATA[ Submit a workflow referenced in the ProActive Catalog (or accessible by url) and wait for its termination by checking every minute if the job is terminated. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_submit_job_and_wait.png"/>
        <info name="task.documentation" value="user/ProActiveUserGuide.html#_chaining_workflows_submit_a_workflow_from_another_workflow"/>
      </genericInformation>
      <depends>
        <task ref="wait_for_signals"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
def action = variables.get("SIGNAL_ACTION")
def called_workflow = null
def workflow_variables = new HashMap<>(); 

if ( action == "SCALE_NODES" || action == "DELETE_CLUSTER") {    
    workflow_variables.put("SUBSCRIPTION_ID",variables.get("SUBSCRIPTION_ID"))
    workflow_variables.put("TENANT_ID",variables.get("TENANT_ID"))
    workflow_variables.put("APP_ID",variables.get("APP_ID"))
    workflow_variables.put("PASSWORD",variables.get("PASSWORD"))
    workflow_variables.put("AUTHENTICATION_ENDPOINT",variables.get("AUTHENTICATION_ENDPOINT"))
    workflow_variables.put("MANAGEMENT_ENDPOINT",variables.get("MANAGEMENT_ENDPOINT"))
    workflow_variables.put("RESOURCE_GROUP_NAME",variables.get("RESOURCE_GROUP_NAME"))
    workflow_variables.put("CLUSTER_NAME",variables.get("CLUSTER_NAME"))
    
    if (action == "SCALE_NODES"){
        called_workflow = variables.get("SCALE_WORKFLOW")       
        workflow_variables.put("SCALING_OPERATION",variables.get("SCALING_OPERATION"))
        workflow_variables.put("NUMBER_OF_WORKERS",variables.get("NUMBER_OF_WORKERS"))
    } else {
        called_workflow = variables.get("DELETE_WORKFLOW")
        workflow_variables.put("DEPLOYMENT_NAME",variables.get("DEPLOYMENT_NAME"))
        workflow_variables.put("PROACTIVE_NODE_SOURCE_NAME", variables.get("PROACTIVE_NODE_SOURCE_NAME"))
    }
    
    // connect to the scheduler
    schedulerapi.connect()
    def jobid
    if( !variables.get("jobSubmitted") ){

        println "Submitting workflow " + called_workflow

        // submitting the job
        def generic_infos_map = ["PARENT_JOB_ID" : variables.get("PA_JOB_ID")]
        jobid = schedulerapi.submitFromCatalog(variables.get("PA_CATALOG_REST_URL"), called_workflow, workflow_variables, generic_infos_map)
        variables.put("jobSubmitted", true)

        println "Job submitted with job id " + jobid
        variables.put("jobID", jobid)
    }

    if( jobid == null ){
        jobid = variables.get("jobID")
    }
    isFinished = schedulerapi.isJobFinished(jobid)

    variables.put("isFinished", isFinished)

    result = jobid
} else {
     variables.put("isFinished", true)
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow >
        <loop target="submit_job_and_wait">
          <script>
            <code language="javascript">
              <![CDATA[
// You can use a Cron Expression here
              // examples http://www.sauronsoftware.it/projects/cron4j/manual.php#p02
if(!variables.get("isFinished")){
	loop = '* * * * *';
}else{
    variables.put("jobSubmitted", false);
	loop = false;
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            1227.0027770996094
        </positionTop>
        <positionLeft>
            410.553955078125
        </positionLeft>
      </metadata>
    </task>
    <task name="end_loop" fork="true">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png"/>
      </genericInformation>
      <depends>
        <task ref="check_spark_cluster_state"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.scheduler.common.job.JobVariable


if (variables.get("SIGNAL_ACTION") == "SCALE_NODES"){
    signalapi.removeSignal("Scale_Nodes")
    
    List <JobVariable> scaleVariables = new java.util.ArrayList<JobVariable>()
    
    scaleVariables.add(new JobVariable("SCALING_OPERATION", "Scale_UP", "PA:LIST(Scale_UP,Scale_DOWN)", "Type of the scaling operation (up or down)", "Scaling parameters", false, false))
    scaleVariables.add(new JobVariable("NUMBER_OF_WORKERS", "1" , "PA:Integer", "Number of workers concerned by the scale operation", "Scaling parameters", false, false))
    
    signalapi.readyForSignal("Scale_Nodes", scaleVariables)    
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow  block="end">
        <loop target="wait_for_signals">
          <script>
            <code language="groovy">
              <![CDATA[
signalAction=variables.get("SIGNAL_ACTION")

if (signalAction=="DELETE_CLUSTER"){
    loop = false
} else {
    loop = "* * * * *"
}
variables.put("SIGNAL_ACTION","")
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            1538.0112915039062
        </positionTop>
        <positionLeft>
            543.7926025390625
        </positionLeft>
      </metadata>
    </task>
    <task name="prepare_pa_node_params" maxNumberOfExecution="1" onTaskError="suspendTask" fork="true">
      <description>
        <![CDATA[ A task performing a rest POST request using form data.

This template supports only basic authentication, for more advanced authentication settings, please modify the template according to the rest-assured documentation:
https://github.com/rest-assured/rest-assured/wiki/Usage#authentication

It accepts the following parameters:
ENDPOINT: base url of the request (inherited from job variable)
USER: basic auth user (if required, inherited from job variable)
PASSWORD: basic auth password (if required, inherited from job variable)
PATH: path of the request (relative to the base url)
SSL_DISABLE_CHECK: to disable ssl certificate check
DEBUG: to print the full request and response content in the task output
RESPONSE_FORMAT: format of the response, either
  - string : plain text
  - json: a json response which will be parsed using RESPONSE_PATH
  - xml: a xml response which will be parsed using RESPONSE_PATH
  - html: an html response which will be parsed using RESPONSE_PATH
  - contentView: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)
RESPONSE_PATH: which data to extract in the response if json, xml or html format is selected. It uses the GPath notation (https://groovy-lang.org/processing-xml.html)

Header, form or query parameters can also be added dynamically, by adding variables in the format:
HEADER_<header_name>
PARAM_<param_name>
QUERY_PARAM_<param_name> ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${PA_SCHEDULER_REST_URL}" inherited="false"    advanced="false" hidden="false" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/scheduler/createcredential/" inherited="false"    advanced="false" hidden="false" description="Path of the request (relative to the base url)"/>
        <variable name="CONTENT_TYPE" value="multipart/form-data" inherited="false" model="PA:LIST(application/x-www-form-urlencoded,multipart/form-data)"   advanced="false" hidden="false" description="Content-Type of the request"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean"   advanced="false" hidden="false" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="string" inherited="false" model="PA:LIST(string,json,xml,html,contentView)"   advanced="false" hidden="false" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="" inherited="false"    advanced="false" hidden="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
        <variable name="PARAM_username" value="${PA_USER}" inherited="false"  description="ProActive login name"  advanced="false" hidden="false"/>
        <variable name="PARAM_password" value="${PROACTIVE_PASSWORD}" inherited="false"  description="ProActive login password"  advanced="false" hidden="false"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/api-rest.png"/>
      </genericInformation>
      <depends>
        <task ref="azure_authenticate"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
        <files  includes="${JSON_INPUT_FILE}" accessMode="transferFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*

// Configure workflow parameters when using JSON file as iput 
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    
    jsonFile = new File(variables.get("JSON_INPUT_FILE"))

    def jsonSlurper = new JsonSlurper()
    jsonData = jsonSlurper.parse(jsonFile)

    println "The workflow will use the following parameters:"
    
    // Process main parameters
    mainParameters = jsonData.Main_Parameters 
    mainParameters.keySet().each{key->        
        variables.put(key,mainParameters.get(key))
        println key +": "+ variables.get(key)
	}
    
    // Process advanced parameters
    advancedParameters = jsonData.Advanced_Parameters 
    advancedParameters.keySet().each{key->        
        variables.put(key,advancedParameters.get(key))
        println key +": "+ variables.get(key)
	}
    
    // Process hidden parameters
    hiddenParameters = jsonData.Hidden_Parameters 
    hiddenParameters.keySet().each{key->        
        variables.put(key,hiddenParameters.get(key))
        println key +": "+ variables.get(key)
	}
}

// Prepare the NodeSource for ProActive Nodes that will be deployed in Spark cluster
def nodeSourceName = variables.get("PROACTIVE_NODE_SOURCE_NAME")

try{
    rmapi.connect()
    def nsMap = rmapi.getExistingNodeSources()
    def ns = nsMap.find{ it.key == nodeSourceName }

    if(ns){
        println "NodeSource '${nodeSourceName}' already exists, thus the operation of NodeSource creation will be skipped."
    } else { 
        // NS configuration settings
        def infrastructureType = "org.ow2.proactive.resourcemanager.nodesource.infrastructure.DefaultInfrastructureManager"
        def infrastructureParameters = [""]
        def infrastructureFileParameters = [""]
        def policyType = "org.ow2.proactive.resourcemanager.nodesource.policy.EmptyPolicy"
        def poliyParameters = ["ALL","ME"]
        def policyFileParameters = []
        def nodesRecoverable = "true"

        // Create and deploy NS
        print "Creating the NodeSource '${nodeSourceName}' ..."
        rmapi.defineNodeSource(nodeSourceName,infrastructureType,(String[]) infrastructureParameters.toArray(),(String[]) infrastructureFileParameters.toArray(), policyType,         (String[]) poliyParameters.toArray(), (String[]) policyFileParameters.toArray(),nodesRecoverable)
        println " OK !"
        print "Deploying the NodeSource '${nodeSourceName}' ..."
        rmapi.deployNodeSource(nodeSourceName)
        println " OK !"
    }
} catch(Exception e){
	throw e
} finally {
	rmapi.disconnect()  
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))
contentType = variables.get("CONTENT_TYPE")
isMultiPart = contentType.equals("multipart/form-data")

restCall = given().contentType(contentType + ";charset = UTF-8")

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("PARAM_")}).forEach({entry -> restCall = (isMultiPart ? restCall.multiPart(entry.getKey().replace("PARAM_",""), entry.getValue()) : restCall.formParam(entry.getKey().replace("PARAM_",""), entry.getValue()) )});

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}

response = restCall.post(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
def restUrl = variables.get("PA_SCHEDULER_REST_URL")
def nodeJarUrl = restUrl+"/node.jar"
def host = new URL(restUrl).getHost() 
def protocol = variables.get("PA_NODE_URL").substring(0, restUrl.lastIndexOf("//")-2)
def nsName = variables.get("PROACTIVE_NODE_SOURCE_NAME")

def get = new URL(restUrl +"/rm/url/").openConnection();
def getRC = get.getResponseCode();
if (getRC.equals(200)) {
    rmURL = get.getInputStream().getText()
    println("rmUrl: "+rmURL);
} else {
   throw new RuntimeException("Cannot acquire The RM URL.") 
}

println "nodeJarUrl: "+nodeJarUrl
println "rmHostname: "+host
println "protocol: "+protocol
println "nsName: "+nsName
println "nodeNamingOption: "+variables.get("CLUSTER_NAME")
println "credentials: "+result
println "numberOfNodesPerInstance: "+ 1
println "additionalProperties: "+ "-Dproactive.useIPaddress=true"

def headNodeScriptParameters = restUrl + " " + protocol + " " + host + " " + rmURL + " " + nsName + " " + variables.get("CLUSTER_NAME")+"-hn " + result + " " + variables.get("NUMBER_OF_PROACTIVE_NODES") + " -Dproactive.useIPaddress=true "+ variables.get("PROACTIVE_SESSION_ID")
//println headNodeScriptParameters
variables.put ("HEAD_NODE_SCRIPT_PARAMETERS",headNodeScriptParameters)

def workerNodeScriptParameters = restUrl + " " + protocol + " " + host + " " + rmURL + " " + nsName + " " + variables.get("CLUSTER_NAME")+"-wn " + result + " " + variables.get("NUMBER_OF_PROACTIVE_NODES") + " -Dproactive.useIPaddress=true "+ variables.get("PROACTIVE_SESSION_ID")
//println workerNodeScriptParameters
variables.put ("WORKER_NODE_SCRIPT_PARAMETERS",workerNodeScriptParameters)
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            211.90338134765625
        </positionTop>
        <positionLeft>
            514.8153076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="prepare_arm_template_params" fork="true">
      <depends>
        <task ref="prepare_pa_node_params"/>
      </depends>
      <inputFiles>
        <files  includes="${ARM_TEMPLATE}" accessMode="transferFromGlobalSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
    
jsonFile = new File(variables.get("ARM_TEMPLATE"))

def jsonSlurper = new JsonSlurper()
jsonData = jsonSlurper.parse(jsonFile)

jsonData.properties.template.parameters.clusterName.defaultValue = variables.get("CLUSTER_NAME") 
jsonData.properties.template.parameters.clusterLoginUserName.defaultValue =  variables.get("CLUSTER_USER")
jsonData.properties.template.parameters.clusterLoginPassword.defaultValue = variables.get("CLUSTER_PASSWORD")
jsonData.properties.template.parameters.sshUserName.defaultValue = variables.get("CLUSTER_SSH_USER")
jsonData.properties.template.parameters.sshPassword.defaultValue= variables.get("CLUSTER_SSH_PASSWORD")

jsonData.properties.template.parameters.HeadNodeVirtualMachineSize.defaultValue = variables.get("HEAD_NODE_VM_SIZE") 
jsonData.properties.template.parameters.WorkerNodeVirtualMachineSize.defaultValue = variables.get("WORKER_NODE_VM_SIZE") 

jsonData.properties.template.resources[1].properties.computeProfile.roles[1].targetInstanceCount = variables.get("NUMBER_OF_WORKERS")

if (variables.get("AUTOSCALING").toLowerCase()=="true"){
	def autoScaleContent = new JsonSlurper().parseText('{ "capacity": { "minInstanceCount": '+variables.get("MIN_WORKERS")+', "maxInstanceCount": '+variables.get("MAX_WORKERS")+' }},')
    jsonData.properties.template.resources[1].properties.computeProfile.roles[1].put("autoscale",autoScaleContent)
}

def headNodeScriptActionDefaultContent = new JsonSlurper().parseText('[{"name": "'+variables.get("HEAD_NODE_SCRIPT_NAME")+'", "uri": "'+variables.get("HEAD_NODE_SCRIPT_URI")+'", "parameters": "'+variables.get("HEAD_NODE_SCRIPT_PARAMETERS")+'"}]')

def workerNodeScriptActionDefaultContent = new JsonSlurper().parseText('[{"name": "'+variables.get("WORKER_NODE_SCRIPT_NAME")+'", "uri": "'+variables.get("WORKER_NODE_SCRIPT_URI")+'", "parameters": "'+variables.get("WORKER_NODE_SCRIPT_PARAMETERS")+'"}]')

if (variables.get("SCRIPT_ACTION").toLowerCase()=="true"){    
    def headNodeScriptActionContent = new JsonSlurper().parseText(variables.get("HEAD_NODE_SCRIPTS_JSON"))
    assert headNodeScriptActionContent instanceof List    
    headNodeScriptActionContent.each {
        assert !it.name.isEmpty() && !it.uri.isEmpty()
        headNodeScriptActionDefaultContent.add(it)
    }
    
    def workerNodeScriptActionContent = new JsonSlurper().parseText(variables.get("WORKER_NODE_SCRIPTS_JSON"))
    assert workerNodeScriptActionContent instanceof List    
    workerNodeScriptActionContent.each {
        assert !it.name.isEmpty() && !it.uri.isEmpty()
    	workerNodeScriptActionDefaultContent.add(it)
	}
}

jsonData.properties.template.resources[1].properties.computeProfile.roles[0].scriptActions = headNodeScriptActionDefaultContent
jsonData.properties.template.resources[1].properties.computeProfile.roles[1].scriptActions = workerNodeScriptActionDefaultContent

def modifiedJson = JsonOutput.prettyPrint(JsonOutput.toJson(jsonData))

//jsonFile.write(modifiedJson)
variables.put("ARM_TEMPLATE_CONTENT",modifiedJson)

println modifiedJson
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            338.92041015625
        </positionTop>
        <positionLeft>
            516.803955078125
        </positionLeft>
      </metadata>
    </task>
    <task name="azure_generate_new_access_token" fork="true">
      <description>
        <![CDATA[ A task performing a POST request to Azure REST API in order to authenticate to Azure and acquire an authentication token. ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${AUTHENTICATION_ENDPOINT}" inherited="false" model="PA:URL" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/${TENANT_ID}/oauth2/token" inherited="false" description="Path of the request (relative to the base url)"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="CONTENT_TYPE" value="application/x-www-form-urlencoded" inherited="false" description="Content-Type of the request"/>
        <variable name="REQUEST_BODY" value="&amp;grant_type=client_credentials&amp;client_id=${APP_ID}&amp;client_secret=%PASSWORD%&amp;resource=https%3A%2F%2Fmanagement.azure.com%2F" inherited="false" description="A JSON parameter containing the request body."/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="." inherited="false"    advanced="false" hidden="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/azure_icon.png"/>
      </genericInformation>
      <depends>
        <task ref="submit_job_and_wait"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
currentDate = System.currentTimeMillis()/1000
//println currentDate

if (Long.valueOf(variables.get("EXPIRES_ON")) > currentDate + 300) {
     println "access token is still valid"
     variables.put("GENERATE_NEW_TOKEN", "false")
} else {
      println "access token will expire soon"
      variables.put("GENERATE_NEW_TOKEN", "true")
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

def action = variables.get("SIGNAL_ACTION")
   
if (variables.get("GENERATE_NEW_TOKEN") == "true" && action != "DELETE_CLUSTER"){
    
    debug = Boolean.parseBoolean(variables.get("DEBUG"))

    restCall = given().contentType(variables.get("CONTENT_TYPE"))

    if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
        restCall = restCall.relaxedHTTPSValidation()
    }

    if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
        restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
    }

    variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

    variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

    if (variables.get("REQUEST_BODY") != null && !variables.get("REQUEST_BODY").isEmpty()) {
        restCall = restCall.body(variables.get("REQUEST_BODY").replace("%PASSWORD%",variables.get("PASSWORD")))
    }

    if (debug) {
        println "-------------- REQUEST -----------------"
        restCall = restCall.log().all()
    }
    response = restCall.post(variables.get("ENDPOINT") + variables.get("PATH"))

    if (debug) {
        println "-------------- RESPONSE -----------------"
        println response.statusLine()
        println response.prettyPrint()
    } else {
        println response.statusLine()
    }

    response = response.then().assertThat()
      .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
      .extract();

    if (debug) {
        println "-------------- RESULT -------------------"
    }

    if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
    } else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
        result = true;
        // response has no content
        return;
    }

    switch (variables.get("RESPONSE_FORMAT")) {
        case "json":
        if (variables.get("RESPONSE_PATH").isEmpty()) {
            throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
        }
        result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
        println result
        break;

        case "xml":
        if (variables.get("RESPONSE_PATH").isEmpty()) {
            throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
        }
        // html parsing results are not serializable and thus can be returned only in string format
        result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
        println result
        break;

        case "html":
        if (variables.get("RESPONSE_PATH").isEmpty()) {
            throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
        }
        // html parsing results are not serializable and thus can be returned only in string format
        result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
        println result
        break;

        case "contentView":
        result = response.asByteArray();
        resultMetadata.put("content.type", response.contentType())
        // uncomment the following line to allow saving the result as a file on the scheduler portal
        // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
        // resultMetadata.put("file.extension",".png")
        println "See result in \"Task Preview\" tab with content " + response.contentType()
        break;

        case "string":
        result = response.prettyPrint()
        break;
    }
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
    
if (variables.get("GENERATE_NEW_TOKEN") == "true"){
    
    def slurper = new JsonSlurper()

    jsonData = slurper.parseText(JsonOutput.toJson(result))

    access_token=jsonData.access_token
    variables.put("ACCESS_TOKEN",access_token)
    println variables.get("ACCESS_TOKEN")

    expires_on=jsonData.expires_on
    variables.put("EXPIRES_ON",expires_on)
    println variables.get("EXPIRES_ON")
}
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            1323.7925720214844
        </positionTop>
        <positionLeft>
            372.64202880859375
        </positionLeft>
      </metadata>
    </task>
    <task name="check_spark_cluster_state" maxNumberOfExecution="3" fork="true">
      <description>
        <![CDATA[ A task that performs iteratively a GET request to Azure HDInsight REST API, in order to get information about the cluster deployment status. If the deployment status is "Succeeded". The cluster Web UI, SSH host and SSH port are extracted and provided as job results, then the loop stops. 
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL" description="Base URL of the server or service that will be queried."/>
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.HDInsight/clusters/${CLUSTER_NAME}?api-version=2018-06-01-preview" inherited="false" description="Path of the request (relative to the base url)"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean" description="If true, disable SSL certificate verification"/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean" description="If true, print the full request and response content in the task output."/>
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)" description="Format of the response, either: &lt;ul style=&quot;color:red;&quot;&gt;   &lt;li&gt;&lt;b&gt;string&lt;/b&gt;: plain text&lt;/li&gt;   &lt;li&gt;&lt;b&gt;json&lt;/b&gt;: a json response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;xml&lt;/b&gt;: a xml response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;html&lt;/b&gt;&lt;/li&gt;: an html response which will be parsed using &lt;i&gt;RESPONSE_PATH&lt;/i&gt;&lt;/li&gt;   &lt;li&gt;&lt;b&gt;contentView&lt;/b&gt;: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)&lt;/li&gt; &lt;/ul&gt;"/>
        <variable name="RESPONSE_PATH" value="." inherited="false" description="Which data to extract in the response if json, xml or html format is selected. It uses the &lt;a href=&quot;https://groovy-lang.org/processing-xml.html&quot; target=&quot;_blank&quot;&gt;GPath notation&lt;/a&gt;" group="Http Response"/>
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false" description="HTTP Authorization request header that contains the credentials to authenticate the user to the server"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
      </genericInformation>
      <depends>
        <task ref="azure_generate_new_access_token"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    CLUSTER_NAME=variables.get("CLUSTER_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.HDInsight/clusters/${CLUSTER_NAME}?api-version=2018-06-01-preview"
    variables.put("PATH", PATH)
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import com.google.common.base.Strings;

def action = variables.get("SIGNAL_ACTION")
   
if (action != "DELETE_CLUSTER"){
    debug = Boolean.parseBoolean(variables.get("DEBUG"))

    restCall = given()

    if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
        restCall = restCall.relaxedHTTPSValidation()
    }

    if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
        restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
    }

    variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

    variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("PARAM_")}).forEach({entry -> restCall = restCall.param(entry.getKey().replace("PARAM_",""), entry.getValue()) });

    if (debug) {
        println "-------------- REQUEST ------------------"
        restCall = restCall.log().all()
    }

    response = restCall.get(variables.get("ENDPOINT") + variables.get("PATH"))

    if (debug) {
        println "-------------- RESPONSE -----------------"
        println response.statusLine()
        println response.prettyPrint()
    } else {
        println response.statusLine()
    }

    response = response.then().assertThat()
      .statusCode(HttpStatus.SC_OK)
      .extract();

    if (debug) {
        println "-------------- RESULT -------------------"
    }

    switch (variables.get("RESPONSE_FORMAT")) {
        case "json":
        if (variables.get("RESPONSE_PATH").isEmpty()) {
            throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
        }
        result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
        println result
        break;

        case "xml":
        if (variables.get("RESPONSE_PATH").isEmpty()) {
            throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
        }
        // html parsing results are not serializable and thus can be returned only in string format
        result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
        println result
        break;

        case "html":
        if (variables.get("RESPONSE_PATH").isEmpty()) {
            throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
        }
        // html parsing results are not serializable and thus can be returned only in string format
        result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
        println result
        break;

        case "contentView":
        result = response.asByteArray();
        resultMetadata.put("content.type", response.contentType())
        // uncomment the following line to allow saving the result as a file on the scheduler portal
        // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
        // resultMetadata.put("file.extension",".png")
        println "See result in \"Task Preview\" tab with content " + response.contentType()
        break;

        case "string":
        result = response.prettyPrint()
        break;
    }
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*

def action = variables.get("SIGNAL_ACTION")
   
if (action != "DELETE_CLUSTER"){
    def slurper = new JsonSlurper()

    jsonData = slurper.parseText(JsonOutput.toJson(result))

    int nbOfWorkers=jsonData.properties.computeProfile.roles[1].targetInstanceCount as int
    println nbOfWorkers
    resultMap.put("SPARK_NUMBER_OF_WORKERS",nbOfWorkers)

    clusterState=jsonData.properties.clusterState
    if ((clusterState=="Deleting") || (clusterState=="DeletePending")) {
        variables.put("SIGNAL_ACTION","DELETE_CLUSTER")
    }
}
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            1431.0936889648438
        </positionTop>
        <positionLeft>
            405.69598388671875
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2485px;
            height:2788px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-75.866455078125px;left:-367.64202880859375px"><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3142" style="top: 593.963px; left: 514.829px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a PUT request to Azure HDInsight REST API in order to deploy a Spark cluster, which name is given as input.
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/spark.png" width="20px">&nbsp;<span class="name">hdinsight_deploy_spark</span></a></div><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" id="jsPlumb_1_3145" style="top: 80.8803px; left: 513.821px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a POST request to Azure REST API in order to authenticate to Azure and acquire an authentication token."><img src="/automation-dashboard/styles/patterns/img/wf-icons/azure_icon.png" width="20px">&nbsp;<span class="name">azure_authenticate</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3148" style="top: 721.974px; left: 514.829px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a Get request to Azure HDInsight REST API in order to  check the status of the deployment, which name is given as input.
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/spark.png" width="20px">&nbsp;<span class="name">hdinsight_check_deployment</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3151" style="top: 468.948px; left: 514.815px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a PUT request to Azure HDInsight REST API in order to create a Resource Group, which name is given as input.
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/hdinsight.png" width="20px">&nbsp;<span class="name">azure-create_resource_group</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3154" style="top: 850.98px; left: 514.815px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task that performs iteratively a GET request to Azure HDInsight REST API, in order to get information about the cluster deployment status. If the deployment status is &quot;Succeeded&quot;. The cluster Web UI, SSH host and SSH port are extracted and provided as job results, then the loop stops. 
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/spark.png" width="20px">&nbsp;<span class="name">hdinsight_get_spark_cluster_info</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3157" style="top: 978.011px; left: 514.829px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="The simplest task, ran by a Groovy engine."><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">get_input_parameters</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3160" style="top: 1103px; left: 515.824px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A template task that sends a ready notification for all the signals specified in the variable SIGNALS, then loops until one signal among those specified is received by the job."><img src="/automation-dashboard/styles/patterns/img/wf-icons/signal-wait.png" width="20px">&nbsp;<span class="name">wait_for_signals</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3163" style="top: 1227.02px; left: 410.568px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Submit a workflow referenced in the ProActive Catalog (or accessible by url) and wait for its termination by checking every minute if the job is terminated."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_submit_job_and_wait.png" width="20px">&nbsp;<span class="name">submit_job_and_wait</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3166" style="top: 1538.03px; left: 543.806px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png" width="20px">&nbsp;<span class="name">end_loop</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3169" style="top: 211.917px; left: 514.829px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a rest POST request using form data.

This template supports only basic authentication, for more advanced authentication settings, please modify the template according to the rest-assured documentation:
https://github.com/rest-assured/rest-assured/wiki/Usage#authentication

It accepts the following parameters:
ENDPOINT: base url of the request (inherited from job variable)
USER: basic auth user (if required, inherited from job variable)
PASSWORD: basic auth password (if required, inherited from job variable)
PATH: path of the request (relative to the base url)
SSL_DISABLE_CHECK: to disable ssl certificate check
DEBUG: to print the full request and response content in the task output
RESPONSE_FORMAT: format of the response, either
  - string : plain text
  - json: a json response which will be parsed using RESPONSE_PATH
  - xml: a xml response which will be parsed using RESPONSE_PATH
  - html: an html response which will be parsed using RESPONSE_PATH
  - contentView: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)
RESPONSE_PATH: which data to extract in the response if json, xml or html format is selected. It uses the GPath notation (https://groovy-lang.org/processing-xml.html)

Header, form or query parameters can also be added dynamically, by adding variables in the format:
HEADER_<header_name>
PARAM_<param_name>
QUERY_PARAM_<param_name>"><img src="/automation-dashboard/styles/patterns/img/wf-icons/api-rest.png" width="20px">&nbsp;<span class="name">prepare_pa_node_params</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3172" style="top: 338.934px; left: 516.818px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">prepare_arm_template_params</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_3175" style="top: 1323.81px; left: 372.656px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a POST request to Azure REST API in order to authenticate to Azure and acquire an authentication token."><img src="/automation-dashboard/styles/patterns/img/wf-icons/azure_icon.png" width="20px">&nbsp;<span class="name">azure_generate_new_access_token</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_ active-task" id="jsPlumb_1_3178" style="top: 1431.11px; left: 405.71px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task that performs iteratively a GET request to Azure HDInsight REST API, in order to get information about the cluster deployment status. If the deployment status is &quot;Succeeded&quot;. The cluster Web UI, SSH host and SSH port are extracted and provided as job results, then the loop stops. 
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/spark.png" width="20px">&nbsp;<span class="name">check_spark_cluster_state</span></a></div><svg style="position:absolute;left:574.5px;top:508.5px" width="34.5" height="86" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 85 C -10 35 23.5 50 13.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7197031250000003,64.02515625000001 L9.273922382226889,45.910515811756405 L1.1822576301796361,50.32922167891662 L-4.422012188856502,43.008555056576775 L-1.7197031250000003,64.02515625000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7197031250000003,64.02515625000001 L9.273922382226889,45.910515811756405 L1.1822576301796361,50.32922167891662 L-4.422012188856502,43.008555056576775 L-1.7197031250000003,64.02515625000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:574.5px;top:633.5px" width="33.5" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 12.5 88 C 22.5 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M14.26472,66.303232 L17.28289408617318,45.32966231848053 L11.569127383829805,52.565190638595936 L3.54485272476912,48.02525493465072 L14.26472,66.303232" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M14.26472,66.303232 L17.28289408617318,45.32966231848053 L11.569127383829805,52.565190638595936 L3.54485272476912,48.02525493465072 L14.26472,66.303232" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:588px;top:378.5px" width="26" height="91" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 90 C -10 40 15 50 5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.40624,68.13216 L6.453652523996815,48.88372358393686 L-1.0823577328620912,54.19489571525754 L-7.483611760745647,47.55984131679896 L-2.40624,68.13216" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.40624,68.13216 L6.453652523996815,48.88372358393686 L-1.0823577328620912,54.19489571525754 L-7.483611760745647,47.55984131679896 L-2.40624,68.13216" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:587px;top:761.5px" width="29" height="90" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 8 89 C 18 39 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M10.149632,67.21769599999999 L14.40690958201079,46.46015309170498 L8.273904868485769,53.343920460223465 L0.5331340422342654,48.335880223219206 L10.149632,67.21769599999999" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M10.149632,67.21769599999999 L14.40690958201079,46.46015309170498 L8.273904868485769,53.343920460223465 L0.5331340422342654,48.335880223219206 L10.149632,67.21769599999999" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:676.0266769263776px;top:800.5px" width="20.473323073622403" height="141" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 40 C -10 90 -10 -50 0 0 " transform="translate(19.973323073622403,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_3198" style="position: absolute; transform: translate(-50%, -50%); left: 688px; top: 870.5px;">loop</div><svg style="position:absolute;left:571px;top:890.5px" width="45" height="88" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 87 C -10 37 34 50 24 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-0.7810560000000011,65.388768 L12.465784120806553,48.8502908387318 L3.870045273990092,52.18394854121573 L-0.7390353379777173,44.19918956474171 L-0.7810560000000011,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-0.7810560000000011,65.388768 L12.465784120806553,48.8502908387318 L3.870045273990092,52.18394854121573 L-0.7390353379777173,44.19918956474171 L-0.7810560000000011,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:558px;top:1017.5px" width="34" height="86" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 85 C -10 35 23 50 13 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7602812500000005,64.02515625000001 L9.115897551165421,45.83975730785194 L1.0529948479862072,50.31073035620119 L-4.598528342633398,43.026481209865736 L-1.7602812500000005,64.02515625000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7602812500000005,64.02515625000001 L9.115897551165421,45.83975730785194 L1.0529948479862072,50.31073035620119 L-4.598528342633398,43.026481209865736 L-1.7602812500000005,64.02515625000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:464.5px;top:1142.5px" width="114.5" height="85" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 84 C -10 34 103.5 50 93.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M9.193078124999996,58.770187500000006 L29.77674871797211,53.739034061670495 L20.931106474834966,51.140070170727114 L22.14663138869922,42.00100571183553 L9.193078124999996,58.770187500000006" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M9.193078124999996,58.770187500000006 L29.77674871797211,53.739034061670495 L20.931106474834966,51.140070170727114 L22.14663138869922,42.00100571183553 L9.193078124999996,58.770187500000006" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:519.0266769263776px;top:1176.5px" width="20.473323073622403" height="141" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 40 C -10 90 -10 -50 0 0 " transform="translate(19.973323073622403,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_3213" style="position: absolute; transform: translate(-50%, -50%); left: 531px; top: 1246.5px;">loop</div><svg style="position:absolute;left:471.5px;top:1470.5px" width="133" height="68" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 112 67 C 122 17 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M99.82002800000001,43.652378 L83.7587181125067,29.830861270714838 L86.78734334973704,38.53875591709242 L78.64509602959913,42.863545920977806 L99.82002800000001,43.652378" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M99.82002800000001,43.652378 L83.7587181125067,29.830861270714838 L86.78734334973704,38.53875591709242 L78.64509602959913,42.863545920977806 L99.82002800000001,43.652378" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:611.5px;top:1142.5px" width="43" height="396" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 0 C -10 50 32 345 22 395 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M1.384625000000001,86.64390625 L9.863675631689404,106.0631158215878 L2.4337377814196612,100.60454242360835 L-4.0969605419189445,107.11222860300747 L1.384625000000001,86.64390625" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M1.384625000000001,86.64390625 L9.863675631689404,106.0631158215878 L2.4337377814196612,100.60454242360835 L-4.0969605419189445,107.11222860300747 L1.384625000000001,86.64390625" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_3222" style="position: absolute; transform: translate(-50%, -50%); left: 632.5px; top: 1340px;">loop</div><svg style="position:absolute;left:563.5px;top:120.5px" width="38.5" height="92" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 17.5 91 C 27.5 41 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M18.774441875,68.56069325 L20.552601163764905,47.44581343637618 L15.274723342971132,55.005178866673425 L6.997086780438329,50.94553196840504 L18.774441875,68.56069325" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M18.774441875,68.56069325 L20.552601163764905,47.44581343637618 L15.274723342971132,55.005178866673425 L6.997086780438329,50.94553196840504 L18.774441875,68.56069325" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:581px;top:251.5px" width="33" height="88" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 12 87 C 22 37 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M13.8414375,65.86284375000001 L17.054215925901396,44.91820112268209 L11.27351541041255,52.100366642233084 L3.291738818134464,47.48612321226955 L13.8414375,65.86284375000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M13.8414375,65.86284375000001 L17.054215925901396,44.91820112268209 L11.27351541041255,52.100366642233084 L3.291738818134464,47.48612321226955 L13.8414375,65.86284375000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:460px;top:1266.5px" width="25.5" height="58" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 57 C -10 7 14.5 50 4.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.267578124999999,42.246093750000014 L6.12814152327761,22.79071167748534 L-1.2783263245294143,28.28108816907504 L-7.836864057647365,21.801459877014757 L-2.267578124999999,42.246093750000014" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.267578124999999,42.246093750000014 L6.12814152327761,22.79071167748534 L-1.2783263245294143,28.28108816907504 L-7.836864057647365,21.801459877014757 L-2.267578124999999,42.246093750000014" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:460px;top:1363.5px" width="32.5" height="68" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 11.5 67 C 21.5 17 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M13.485423375000002,49.97915325000001 L16.549324069514057,29.012214691064987 L10.819793565842549,36.2352666919506 L2.8054375114646515,31.677844500222438 L13.485423375000002,49.97915325000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M13.485423375000002,49.97915325000001 L16.549324069514057,29.012214691064987 L10.819793565842549,36.2352666919506 L2.8054375114646515,31.677844500222438 L13.485423375000002,49.97915325000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 575px; top: 624px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 575px; top: 584px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 564px; top: 111px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 587.5px; top: 752px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 587.5px; top: 712px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 588.5px; top: 499px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 588.5px; top: 459px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 595.5px; top: 881px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 595.5px; top: 841px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 686px; top: 841px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 686px; top: 881px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 571.5px; top: 1008px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 571.5px; top: 968px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 558.5px; top: 1133px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 558.5px; top: 1093px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 612px; top: 1133px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 465px; top: 1257px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 465px; top: 1217px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 529px; top: 1217px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 529px; top: 1257px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 584px; top: 1568px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 584px; top: 1528px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 634px; top: 1528px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 581.5px; top: 242px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 581.5px; top: 202px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 593.5px; top: 369px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 593.5px; top: 329px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 460.5px; top: 1354px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 460.5px; top: 1314px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 472px; top: 1461px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 472px; top: 1421px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>