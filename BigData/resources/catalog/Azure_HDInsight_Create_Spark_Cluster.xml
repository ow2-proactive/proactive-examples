<?xml version="1.0" encoding="UTF-8"?>
<job
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="urn:proactive:jobdescriptor:3.13" xsi:schemaLocation="urn:proactive:jobdescriptor:3.13 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.13/schedulerjob.xsd"  name="Azure_HDInsight_Create_Spark_Cluster" projectName="08. Azure HDInsight Spark Workflows" priority="normal" onTaskError="suspendTask"  maxNumberOfExecution="1"  >
  <variables>
    <variable name="USE_JSON_INPUT_FILE" value="false" model="PA:Boolean" description="A boolean variable indicating whether the input parameters of the workflow are provided in a JSON file placed in the global data space. If not, the workflow will consider the input variables form." group="Input File Parameters" advanced="false" hidden="false"/>
    <variable name="JSON_INPUT_FILE" value=""  description="A JSON file placed in the global data space, which contains all input parameters of the workflow." group="Input File Parameters" advanced="false" hidden="false"/>
    <variable name="JSON_INPUT_FILE_HANDLER" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;true&#39; ?  showVar(&#39;JSON_INPUT_FILE&#39;) &amp;&amp; hideGroup(&#39;Subscription Parameters&#39;) &amp;&amp; hideGroup(&#39;Deployment Parameters&#39;) &amp;&amp; hideGroup(&#39;Spark Cluster Parameters&#39;) &amp;&amp; hideGroup(&#39;Script Action&#39;) &amp;&amp; hideGroup(&#39;ProActive Node Parameters&#39;) &amp;&amp; hideGroup(&#39;Number of Workers&#39;) &amp;&amp;  (models[&#39;JSON_INPUT_FILE&#39;] = &#39;PA:GLOBAL_FILE&#39;) instanceof T(String) : hideVar(&#39;JSON_INPUT_FILE&#39;))" description="A hidden variable that allows to have a dynamic form for input parameters, i.e., variables will appear/disappear dynamically depending on the value of variable &#39;USE_JSON_INPUT_FILE&#39;."  advanced="false" hidden="true"/>
    <variable name="SUBSCRIPTION_ID" value="change-it-and-put-your-azure-subscription-id" model="PA:NOT_EMPTY_STRING" description="The subscription id of your Microsoft Azure account." group="Subscription Parameters" advanced="false" hidden="false"/>
    <variable name="TENANT_ID" value="change-it-and-put-your-azure-tenant-id" model="PA:NOT_EMPTY_STRING" description="The tenant id of your Microsoft Azure account." group="Subscription Parameters" advanced="true" hidden="false"/>
    <variable name="APP_ID" value="change-it-and-put-your-azure-client-application-id" model="PA:NOT_EMPTY_STRING" description="ID of a HDInsights client application." group="Subscription Parameters" advanced="true" hidden="false"/>
    <variable name="PASSWORD" value="ENC(L/ks1WBUEKZZ2K0wm+3i1A==)" model="PA:HIDDEN" description="Secret key needed to access a HDInsights client application." group="Subscription Parameters" advanced="true" hidden="false"/>
    <variable name="AUTHENTICATION_ENDPOINT" value="https://login.microsoftonline.com" model="PA:URL" description="Hidden variable that contains the authentication endpoint of Azure REST API."  advanced="false" hidden="true"/>
    <variable name="MANAGEMENT_ENDPOINT" value="https://management.azure.com" model="PA:URL" description="Hidden variable that contains the REST endpoint for managing Azure HDInsight clusters."  advanced="false" hidden="true"/>
    <variable name="RESOURCE_GROUP_NAME" value="RG-of-${CLUSTER_NAME}" model="PA:NOT_EMPTY_STRING" description="Hidden variable that contains the name of the Resource Group where the Spark cluster will be created. If the value of this variable is changed, it must be also changed in the workflows &#39;Azure_HDInsight_Scale_Spark_Cluster&#39; and &#39;Azure_HDInsight_Delete_Spark_Cluster&#39;" group="Deployment Parameters" advanced="false" hidden="true"/>
    <variable name="RESOURCE_GROUP_LOCATION" value="westeurope" model="PA:NOT_EMPTY_STRING" description="Hidden variable that contains the region of Azure Cloud where the Resource Group will be created" group="Deployment Parameters" advanced="false" hidden="true"/>
    <variable name="DEPLOYMENT_NAME" value="Deployment-of-${CLUSTER_NAME}" model="PA:NOT_EMPTY_STRING" description="Hidden variable that contains the name of the Deployment for the Spark cluster. If the value of this variable is changed, it must be also changed in the workflows &#39;Azure_HDInsight_Scale_Spark_Cluster&#39; and &#39;Azure_HDInsight_Delete_Spark_Cluster&#39;" group="Deployment Parameters" advanced="false" hidden="true"/>
    <variable name="ARM_TEMPLATE" value="Azure_HDInsight_Spark_ARM_Template.json" model="PA:GLOBAL_FILE" description="Microsoft Azure ARM template (a JSON file), which is used to create the Spark cluster. This file must be placed in the global data space." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_NAME" value="activeeon-spark-cluster-${PA_JOB_ID}" model="PA:NOT_EMPTY_STRING" description="Name of the Spark cluster to be created." group="Spark Cluster Parameters" advanced="false" hidden="false"/>
    <variable name="CLUSTER_USER" value="act-usr" model="PA:NOT_EMPTY_STRING" description="User login that will be used to access the Web dashboard of the Spark cluster." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_PASSWORD" value="ENC(7ZqKwLLZE5B3S4BZoPq1wg==)" model="PA:HIDDEN" description="User password that will be used to access the Web dashboard of the Spark cluster." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_SSH_USER" value="act-usr" model="PA:NOT_EMPTY_STRING" description="User login that will be used to access the head node of the Spark cluster, remotely via SSH." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="CLUSTER_SSH_PASSWORD" value="ENC(vIn1k0HbSAYteZas59YECw==)" model="PA:HIDDEN" description="User password that will be used to access the head node of the Spark cluster, remotely via SSH." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="HEAD_NODE_VM_SIZE" value="Standard_E4_v3" model="PA:LIST(Standard_A4_v2,Standard_A8_v2,Standard_E2_v3, Standard_E4_v3,Standard_E8_v3,Standard_E16_v3,Standard_E20_v3,Standard_E32_v3,Standard_E48_v3)" description="Size of the VM of Spark head node. If the list of VM sizes is changed, it must be also changed in the ARM template (provided in the variable &#39;ARM_TEMPLATE&#39;)." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="WORKER_NODE_VM_SIZE" value="Standard_E4_v3" model="PA:LIST(Standard_A4_v2,Standard_A8_v2,Standard_E2_v3, Standard_E4_v3,Standard_E8_v3,Standard_E16_v3,Standard_E20_v3,Standard_E32_v3,Standard_E48_v3)" description="Size of the VM of Spark worker node. If the list of VM sizes is changed, it must be also changed in the ARM template (provided in the variable &#39;ARM_TEMPLATE&#39;)." group="Spark Cluster Parameters" advanced="true" hidden="false"/>
    <variable name="AUTOSCALING" value="true" model="PA:Boolean" description="Boolean value indicating whether the autoscaling feature (of HDInsight Spark) is activated or not." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="NUMBER_OF_WORKERS" value="2" model="PA:INTEGER" description="Number of Spark workers (to be used when the autoscaling feature is set to false)." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="MIN_WORKERS" value="1" model="PA:INTEGER" description="Minimal number of Spark workers (to be used when the autoscaling feature is set to true)." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="MAX_WORKERS" value="3" model="PA:INTEGER" description="Maximal number of Spark workers (to be used when the autoscaling feature is set to true)." group="Number of Workers" advanced="false" hidden="false"/>
    <variable name="AUTOSCALING_MODE" value="load" model="PA:LIST(load)" description="Autoscaling mode (only the &#39;load&#39; mode is supported by this workflow)." group="Number of Workers" advanced="true" hidden="false"/>
    <variable name="AUTOSCALING_NODES_HANDLER_1" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;false&#39; &amp;&amp; variables[&#39;AUTOSCALING&#39;] == &#39;false&#39; ?  showVar(&#39;NUMBER_OF_WORKERS&#39;) : hideVar(&#39;NUMBER_OF_WORKERS&#39;))" description="SPEL expression handling the variables to show with respect to the autoscaling setting." group="Number of Workers" advanced="false" hidden="true"/>
    <variable name="AUTOSCALING_NODES_HANDLER_2" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;false&#39; &amp;&amp; variables[&#39;AUTOSCALING&#39;] == &#39;true&#39; ?  showVar(&#39;MIN_WORKERS&#39;) &amp;&amp; showVar(&#39;MAX_WORKERS&#39;) &amp;&amp; showVar(&#39;AUTOSCALING_MODE&#39;) : hideVar(&#39;MIN_WORKERS&#39;) &amp;&amp; hideVar(&#39;MAX_WORKERS&#39;) &amp;&amp; hideVar(&#39;AUTOSCALING_MODE&#39;))" description="SPEL expression handling the variables to show with respect to the autoscaling setting."  advanced="false" hidden="true"/>
    <variable name="SCRIPT_ACTION" value="false" model="PA:Boolean" description="Boolean value indicating whether one or more script actions have to be executed when the Spark cluster is deployed." group="Script Action" advanced="true" hidden="false"/>
    <variable name="HEAD_NODE_SCRIPTS_JSON" value="[ {  &quot;name&quot;: &quot;Script A&quot;, &quot;uri&quot;: &quot;http://script.host:8080/scriptA&quot;,   &quot;parameters&quot;: &quot;p1 p2&quot;},  { &quot;name&quot;: &quot;script B&quot;, &quot;uri&quot;: &quot;http://script.host:8080/scriptB&quot;,  &quot;parameters&quot;: &quot;p1 p2 p3&quot; }]" model="PA:JSON" description="JSON payload describing the script actions to be executed in the head nodes of Spark (used when the &#39;SCRIPT_ACTION&#39; variable is set to true)." group="Script Action" advanced="true" hidden="false"/>
    <variable name="WORKER_NODE_SCRIPTS_JSON" value="[ ]" model="PA:JSON" description="JSON payload describing the script actions to be executed in the worker nodes of Spark (used when the &#39;SCRIPT_ACTION&#39; variable is set to true)." group="Script Action" advanced="true" hidden="false"/>
    <variable name="SCRIPT_ACTION_HANDLER" value="" model="PA:SPEL(variables[&#39;USE_JSON_INPUT_FILE&#39;] == &#39;false&#39; &amp;&amp; variables[&#39;SCRIPT_ACTION&#39;] == &#39;true&#39; ?  showVar(&#39;HEAD_NODE_SCRIPTS_JSON&#39;) &amp;&amp; showVar(&#39;WORKER_NODE_SCRIPTS_JSON&#39;) : hideVar(&#39;HEAD_NODE_SCRIPTS_JSON&#39;) &amp;&amp; hideVar(&#39;WORKER_NODE_SCRIPTS_JSON&#39;))" description="SPEL expression handling the variables to show with respect to the SCRIPT_ACTION setting."  advanced="false" hidden="true"/>
    <variable name="PROACTIVE_NODE_CREDENTIALS" value="change-it-and-add-a-proactive-user-credentials" model="PA:CREDENTIAL" description="Credentials (login/password) of a ProActive user that will be used to deploy ProActive nodes in Spark head and worker machines. Must be added to the third-party credentials vault (the user login is the key and the password is the credential)." group="ProActive Node Parameters" advanced="false" hidden="false"/>
    <variable name="HEAD_NODE_SCRIPT_NAME" value="Install_ProActive_Node_In_HN" model="PA:NOT_EMPTY_STRING" description="Hidden variable indicating the name of the script action that will deploy ProActive nodes in Spark head machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="HEAD_NODE_SCRIPT_URI" value="https://activeeon-spark-utils.s3.eu-west-3.amazonaws.com/Install_ProActive_Node.sh" model="PA:URI" description="Hidden variable indicating the URI of the script action that will deploy ProActive nodes in Spark head machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="WORKER_NODE_SCRIPT_NAME" value="Install_ProActive_Node_In_WN" model="PA:NOT_EMPTY_STRING" description="Hidden variable indicating the name of the script action that will deploy ProActive nodes in Spark worker machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="WORKER_NODE_SCRIPT_URI" value="https://activeeon-spark-utils.s3.eu-west-3.amazonaws.com/Install_ProActive_Node.sh" model="PA:URI" description="Hidden variable indicating the URI of the script action that will deploy ProActive nodes in Spark worker machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="NUMBER_OF_PROACTIVE_NODES" value="1" model="PA:INTEGER" description="Hidden variable indicating the number of ProActive nodes to be deployed in Spark head and worker machines." group="ProActive Node Parameters" advanced="false" hidden="true"/>
    <variable name="SCALE_WORKFLOW" value="big-data/Azure_HDInsight_Scale_Spark_Cluster" model="PA:CATALOG_OBJECT" description="Hidden variable indicating the workflow (in ProActive catalog) to be executed when the signal &#39;Scale_Nodes&#39; is triggered."  advanced="false" hidden="true"/>
    <variable name="DELETE_WORKFLOW" value="big-data/Azure_HDInsight_Delete_Spark_Cluster" model="PA:CATALOG_OBJECT" description="Hidden variable indicating the workflow (in ProActive catalog) to be executed when the signal &#39;Delete_Cluster&#39; is triggered."  advanced="false" hidden="true"/>
  </variables>
  <description>
    <![CDATA[ A workflow that uses Azure REST API to create a HDInsight Spark Cluster.
It requires as input the variable ARM_TEMPLATE, which takes as value a Azure ARM template. A ready-to-use template called "Azure_HDInsight_Spark_ARM_Template.json" is provided in the global dataspace. The workflow further customizes the ARM template with respect to the provided input variables. 
Once the Spark cluster is deployed successfully, the workflow produces as job results: (i) URL of the Web UI of the HDInsight Spark cluster, (ii) SSH host of the head node (i.e., master) of the cluster, (iii) SSH port of the head node (i.e., master) of the cluster, and (iv) a file containing the set of input variables. ]]>
  </description>
  <genericInformation>
    <info name="bucketName" value="big-data"/>
    <info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
    <info name="group" value="public-objects"/>
  </genericInformation>
  <taskFlow>
    <task name="hdinsight_deploy_spark" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A task performing a PUT request to Azure HDInsight REST API in order to deploy a Spark cluster, which name is given as input.
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL"    />
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01" inherited="false"     />
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="CONTENT_TYPE" value="application/json;charset = UTF-8" inherited="false"     />
        <variable name="REQUEST_BODY" value="${ARM_TEMPLATE_CONTENT}" inherited="false"    advanced="false" hidden="false"/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)"    />
        <variable name="RESPONSE_PATH" value="." inherited="false"     />
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false"     />
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
      </genericInformation>
      <depends>
        <task ref="azure-create_resource_group"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    DEPLOYMENT_NAME=variables.get("DEPLOYMENT_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01"
    variables.put("REQUEST_BODY", variables.get("ARM_TEMPLATE"))
    variables.put("PATH", PATH)
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given().contentType(variables.get("CONTENT_TYPE"))

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

requestBody = variables.get("REQUEST_BODY")
if (requestBody != null && !requestBody.isEmpty()) {
    
    if (!requestBody.startsWith("{")){
        File jsonFile = new File(requestBody);
        restCall = restCall.body(jsonFile)
    }
    else{
        restCall = restCall.body(requestBody)
    }    
}

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}

response = restCall.put(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            594.2613296508789
        </positionTop>
        <positionLeft>
            515.1278076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="azure_authenticate" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A task performing a POST request to Azure REST API in order to authenticate to Azure and acquire an authentication token. ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${AUTHENTICATION_ENDPOINT}" inherited="false" model="PA:URL"    />
        <variable name="PATH" value="/${TENANT_ID}/oauth2/token" inherited="false"     />
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="CONTENT_TYPE" value="application/x-www-form-urlencoded" inherited="false"     />
        <variable name="REQUEST_BODY" value="&amp;grant_type=client_credentials&amp;client_id=${APP_ID}&amp;client_secret=%PASSWORD%&amp;resource=https%3A%2F%2Fmanagement.azure.com%2F" inherited="false"     />
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)"    />
        <variable name="RESPONSE_PATH" value="access_token" inherited="false"     />
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/azure_icon.png"/>
      </genericInformation>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given().contentType(variables.get("CONTENT_TYPE"))

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

if (variables.get("REQUEST_BODY") != null && !variables.get("REQUEST_BODY").isEmpty()) {
    restCall = restCall.body(variables.get("REQUEST_BODY").replace("%PASSWORD%",variables.get("PASSWORD")))
}

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}
response = restCall.post(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}

variables.put("ACCESS_TOKEN",result)
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
def username = variables.get("PROACTIVE_NODE_CREDENTIALS")
def pwd = credentials.get(username)

//println username
//println pwd

def restUrl = variables.get("PA_SCHEDULER_REST_URL")
def post = new URL(restUrl +"/scheduler/login/").openConnection()
def message = "username=${username}&password=${pwd}"
post.setRequestMethod("POST")
post.setDoOutput(true)
post.getOutputStream().write(message.getBytes("UTF-8"))
def postRC = post.getResponseCode();
if (postRC.equals(200)) {
    sessionid=post.getInputStream().getText()
    variables.put("PROACTIVE_SESSION_ID",sessionid)
    println(variables.get("PROACTIVE_SESSION_ID"))
} else {
   throw new RuntimeException("Wrong credentials for user "+ username) 
}

variables.put("PROACTIVE_USER",username)
variables.put("PROACTIVE_PASSWORD",pwd)
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            82.20169830322266
        </positionTop>
        <positionLeft>
            513.125
        </positionLeft>
      </metadata>
    </task>
    <task name="hdinsight_check_deployment" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A task performing a Get request to Azure HDInsight REST API in order to  check the status of the deployment, which name is given as input.
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL"    />
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01" inherited="false"     />
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)"    />
        <variable name="RESPONSE_PATH" value="." inherited="false"     />
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false"     />
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
      </genericInformation>
      <depends>
        <task ref="hdinsight_deploy_spark"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    DEPLOYMENT_NAME=variables.get("DEPLOYMENT_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.Resources/deployments/${DEPLOYMENT_NAME}?api-version=2020-10-01"
    variables.put("PATH", PATH)
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given()

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("PARAM_")}).forEach({entry -> restCall = restCall.param(entry.getKey().replace("PARAM_",""), entry.getValue()) });

if (debug) {
    println "-------------- REQUEST ------------------"
	restCall = restCall.log().all()
}

response = restCall.get(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(HttpStatus.SC_OK)
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            722.2726821899414
        </positionTop>
        <positionLeft>
            515.1278076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="azure-create_resource_group" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A task performing a PUT request to Azure HDInsight REST API in order to create a Resource Group, which name is given as input.
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL"    />
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}?api-version=2020-10-01" inherited="false"     />
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="CONTENT_TYPE" value="application/json;charset = UTF-8" inherited="false"     />
        <variable name="REQUEST_BODY" value="{&quot;location&quot;: &quot;${RESOURCE_GROUP_LOCATION}&quot;}" inherited="false"    advanced="false" hidden="false"/>
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)"    />
        <variable name="RESPONSE_PATH" value="." inherited="false"     />
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false"     />
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/hdinsight.png"/>
      </genericInformation>
      <depends>
        <task ref="prepare_arm_template_params"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourcegroups/${RESOURCE_GROUP_NAME}?api-version=2020-10-01"
    
    RESOURCE_GROUP_LOCATION=variables.get("RESOURCE_GROUP_LOCATION")
    REQUEST_BODY="{\"location\": \"${RESOURCE_GROUP_LOCATION}\"}"

    variables.put("PATH", PATH)
    variables.put("REQUEST_BODY", REQUEST_BODY)
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given().contentType(variables.get("CONTENT_TYPE"))

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

if (variables.get("REQUEST_BODY") != null && !variables.get("REQUEST_BODY").isEmpty()) {
    restCall = restCall.body(variables.get("REQUEST_BODY"))
}

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}

response = restCall.put(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            469.2471694946289
        </positionTop>
        <positionLeft>
            515.1135864257812
        </positionLeft>
      </metadata>
    </task>
    <task name="hdinsight_get_spark_cluster_info" maxNumberOfExecution="3"
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A task that performs iteratively a GET request to Azure HDInsight REST API, in order to get information about the cluster deployment status. If the deployment status is "Succeeded". The cluster Web UI, SSH host and SSH port are extracted and provided as job results, then the loop stops. 
This task requires the Azure authentication token provided the task "azure_authenticate". ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${MANAGEMENT_ENDPOINT}" inherited="false" model="PA:URL"    />
        <variable name="PATH" value="/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.HDInsight/clusters/${CLUSTER_NAME}?api-version=2018-06-01-preview" inherited="false"     />
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="RESPONSE_FORMAT" value="json" inherited="false" model="PA:LIST(string,json,xml,html,contentView)"    />
        <variable name="RESPONSE_PATH" value="." inherited="false"     />
        <variable name="HEADER_Authorization" value="Bearer ${ACCESS_TOKEN}" inherited="false"     />
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/spark.png"/>
      </genericInformation>
      <depends>
        <task ref="hdinsight_check_deployment"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    SUBSCRIPTION_ID=variables.get("SUBSCRIPTION_ID")
    RESOURCE_GROUP_NAME=variables.get("RESOURCE_GROUP_NAME")
    CLUSTER_NAME=variables.get("CLUSTER_NAME")
    PATH = "/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP_NAME}/providers/Microsoft.HDInsight/clusters/${CLUSTER_NAME}?api-version=2018-06-01-preview"
    variables.put("PATH", PATH)
}

sleep(30000)
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))

restCall = given()

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("PARAM_")}).forEach({entry -> restCall = restCall.param(entry.getKey().replace("PARAM_",""), entry.getValue()) });

if (debug) {
    println "-------------- REQUEST ------------------"
	restCall = restCall.log().all()
}

response = restCall.get(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(HttpStatus.SC_OK)
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow >
        <loop target="hdinsight_get_spark_cluster_info">
          <script>
            <code language="groovy">
              <![CDATA[
provisioningState = variables.get("PROVISIONING_STATE")
if (provisioningState=="InProgress"){
   loop= "* * * * *" 
} else if (provisioningState=="Failed" || provisioningState=="Canceled"){
   loop=false
   throw new Exception("HDInsight Spark cluster deployment "+ provisioningState)
} else {
   loop=false
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
    
def slurper = new JsonSlurper()
    
jsonData = slurper.parseText(JsonOutput.toJson(result))

provisioningState=jsonData.properties.provisioningState

variables.put("PROVISIONING_STATE",provisioningState)

println variables.get("PROVISIONING_STATE")

if (provisioningState=="Succeeded"){
    
    LinkedHashMap resMap = [:]
    
    SSHEndpoint=jsonData.properties.connectivityEndpoints[0]
    WebUIEndpoint=jsonData.properties.connectivityEndpoints[1]
    
    println "_____________________CLUSTER NAME________________"
    resMap.put("SPARK_CLUSTER_NAME",variables.get("CLUSTER_NAME"))
    
    println "_____________________WEB UI ENDPOINT________________"
    println WebUIEndpoint
    println "Name: " + WebUIEndpoint.name
    println "Location: " + WebUIEndpoint.location
    println "Protocol: " + WebUIEndpoint.protocol
    println "Port: " + WebUIEndpoint.port
    sparkWebUI = WebUIEndpoint.name.toLowerCase() + "://" + WebUIEndpoint.location + ":" + WebUIEndpoint.port
    resMap.put("SPARK_WEB_ENDPOINT",sparkWebUI)
    
    schedulerapi.connect()
	schedulerapi.addExternalEndpointUrl(variables.get("PA_JOB_ID"), "Spark Web UI", sparkWebUI , "/automation-dashboard/styles/patterns/img/wf-icons/spark.png")
    
    println "_____________________SSH ENDPOINT________________"
    println SSHEndpoint
    println "Name: " + SSHEndpoint.name
    println "Location: " + SSHEndpoint.location
    println "Protocol: " + SSHEndpoint.protocol
    println "Port: " + SSHEndpoint.port
    resMap.put("SPARK_SSH_Host", SSHEndpoint.location)
    resMap.put("SPARK_SSH_Port", SSHEndpoint.port)
    
    println "_____________________HEAD NODE TOKEN________________"
    resMap.put("SPARK_HEAD_NODE_TOKEN",variables.get("CLUSTER_NAME")+"-hn")
    resMap.put("SPARK_WORKER_NODE_TOKEN",variables.get("CLUSTER_NAME")+"-wn")
    
    resultMap.putAll(resMap)
}
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            850.2840347290039
        </positionTop>
        <positionLeft>
            515.1278076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="get_input_parameters" 
    
    
    
    preciousResult="true" 
    fork="true">
      <description>
        <![CDATA[ The simplest task, ran by a Groovy engine. ]]>
      </description>
      <depends>
        <task ref="hdinsight_get_spark_cluster_info"/>
      </depends>
      <inputFiles>
        <files  includes="${ARM_TEMPLATE}" accessMode="transferFromGlobalSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
import javax.ws.rs.core.MediaType

def jsonSlurper = new JsonSlurper()
def jsonData = jsonSlurper.parseText('{"Main_Parameters": {},"Advanced_Parameters": {},"Hidden_Parameters": {}}')

// Add main variables
jsonData.Main_Parameters.put("SUBSCRIPTION_ID",variables.get("SUBSCRIPTION_ID"))
jsonData.Main_Parameters.put("CLUSTER_NAME",variables.get("CLUSTER_NAME"))
jsonData.Main_Parameters.put("AUTOSCALING",variables.get("AUTOSCALING"))
if (variables.get("AUTOSCALING").toLowerCase()=="true"){
    jsonData.Main_Parameters.put("MIN_WORKERS",variables.get("MIN_WORKERS"))
    jsonData.Main_Parameters.put("MAX_WORKERS",variables.get("MAX_WORKERS"))
} else {
    jsonData.Main_Parameters.put("NUMBER_OF_WORKERS",variables.get("NUMBER_OF_WORKERS"))
}
jsonData.Main_Parameters.put("PROACTIVE_NODE_CREDENTIALS",variables.get("PROACTIVE_NODE_CREDENTIALS"))

// Add advanced variables
jsonData.Advanced_Parameters.put("TENANT_ID",variables.get("TENANT_ID"))
jsonData.Advanced_Parameters.put("APP_ID",variables.get("APP_ID"))
jsonData.Advanced_Parameters.put("PASSWORD","******")
jsonData.Advanced_Parameters.put("ARM_TEMPLATE",variables.get("ARM_TEMPLATE"))
jsonData.Advanced_Parameters.put("RESOURCE_GROUP_LOCATION",variables.get("RESOURCE_GROUP_LOCATION"))
jsonData.Advanced_Parameters.put("CLUSTER_USER",variables.get("CLUSTER_USER"))
jsonData.Advanced_Parameters.put("CLUSTER_PASSWORD","******")
jsonData.Advanced_Parameters.put("CLUSTER_SSH_USER",variables.get("CLUSTER_SSH_USER"))
jsonData.Advanced_Parameters.put("CLUSTER_SSH_PASSWORD","******")
jsonData.Advanced_Parameters.put("HEAD_NODE_VM_SIZE",variables.get("HEAD_NODE_VM_SIZE"))
jsonData.Advanced_Parameters.put("WORKER_NODE_VM_SIZE",variables.get("WORKER_NODE_VM_SIZE"))
jsonData.Advanced_Parameters.put("AUTOSCALING_MODE",variables.get("AUTOSCALING_MODE"))
jsonData.Advanced_Parameters.put("SCRIPT_ACTION",variables.get("SCRIPT_ACTION"))
if (variables.get("SCRIPT_ACTION").toLowerCase()=="true"){    
    jsonData.Advanced_Parameters.put("HEAD_NODE_SCRIPTS_JSON",variables.get("HEAD_NODE_SCRIPTS_JSON"))
    jsonData.Advanced_Parameters.put("WORKER_NODE_SCRIPTS_JSON",variables.get("WORKER_NODE_SCRIPTS_JSON"))
}

// Add hidden variables
jsonData.Hidden_Parameters.put("AUTHENTICATION_ENDPOINT",variables.get("AUTHENTICATION_ENDPOINT"))
jsonData.Hidden_Parameters.put("MANAGEMENT_ENDPOINT",variables.get("MANAGEMENT_ENDPOINT"))
jsonData.Hidden_Parameters.put("RESOURCE_GROUP_NAME",variables.get("RESOURCE_GROUP_NAME"))
jsonData.Hidden_Parameters.put("DEPLOYMENT_NAME",variables.get("DEPLOYMENT_NAME"))
jsonData.Hidden_Parameters.put("HEAD_NODE_SCRIPT_NAME",variables.get("HEAD_NODE_SCRIPT_NAME"))
jsonData.Hidden_Parameters.put("HEAD_NODE_SCRIPT_URI",variables.get("HEAD_NODE_SCRIPT_URI"))
jsonData.Hidden_Parameters.put("WORKER_NODE_SCRIPT_NAME",variables.get("WORKER_NODE_SCRIPT_NAME"))
jsonData.Hidden_Parameters.put("WORKER_NODE_SCRIPT_URI",variables.get("WORKER_NODE_SCRIPT_URI"))
jsonData.Hidden_Parameters.put("NUMBER_OF_PROACTIVE_NODES",variables.get("NUMBER_OF_PROACTIVE_NODES"))
jsonData.Hidden_Parameters.put("SCALE_WORKFLOW",variables.get("SCALE_WORKFLOW"))
jsonData.Hidden_Parameters.put("DELETE_WORKFLOW",variables.get("DELETE_WORKFLOW"))


// Generate JSON file
def jsonFile = new File("Azure_HDInsight_Spark_Cluster_Parameters.json")
jsonFile.write(JsonOutput.prettyPrint(JsonOutput.toJson(jsonData)))

result = jsonFile.bytes
resultMetadata.put("file.name", "Azure_HDInsight_Spark_Cluster_Parameters.json")
resultMetadata.put("content.type", MediaType.APPLICATION_JSON.toString())
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.scheduler.common.job.JobVariable

def signals = ['Delete_Cluster']

if (variables.get("AUTOSCALING").toLowerCase()=="false"){
   signals.add("Scale_Nodes") 
}

signalapi.readyForSignal("Delete_Cluster")

if (signals.contains("Scale_Nodes")){
    List <JobVariable> scaleVariables = new java.util.ArrayList<JobVariable>()
    scaleVariables.add(new JobVariable("SCALING_OPERATION", "Scale_UP", "PA:LIST(Scale_UP,Scale_DOWN)", "Type of the scaling operation (up or down)", "Scaling parameters", false, false))
    scaleVariables.add(new JobVariable("NUMBER_OF_WORKERS", "1" , "PA:Integer", "Number of workers concerned by the scale operation", "Scaling parameters", false, false)

    signalapi.readyForSignal("Scale_Nodes", scaleVariables)    
}

variables.put("SIGNALS",signals)
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            978.3096084594727
        </positionTop>
        <positionLeft>
            515.1278076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="wait_for_signals" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ A template task that sends a ready notification for all the signals specified in the variable SIGNALS, then loops until one signal among those specified is received by the job. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/signal-wait.png"/>
        <info name="TASK.DOCUMENTATION" value="user/ProActiveUserGuide.html#_task_signal_api"/>
      </genericInformation>
      <depends>
        <task ref="get_input_parameters"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
signals = variables.get("SIGNALS")

receivedSignals = signalapi.checkForSignals(signals.toSet())
println(receivedSignals)

if (receivedSignals.containsKey("Delete_Cluster")) {
    variables.put("SIGNAL_ACTION","DELETE_CLUSTER")
    println("Deleting Spark cluster ...")
} else if (receivedSignals.containsKey("Scale_Nodes")){
    scalingOperation = receivedSignals.get("Scale_Nodes").get("SCALING_OPERATION")
    numberOfWorkers = receivedSignals.get("Scale_Nodes").get("NUMBER_OF_WORKERS")
    variables.put("SIGNAL_ACTION","SCALE_NODES")
    variables.put("SCALING_OPERATION",scalingOperation)
    variables.put("NUMBER_OF_WORKERS",numberOfWorkers)
    
    println(scalingOperation+ " the cluster nodes to "+numberOfWorkers)
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"></controlFlow>
      <metadata>
        <positionTop>
            1104.3039932250977
        </positionTop>
        <positionLeft>
            515.1278076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="submit_job_and_wait" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ Submit a workflow referenced in the ProActive Catalog (or accessible by url) and wait for its termination by checking every minute if the job is terminated. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_submit_job_and_wait.png"/>
        <info name="task.documentation" value="user/ProActiveUserGuide.html#_chaining_workflows_submit_a_workflow_from_another_workflow"/>
      </genericInformation>
      <depends>
        <task ref="wait_for_signals"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
def action = variables.get("SIGNAL_ACTION")
def called_workflow = null
def workflow_variables = new HashMap<>(); 

if ( action == "SCALE_NODES" || action == "DELETE_CLUSTER") {    
    workflow_variables.put("SUBSCRIPTION_ID",variables.get("SUBSCRIPTION_ID"))
    workflow_variables.put("TENANT_ID",variables.get("TENANT_ID"))
    workflow_variables.put("APP_ID",variables.get("APP_ID"))
    workflow_variables.put("PASSWORD",variables.get("PASSWORD"))
    workflow_variables.put("AUTHENTICATION_ENDPOINT",variables.get("AUTHENTICATION_ENDPOINT"))
    workflow_variables.put("MANAGEMENT_ENDPOINT",variables.get("MANAGEMENT_ENDPOINT"))
    workflow_variables.put("RESOURCE_GROUP_NAME",variables.get("RESOURCE_GROUP_NAME"))
    workflow_variables.put("CLUSTER_NAME",variables.get("CLUSTER_NAME"))
    
    if (action == "SCALE_NODES"){
        called_workflow = variables.get("SCALE_WORKFLOW")       
        workflow_variables.put("SCALING_OPERATION",variables.get("SCALING_OPERATION"))
        workflow_variables.put("NUMBER_OF_WORKERS",variables.get("NUMBER_OF_WORKERS"))
    } else {
        called_workflow = variables.get("DELETE_WORKFLOW")
        workflow_variables.put("DEPLOYMENT_NAME",variables.get("DEPLOYMENT_NAME"))
    }
    
    // connect to the scheduler
    schedulerapi.connect()
    def jobid
    if( !variables.get("jobSubmitted") ){

        println "Submitting workflow " + called_workflow

        // submitting the job
        def generic_infos_map = ["PARENT_JOB_ID" : variables.get("PA_JOB_ID")]
        jobid = schedulerapi.submitFromCatalog(variables.get("PA_CATALOG_REST_URL"), called_workflow, workflow_variables, generic_infos_map)
        variables.put("jobSubmitted", true)

        println "Job submitted with job id " + jobid
        variables.put("jobID", jobid)
    }

    if( jobid == null ){
        jobid = variables.get("jobID")
    }
    isFinished = schedulerapi.isJobFinished(jobid)

    variables.put("isFinished", isFinished)

    result = jobid
} else {
     variables.put("isFinished", true)
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow >
        <loop target="submit_job_and_wait">
          <script>
            <code language="javascript">
              <![CDATA[
// You can use a Cron Expression here
              // examples http://www.sauronsoftware.it/projects/cron4j/manual.php#p02
if(!variables.get("isFinished")){
	loop = '* * * * *';
}else{
    variables.put("jobSubmitted", false);
	loop = false;
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            1229.3181533813477
        </positionTop>
        <positionLeft>
            469.87213134765625
        </positionLeft>
      </metadata>
    </task>
    <task name="end_loop" 
    
    
    
    
    fork="true">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png"/>
      </genericInformation>
      <depends>
        <task ref="submit_job_and_wait"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.scheduler.common.job.JobVariable


if (variables.get("SIGNAL_ACTION") == "SCALE_NODES"){
    signalapi.removeSignal("Scale_Nodes")
    
    List <JobVariable> scaleVariables = new java.util.ArrayList<JobVariable>()
    
    scaleVariables.add(new JobVariable("SCALING_OPERATION", "Scale_UP", "PA:LIST(Scale_UP,Scale_DOWN)", "Type of the scaling operation (up or down)", "Scaling parameters", false, false))
    scaleVariables.add(new JobVariable("NUMBER_OF_WORKERS", "1" , "PA:Integer", "Number of workers concerned by the scale operation", "Scaling parameters", false, false)
    
    signalapi.readyForSignal("Scale_Nodes", scaleVariables)    
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow  block="end">
        <loop target="wait_for_signals">
          <script>
            <code language="groovy">
              <![CDATA[
signalAction=variables.get("SIGNAL_ACTION")

if (signalAction=="DELETE_CLUSTER"){
    loop = false
} else {
    loop = "* * * * *"
}
variables.put("SIGNAL_ACTION","")
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            1356.3351211547852
        </positionTop>
        <positionLeft>
            517.116455078125
        </positionLeft>
      </metadata>
    </task>
    <task name="prepare_pa_node_params" maxNumberOfExecution="1"
    
    onTaskError="suspendTask" 
    
    
    fork="true">
      <description>
        <![CDATA[ A task performing a rest POST request using form data.

This template supports only basic authentication, for more advanced authentication settings, please modify the template according to the rest-assured documentation:
https://github.com/rest-assured/rest-assured/wiki/Usage#authentication

It accepts the following parameters:
ENDPOINT: base url of the request (inherited from job variable)
USER: basic auth user (if required, inherited from job variable)
PASSWORD: basic auth password (if required, inherited from job variable)
PATH: path of the request (relative to the base url)
SSL_DISABLE_CHECK: to disable ssl certificate check
DEBUG: to print the full request and response content in the task output
RESPONSE_FORMAT: format of the response, either
  - string : plain text
  - json: a json response which will be parsed using RESPONSE_PATH
  - xml: a xml response which will be parsed using RESPONSE_PATH
  - html: an html response which will be parsed using RESPONSE_PATH
  - contentView: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)
RESPONSE_PATH: which data to extract in the response if json, xml or html format is selected. It uses the GPath notation (https://groovy-lang.org/processing-xml.html)

Header, form or query parameters can also be added dynamically, by adding variables in the format:
HEADER_<header_name>
PARAM_<param_name>
QUERY_PARAM_<param_name> ]]>
      </description>
      <variables>
        <variable name="ENDPOINT" value="${PA_SCHEDULER_REST_URL}" inherited="false" model=""   advanced="false" hidden="false"/>
        <variable name="PATH" value="/scheduler/createcredential/" inherited="false"    advanced="false" hidden="false"/>
        <variable name="CONTENT_TYPE" value="multipart/form-data" inherited="false" model="PA:LIST(application/x-www-form-urlencoded,multipart/form-data)"   advanced="false" hidden="false"/>
        <variable name="SSL_DISABLE_CHECK" value="true" inherited="false" model="PA:Boolean"    />
        <variable name="DEBUG" value="true" inherited="false" model="PA:Boolean"   advanced="false" hidden="false"/>
        <variable name="RESPONSE_FORMAT" value="string" inherited="false" model="PA:LIST(string,json,xml,html,contentView)"   advanced="false" hidden="false"/>
        <variable name="RESPONSE_PATH" value="" inherited="false"    advanced="false" hidden="false"/>
        <variable name="PARAM_username" value="${PA_USER}" inherited="false"    advanced="false" hidden="false"/>
        <variable name="PARAM_password" value="${PROACTIVE_PASSWORD}" inherited="false"    advanced="false" hidden="false"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/api-rest.png"/>
      </genericInformation>
      <depends>
        <task ref="azure_authenticate"/>
      </depends>
      <inputFiles>
        <files  includes="rest-assured-fat-3.3.0.jar" accessMode="cacheFromGlobalSpace"/>
        <files  includes="${JSON_INPUT_FILE}" accessMode="transferFromGlobalSpace"/>
      </inputFiles>
      <forkEnvironment >
        <envScript>
          <script>
            <code language="groovy">
              <![CDATA[
def jarFile = new File(cachespace, "rest-assured-fat-3.3.0.jar")

forkEnvironment.addAdditionalClasspath(jarFile.getAbsolutePath())
]]>
            </code>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*

if (variables.get("USE_JSON_INPUT_FILE").toLowerCase()=="true"){
    
    jsonFile = new File(variables.get("JSON_INPUT_FILE"))

    def jsonSlurper = new JsonSlurper()
    jsonData = jsonSlurper.parse(jsonFile)

    println "The workflow will use the following parameters:"
    
    // Process main parameters
    mainParameters = jsonData.Main_Parameters 
    mainParameters.keySet().each{key->        
        variables.put(key,mainParameters.get(key))
        println key +": "+ variables.get(key)
	}
    
    // Process advanced parameters
    advancedParameters = jsonData.Advanced_Parameters 
    advancedParameters.keySet().each{key->        
        variables.put(key,advancedParameters.get(key))
        println key +": "+ variables.get(key)
	}
    
    // Process hidden parameters
    hiddenParameters = jsonData.Hidden_Parameters 
    hiddenParameters.keySet().each{key->        
        variables.put(key,hiddenParameters.get(key))
        println key +": "+ variables.get(key)
	}
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
// See https://github.com/rest-assured/rest-assured/wiki/Usage for documentation

import static io.restassured.RestAssured.*;
import static io.restassured.matcher.RestAssuredMatchers.*;
import static io.restassured.config.EncoderConfig.*;
import static org.hamcrest.Matchers.*;
import org.apache.commons.httpclient.HttpStatus;
import io.restassured.http.ContentType;
import io.restassured.RestAssured;
import com.google.common.base.Strings;

debug = Boolean.parseBoolean(variables.get("DEBUG"))
contentType = variables.get("CONTENT_TYPE")
isMultiPart = contentType.equals("multipart/form-data")

restCall = given().contentType(contentType + ";charset = UTF-8")

if (Boolean.parseBoolean(variables.get("SSL_DISABLE_CHECK"))) {
    restCall = restCall.relaxedHTTPSValidation()
}

if (!Strings.isNullOrEmpty(variables.get("USER")) && !Strings.isNullOrEmpty(variables.get("PASSWORD"))) {
    restCall = restCall.auth().preemptive().basic(variables.get("USER"), variables.get("PASSWORD"))
}

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("HEADER_")}).forEach({entry -> restCall = restCall.header(entry.getKey().replace("HEADER_",""), entry.getValue()) });

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("PARAM_")}).forEach({entry -> restCall = (isMultiPart ? restCall.multiPart(entry.getKey().replace("PARAM_",""), entry.getValue()) : restCall.formParam(entry.getKey().replace("PARAM_",""), entry.getValue()) )});

variables.entrySet().stream().filter({entry -> entry.getKey().startsWith("QUERY_PARAM_")}).forEach({entry -> restCall = restCall.queryParam(entry.getKey().replace("QUERY_PARAM_",""), entry.getValue()) });

if (debug) {
    println "-------------- REQUEST -----------------"
	restCall = restCall.log().all()
}

response = restCall.post(variables.get("ENDPOINT") + variables.get("PATH"))

if (debug) {
    println "-------------- RESPONSE -----------------"
	println response.statusLine()
    println response.prettyPrint()
} else {
	println response.statusLine()
}

response = response.then().assertThat()
  .statusCode(allOf(greaterThanOrEqualTo(HttpStatus.SC_OK),lessThan(HttpStatus.SC_MULTIPLE_CHOICES)))
  .extract();

if (debug) {
    println "-------------- RESULT -------------------"
}

if (response.statusCode() == HttpStatus.SC_NO_CONTENT && !variables.get("RESPONSE_PATH").isEmpty()) {
    throw new IllegalStateException("A RESPONSE_PATH was requested but http response has no content.")
} else if (response.statusCode() == HttpStatus.SC_NO_CONTENT) {
    result = true;
    // response has no content
    return;
}

switch (variables.get("RESPONSE_FORMAT")) {
    case "json":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for json format")
    }
    result = response.jsonPath().get(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "xml":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for xml format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.xmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "html":
    if (variables.get("RESPONSE_PATH").isEmpty()) {
        throw new IllegalArgumentException("Invalid RESPONSE_PATH for html format")
    }
    // html parsing results are not serializable and thus can be returned only in string format
    result = response.htmlPath().getString(variables.get("RESPONSE_PATH"));
    println result
    break;
    
    case "contentView":
    result = response.asByteArray();
    resultMetadata.put("content.type", response.contentType())
    // uncomment the following line to allow saving the result as a file on the scheduler portal
    // see https://doc.activeeon.com/latest/user/ProActiveUserGuide.html#_assigning_metadata_to_task_result
    // resultMetadata.put("file.extension",".png")
    println "See result in \"Task Preview\" tab with content " + response.contentType()
    break;
    
    case "string":
    result = response.prettyPrint()
    break;
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
def restUrl = variables.get("PA_SCHEDULER_REST_URL")
def nodeJarUrl = restUrl+"/node.jar"
def host = new URL(restUrl).getHost() 
def protocol = variables.get("PA_NODE_URL").substring(0, restUrl.lastIndexOf("//")-2)

def get = new URL(restUrl +"/rm/url/").openConnection();
def getRC = get.getResponseCode();
if (getRC.equals(200)) {
    rmURL = get.getInputStream().getText()
    println("rmUrl: "+rmURL);
} else {
   throw new RuntimeException("Cannot acquire The RM URL.") 
}

println "nodeJarUrl: "+nodeJarUrl
println "rmHostname: "+host
println "protocol: "+protocol
println "nodeNamingOption: "+variables.get("CLUSTER_NAME")
println "credentials: "+result
println "numberOfNodesPerInstance: "+ 1
println "additionalProperties: "+ "-Dproactive.useIPaddress=true"

def headNodeScriptParameters = restUrl + " " + protocol + " " + host + " " + rmURL+ " " + variables.get("CLUSTER_NAME")+"-hn " + result + " " + variables.get("NUMBER_OF_PROACTIVE_NODES") + " -Dproactive.useIPaddress=true "+ variables.get("PROACTIVE_SESSION_ID")
println headNodeScriptParameters
variables.put ("HEAD_NODE_SCRIPT_PARAMETERS",headNodeScriptParameters)

def workerNodeScriptParameters = restUrl + " " + protocol + " " + host + " " + rmURL+ " " + variables.get("CLUSTER_NAME")+"-wn " + result + " " + variables.get("NUMBER_OF_PROACTIVE_NODES") + " -Dproactive.useIPaddress=true "+ variables.get("PROACTIVE_SESSION_ID")
println workerNodeScriptParameters
variables.put ("WORKER_NODE_SCRIPT_PARAMETERS",workerNodeScriptParameters)
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            212.21588897705078
        </positionTop>
        <positionLeft>
            515.1278076171875
        </positionLeft>
      </metadata>
    </task>
    <task name="prepare_arm_template_params" 
    
    
    
    
    fork="true">
      <depends>
        <task ref="prepare_pa_node_params"/>
      </depends>
      <inputFiles>
        <files  includes="${ARM_TEMPLATE}" accessMode="transferFromGlobalSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.json.*
    
jsonFile = new File(variables.get("ARM_TEMPLATE"))

def jsonSlurper = new JsonSlurper()
jsonData = jsonSlurper.parse(jsonFile)

jsonData.properties.template.parameters.clusterName.defaultValue = variables.get("CLUSTER_NAME") 
jsonData.properties.template.parameters.clusterLoginUserName.defaultValue =  variables.get("CLUSTER_USER")
jsonData.properties.template.parameters.clusterLoginPassword.defaultValue = variables.get("CLUSTER_PASSWORD")
jsonData.properties.template.parameters.sshUserName.defaultValue = variables.get("CLUSTER_SSH_USER")
jsonData.properties.template.parameters.sshPassword.defaultValue= variables.get("CLUSTER_SSH_PASSWORD")

jsonData.properties.template.parameters.HeadNodeVirtualMachineSize.defaultValue = variables.get("HEAD_NODE_VM_SIZE") 
jsonData.properties.template.parameters.WorkerNodeVirtualMachineSize.defaultValue = variables.get("WORKER_NODE_VM_SIZE") 

jsonData.properties.template.resources[1].properties.computeProfile.roles[1].targetInstanceCount = variables.get("NUMBER_OF_WORKERS")

if (variables.get("AUTOSCALING").toLowerCase()=="true"){
	def autoScaleContent = new JsonSlurper().parseText('{ "capacity": { "minInstanceCount": '+variables.get("MIN_WORKERS")+', "maxInstanceCount": '+variables.get("MAX_WORKERS")+' }},')
    jsonData.properties.template.resources[1].properties.computeProfile.roles[1].put("autoscale",autoScaleContent)
}

def headNodeScriptActionDefaultContent = new JsonSlurper().parseText('[{"name": "'+variables.get("HEAD_NODE_SCRIPT_NAME")+'", "uri": "'+variables.get("HEAD_NODE_SCRIPT_URI")+'", "parameters": "'+variables.get("HEAD_NODE_SCRIPT_PARAMETERS")+'"}]')

def workerNodeScriptActionDefaultContent = new JsonSlurper().parseText('[{"name": "'+variables.get("WORKER_NODE_SCRIPT_NAME")+'", "uri": "'+variables.get("WORKER_NODE_SCRIPT_URI")+'", "parameters": "'+variables.get("WORKER_NODE_SCRIPT_PARAMETERS")+'"}]')

if (variables.get("SCRIPT_ACTION").toLowerCase()=="true"){    
    def headNodeScriptActionContent = new JsonSlurper().parseText(variables.get("HEAD_NODE_SCRIPTS_JSON"))
    assert headNodeScriptActionContent instanceof List    
    headNodeScriptActionContent.each {
        assert !it.name.isEmpty() && !it.uri.isEmpty()
        headNodeScriptActionDefaultContent.add(it)
    }
    
    def workerNodeScriptActionContent = new JsonSlurper().parseText(variables.get("WORKER_NODE_SCRIPTS_JSON"))
    assert workerNodeScriptActionContent instanceof List    
    workerNodeScriptActionContent.each {
        assert !it.name.isEmpty() && !it.uri.isEmpty()
    	workerNodeScriptActionDefaultContent.add(it)
	}
}

jsonData.properties.template.resources[1].properties.computeProfile.roles[0].scriptActions = headNodeScriptActionDefaultContent
jsonData.properties.template.resources[1].properties.computeProfile.roles[1].scriptActions = workerNodeScriptActionDefaultContent

def modifiedJson = JsonOutput.prettyPrint(JsonOutput.toJson(jsonData))

//jsonFile.write(modifiedJson)
variables.put("ARM_TEMPLATE_CONTENT",modifiedJson)

println modifiedJson
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            339.23294830322266
        </positionTop>
        <positionLeft>
            517.116455078125
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2485px;
            height:2814px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-77.20169830322266px;left:-464.87213134765625px"><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1037" style="top: 594.275px; left: 515.142px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a PUT request to Azure HDInsight REST API in order to deploy a Spark cluster, which name is given as input.
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/spark.png" width="20px">&nbsp;<span class="name">hdinsight_deploy_spark</span></a></div><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" id="jsPlumb_1_1040" style="top: 82.2156px; left: 513.139px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a POST request to Azure REST API in order to authenticate to Azure and acquire an authentication token."><img src="/automation-dashboard/styles/patterns/img/wf-icons/azure_icon.png" width="20px">&nbsp;<span class="name">azure_authenticate</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1043" style="top: 722.287px; left: 515.142px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a Get request to Azure HDInsight REST API in order to  check the status of the deployment, which name is given as input.
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/spark.png" width="20px">&nbsp;<span class="name">hdinsight_check_deployment</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1046" style="top: 469.261px; left: 515.127px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a PUT request to Azure HDInsight REST API in order to create a Resource Group, which name is given as input.
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/hdinsight.png" width="20px">&nbsp;<span class="name">azure-create_resource_group</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1049" style="top: 850.298px; left: 515.142px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task that performs iteratively a GET request to Azure HDInsight REST API, in order to get information about the cluster deployment status. If the deployment status is &quot;Succeeded&quot;. The cluster Web UI, SSH host and SSH port are extracted and provided as job results, then the loop stops. 
This task requires the Azure authentication token provided the task &quot;azure_authenticate&quot;."><img src="/automation-dashboard/styles/patterns/img/wf-icons/spark.png" width="20px">&nbsp;<span class="name">hdinsight_get_spark_cluster_info</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1052" style="top: 978.323px; left: 515.142px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="The simplest task, ran by a Groovy engine."><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">get_input_parameters</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1055" style="top: 1104.32px; left: 515.142px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A template task that sends a ready notification for all the signals specified in the variable SIGNALS, then loops until one signal among those specified is received by the job."><img src="/automation-dashboard/styles/patterns/img/wf-icons/signal-wait.png" width="20px">&nbsp;<span class="name">wait_for_signals</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1058" style="top: 1229.33px; left: 469.886px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Submit a workflow referenced in the ProActive Catalog (or accessible by url) and wait for its termination by checking every minute if the job is terminated."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_submit_job_and_wait.png" width="20px">&nbsp;<span class="name">submit_job_and_wait</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1061" style="top: 1356.35px; left: 517.13px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png" width="20px">&nbsp;<span class="name">end_loop</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1064" style="top: 212.23px; left: 515.142px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task performing a rest POST request using form data.

This template supports only basic authentication, for more advanced authentication settings, please modify the template according to the rest-assured documentation:
https://github.com/rest-assured/rest-assured/wiki/Usage#authentication

It accepts the following parameters:
ENDPOINT: base url of the request (inherited from job variable)
USER: basic auth user (if required, inherited from job variable)
PASSWORD: basic auth password (if required, inherited from job variable)
PATH: path of the request (relative to the base url)
SSL_DISABLE_CHECK: to disable ssl certificate check
DEBUG: to print the full request and response content in the task output
RESPONSE_FORMAT: format of the response, either
  - string : plain text
  - json: a json response which will be parsed using RESPONSE_PATH
  - xml: a xml response which will be parsed using RESPONSE_PATH
  - html: an html response which will be parsed using RESPONSE_PATH
  - contentView: the response will be stored in raw format, and the response content-type will be used for previewing (suitable for binary formats such as files, images, pdf documents, etc)
RESPONSE_PATH: which data to extract in the response if json, xml or html format is selected. It uses the GPath notation (https://groovy-lang.org/processing-xml.html)

Header, form or query parameters can also be added dynamically, by adding variables in the format:
HEADER_<header_name>
PARAM_<param_name>
QUERY_PARAM_<param_name>"><img src="/automation-dashboard/styles/patterns/img/wf-icons/api-rest.png" width="20px">&nbsp;<span class="name">prepare_pa_node_params</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1067" style="top: 339.247px; left: 517.13px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">prepare_arm_template_params</span></a></div><svg style="position:absolute;left:574.5px;top:508.5px" width="34" height="87" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 86 C -10 36 23 50 13 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7602812500000005,64.94400000000002 L9.068135828439264,46.73012112768496 L1.0169941452697502,51.222238401035064 L-4.653625770525691,43.952845732415206 L-1.7602812500000005,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7602812500000005,64.94400000000002 L9.068135828439264,46.73012112768496 L1.0169941452697502,51.222238401035064 L-4.653625770525691,43.952845732415206 L-1.7602812500000005,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:574.5px;top:634.5px" width="33" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 12 88 C 22 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M13.807488,66.303232 L16.95868678791453,45.34923605175552 L11.199122872356591,52.54836263090405 L3.2038174188185877,47.95760117939893 L13.807488,66.303232" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M13.807488,66.303232 L16.95868678791453,45.34923605175552 L11.199122872356591,52.54836263090405 L3.2038174188185877,47.95760117939893 L13.807488,66.303232" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:587.5px;top:378.5px" width="27.5" height="91" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 90 C -10 40 16.5 50 6.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.2779360000000004,68.13216 L6.946620183910768,49.05579862761366 L-0.6890889688170292,54.22261057841553 L-6.962929237673708,47.4669515964307 L-2.2779360000000004,68.13216" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.2779360000000004,68.13216 L6.946620183910768,49.05579862761366 L-0.6890889688170292,54.22261057841553 L-6.962929237673708,47.4669515964307 L-2.2779360000000004,68.13216" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:586.5px;top:762.5px" width="29.5" height="88" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 8.5 87 C 18.5 37 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M10.625484375,65.86284375000001 L14.773382051064115,45.08316750447342 L8.676716172853776,51.99913924888258 L0.9096775499466796,47.03193570661965 L10.625484375,65.86284375000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M10.625484375,65.86284375000001 L14.773382051064115,45.08316750447342 L8.676716172853776,51.99913924888258 L0.9096775499466796,47.03193570661965 L10.625484375,65.86284375000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:676.0266769263776px;top:799.5px" width="20.473323073622403" height="141" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 40 C -10 90 -10 -50 0 0 " transform="translate(19.973323073622403,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_1087" style="position: absolute; transform: translate(-50%, -50%); left: 688px; top: 869.5px;">loop</div><svg style="position:absolute;left:570.5px;top:889.5px" width="45.5" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 34.5 50 24.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-0.6443596250000018,65.8307285 L12.744613831917167,49.40710558147293 L4.120445546316602,52.66651064707025 L-0.41960402101258953,44.64230041015634 L-0.6443596250000018,65.8307285" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-0.6443596250000018,65.8307285 L12.744613831917167,49.40710558147293 L4.120445546316602,52.66651064707025 L-0.41960402101258953,44.64230041015634 L-0.6443596250000018,65.8307285" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:557.5px;top:1017.5px" width="34" height="88" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 87 C -10 37 23 50 13 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7219520000000006,65.388768 L9.160644305345858,47.20720872542532 L1.0961641616670847,51.67533585121424 L-4.5527878434399005,44.389092563758226 L-1.7219520000000006,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.7219520000000006,65.388768 L9.160644305345858,47.20720872542532 L1.0961641616670847,51.67533585121424 L-4.5527878434399005,44.389092563758226 L-1.7219520000000006,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:524px;top:1144.5px" width="54.5" height="85" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 84 C -10 34 43.5 50 33.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M0.165746124999998,62.1907755 L15.479684784056941,47.545527712863 L6.519128177108055,49.715418330766276 L3.00432761482322,41.19214566075494 L0.165746124999998,62.1907755" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M0.165746124999998,62.1907755 L15.479684784056941,47.545527712863 L6.519128177108055,49.715418330766276 L3.00432761482322,41.19214566075494 L0.165746124999998,62.1907755" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:579.0266769263776px;top:1178.5px" width="20.473323073622403" height="141" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 40 C -10 90 -10 -50 0 0 " transform="translate(19.973323073622403,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.4569999999999963,49.16001999999999 L-8.714346841294152,28.91537600442066 L-10.77778447022079,37.90104376767174 L-19.973323073622403,37.23616047464146 L-2.4569999999999963,49.16001999999999" class="" stroke="#316b31" fill="#316b31" transform="translate(19.973323073622403,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_1102" style="position: absolute; transform: translate(-50%, -50%); left: 591px; top: 1248.5px;">loop</div><svg style="position:absolute;left:524px;top:1268.5px" width="53.5" height="88" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 32.5 87 C 42.5 37 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M32.424265625,64.92074025000001 L30.164753924845378,43.85193376085914 L26.41667918406659,52.27523096192809 L17.519244636773465,49.85952020179255 L32.424265625,64.92074025000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M32.424265625,64.92074025000001 L30.164753924845378,43.85193376085914 L26.41667918406659,52.27523096192809 L17.519244636773465,49.85952020179255 L32.424265625,64.92074025000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:606.5px;top:1144.5px" width="25" height="212" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 4 0 C 14 50 -10 161 0 211 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M6.1449835,48.126647250000005 L12.164697344654389,68.4432179554236 L5.464573583233221,62.11010327292815 L-1.8187586782737561,67.76280803865681 L6.1449835,48.126647250000005" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M6.1449835,48.126647250000005 L12.164697344654389,68.4432179554236 L5.464573583233221,62.11010327292815 L-1.8187586782737561,67.76280803865681 L6.1449835,48.126647250000005" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_1111" style="position: absolute; transform: translate(-50%, -50%); left: 618.5px; top: 1250px;">loop</div><svg style="position:absolute;left:562px;top:121.5px" width="40" height="91" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 19 90 C 29 40 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M20.13942425,67.650705 L21.46728920123458,46.50273170062016 L16.351675481640214,54.17283575936004 L7.989419960594612,50.29048046897995 L20.13942425,67.650705" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M20.13942425,67.650705 L21.46728920123458,46.50273170062016 L16.351675481640214,54.17283575936004 L7.989419960594612,50.29048046897995 L20.13942425,67.650705" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:581px;top:251.5px" width="34" height="88" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 13 87 C 23 37 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M14.721952,65.388768 L17.552787843439905,44.38909256375823 L11.903835838332917,51.67533585121424 L3.839355694654146,47.20720872542531 L14.721952,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M14.721952,65.388768 L17.552787843439905,44.38909256375823 L11.903835838332917,51.67533585121424 L3.839355694654146,47.20720872542531 L14.721952,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 575px; top: 625px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 575px; top: 585px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 562.5px; top: 112px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 587px; top: 753px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 587px; top: 713px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 588px; top: 499px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 588px; top: 459px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 595.5px; top: 880px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 595.5px; top: 840px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 686px; top: 840px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 686px; top: 880px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 571px; top: 1008px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 571px; top: 968px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 558px; top: 1135px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 558px; top: 1095px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 611px; top: 1135px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 524.5px; top: 1259px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 524.5px; top: 1219px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 589px; top: 1219px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 589px; top: 1259px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 557px; top: 1386px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 557px; top: 1346px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 607px; top: 1346px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 581.5px; top: 242px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 581.5px; top: 202px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 594.5px; top: 369px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 594.5px; top: 329px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>
