<?xml version="1.0" encoding="UTF-8"?>
<job
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="urn:proactive:jobdescriptor:3.11" xsi:schemaLocation="urn:proactive:jobdescriptor:3.11 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.11/schedulerjob.xsd"  name="Inputs_Optimization" projectName="MC-Optim" priority="normal" onTaskError="continueJobExecution"  maxNumberOfExecution="1" >
  <variables>
    <variable name="energy_weight" value="0.7" />
    <variable name="json_file_path_from_dataspace" value="configure.json" />
    <variable name="min_fitness_selection_rate" value="0.001" />
    <variable name="mrr_weight" value="0.2" />
    <variable name="mutation_probability" value="0.01" />
    <variable name="nb_machpro_runs" value="5" />
    <variable name="nb_optim_iterations" value="5" />
    <variable name="program_file_path_from_dataspace" value="T4_KOKO_D80_1vExec.cls" />
    <variable name="time_weight" value="0.1" />
    <variable name="VMSCMD_file_path_from_dataspace" value="Soraluce_use_caseT1.VMSCMD" />
  </variables>
  <description>
    <![CDATA[ Workflow optimizing the process simulation inputs to minimize the material removal rate, the energy and the duration. ]]>
  </description>
  <genericInformation>
    <info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/mc-optim.png"/>
  </genericInformation>
  <taskFlow>
    <task name="Random_inputs" >
      <inputFiles>
        <files  includes="$json_file_path_from_dataspace" accessMode="transferFromUserSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import java.util.Random
import java.text.SimpleDateFormat

println "Random_inputs ..."


// json file -> map
def json_file_path_from_dataspace = variables.get("json_file_path_from_dataspace")
def json_file_content = new File(localspace, json_file_path_from_dataspace).text
def slurper = new groovy.json.JsonSlurper()
def json_map = (Map) slurper.parseText(json_file_content)

// Retrieve SS and FR ranges
def INPUT_map = json_map.get("INPUT")
def SS_map = INPUT_map.get("SS")
def SS_min = SS_map.get("Min") as Integer
def SS_max = SS_map.get("Max") as Integer
def FR_map = INPUT_map.get("FR")
def FR_min = FR_map.get("Min") as Integer
def FR_max = FR_map.get("Max") as Integer
println "SS_min:" + SS_min + " SS_max:" + SS_max + " FR_min:" + FR_min + " FR_max:" + FR_max

// Write input variables for each task in a dedicated variable
// (check generator period to ensure no repetition)
def nb_machpro_runs = variables.get("nb_machpro_runs") as Integer
def r = new Random()
(0..(nb_machpro_runs-1)).each { task_id ->
     def SS = r.nextInt(SS_max - SS_min) + SS_min
 	 def FR = r.nextInt(FR_max - FR_min) + FR_min
 	 variables["inputs_" + task_id] =  "SS=" + SS + ";FR=" +  FR
     println "variables[\"inputs_" + task_id + "\"] = \"" + variables["inputs_" + task_id] + "\""
}


// Some useful variables that will be used by other tasks
variables["optimization_index"] = 0
variables["current_time"] = new SimpleDateFormat("MM-dd-yyyy_HH-mm-ss").format(new Date())
variables["SS_min"] = SS_min
variables["SS_max"] = SS_max
variables["FR_min"] = FR_min
variables["FR_max"] = FR_max


println "... Random_inputs"
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="none"></controlFlow>
    </task>
    <task name="Expose_new_inputs" >
      <depends>
        <task ref="Random_inputs"/>
      </depends>
      <inputFiles>
        <files  includes="$last_chart_file_path_from_dataspace" accessMode="transferFromUserSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.apache.commons.io.FileUtils

println "Expose_new_inputs ..."

// Retrieve variables
def optimization_index = variables.get("optimization_index") as Integer
def current_time = variables.get("current_time")

if (optimization_index > 0)
{
  def last_chart_file_path_from_dataspace = variables.get("last_chart_file_path_from_dataspace")
  def last_chart_file = new File(localspace, last_chart_file_path_from_dataspace)
  println last_chart_file.absolutePath + " exists? " + last_chart_file.exists()

  // Expose it as a task output
  result = last_chart_file.getBytes()
  resultMetadata.put("file.name", last_chart_file_path_from_dataspace)
  resultMetadata.put("content.type", "image/png")

  // And save it into a specific dir
  def dest_dir = new File(new File(localspace, "MC_OPTIM"), current_time)
  dest_dir.mkdirs()
  def dest_file = new File(dest_dir, optimization_index + "_" + last_chart_file_path_from_dataspace)
  FileUtils.moveFile(last_chart_file, dest_file, false)
}

println "... Expose_new_inputs"
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"></controlFlow>
      <outputFiles>
        <files  includes="MC_OPTIM/**" accessMode="transferToUserSpace"/>
      </outputFiles>
    </task>
    <task name="useless1" >
      <depends>
        <task ref="Expose_new_inputs"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
println "useless1 ..."
println "... useless1"
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow >
        <replicate>
          <script>
            <code language="groovy">
              <![CDATA[
runs=variables.get("nb_machpro_runs") as Integer
]]>
            </code>
          </script>
        </replicate>
      </controlFlow>
    </task>
    <task name="Update_program_file" >
      <depends>
        <task ref="useless1"/>
      </depends>
      <inputFiles>
        <files  includes="commons-jexl3-3.0.jar" accessMode="transferFromUserSpace"/>
        <files  includes="$program_file_path_from_dataspace" accessMode="transferFromUserSpace"/>
      </inputFiles>
      <forkEnvironment >
        <additionalClasspath>
          <pathElement path="commons-jexl3-3.0.jar"/>
        </additionalClasspath>
      </forkEnvironment>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
println "Update_program_file ..."


import java.util.regex.Pattern


// Retrieve the first occurence of var in the program file content
def findFirstValue (var, content)
{
    def keyLinePattern = Pattern.compile(var + ".*")
    def occurences = content.findAll(keyLinePattern)

    def val = "null"
    if (occurences.isEmpty())
    	return val

    // Get the last occurence
    def nbOccurences = occurences.size()
	def lastOccurence = occurences.get(nbOccurences - 1)

    // In the first occurence, extract val from "var,val"
	return occurences.get(0).split(" ,")[1]
}

// Retrieve the program file content
def program_file_path_from_dataspace = variables.get("program_file_path_from_dataspace")
program_file = new File(localspace, program_file_path_from_dataspace)
program_file_content = program_file.text


// Retrieve the formulas
def task_id = variables.get("PA_TASK_REPLICATION")
def inputs = variables.get("inputs_" + task_id)


// For each formula
def pattern = null
def replacing_expression = ""
inputs.split(";").each { expr ->

  	// Extract variable & value  from "variable=value"
    def expr_arr = expr.split("=")
  	def variable = expr_arr[0]
    def value = expr_arr[1]

	// Update the program file
	if (variable == "SS")
	{
      	pattern = Pattern.compile("SPINDL/RPM,.*")
        replacing_expression = "SPINDL/RPM," + value + ",CLW"
    }
	else if (variable == "FR")
	{
		pattern = Pattern.compile("FEDRAT/MMPM,.*")
        replacing_expression = "FEDRAT/MMPM," + value
    }

	// Replace all variables in the program file
	program_file_content = program_file_content.replaceAll(pattern, replacing_expression)
}


// Save the updated program file
def optimization_index = variables.get("optimization_index")
def current_time = variables.get("current_time")
def current_time_dir = new File(localspace, current_time)
def iter_dir = new File(current_time_dir, "iter_" + optimization_index)
iter_dir.mkdirs()
new File(iter_dir, task_id + "_" + program_file_path_from_dataspace).text = program_file_content


println "... Update_program_file"
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"></controlFlow>
      <outputFiles>
        <files  includes="$current_time/iter_$optimization_index/**" accessMode="transferToUserSpace"/>
      </outputFiles>
    </task>
    <task name="MACHpro" >
      <variables>
        <variable name="machpro_exe_file_path" value="C:/Program Files/MACHpro/MACHpro.exe" inherited="false" />
      </variables>
      <genericInformation>
        <info name="REQUIRED_LICENSES" value="machpro"/>
      </genericInformation>
      <depends>
        <task ref="Update_program_file"/>
      </depends>
      <inputFiles>
        <files  includes="$current_time/iter_$optimization_index/$PA_TASK_REPLICATION_$program_file_path_from_dataspace" accessMode="transferFromUserSpace"/>
        <files  includes="$VMSCMD_file_path_from_dataspace" accessMode="transferFromUserSpace"/>
      </inputFiles>
      <selection>
        <script type="dynamic">
          <code language="groovy">
            <![CDATA[
def machpro_exe_file_path = variables.get("machpro_exe_file_path")
selected = new File(machpro_exe_file_path).exists()
]]>
          </code>
        </script>
      </selection>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.apache.commons.io.FilenameUtils
import org.apache.commons.io.FileUtils

println "MACHpro ..."


// Retrieve variables
def VMSCMD_file_path_from_dataspace = variables.get("VMSCMD_file_path_from_dataspace")
def program_file_path_from_dataspace = variables.get("program_file_path_from_dataspace")
def task_id = variables.get("PA_TASK_REPLICATION")
def optimization_index = variables.get("optimization_index")
def current_time = variables.get("current_time")

// Deduce some variables
def current_time_dir = new File(localspace, current_time)
def iter_dir = new File(current_time_dir, "iter_" + optimization_index)

// Update the vmscmd file ...
// VMSCMD file -> tree
def VMSCMD_file = new File(localspace, VMSCMD_file_path_from_dataspace)
def VMSCMD_tree = new XmlParser().parse(VMSCMD_file)
// Modify the VMSCMD tree
def updated_program_file_path = new File(iter_dir, task_id + "_" + program_file_path_from_dataspace).absolutePath
VMSCMD_tree.NCPrograms.NCProgram[0].@File = updated_program_file_path
// Modify the output file paths
VMSCMD_tree.GetOps.ProcessSimulation.Export.@Folder = iter_dir.absolutePath
// VMSCMD_tree.GetOps.ProcessOptimization.Export.@Folder = iter_dir.absolutePath
// VMSCMD tree -> file
def fw = new FileWriter(VMSCMD_file)
def pw = new PrintWriter(fw)
new XmlNodePrinter(pw).print(VMSCMD_tree)
pw.close()
fw.close()

// Command execution
def machpro_exe_file_path = "\"" + variables.get("machpro_exe_file_path") + "\""
def VMSCMD_file_path = "\"" + VMSCMD_file.absolutePath + "\""
def cmd = [machpro_exe_file_path, VMSCMD_file_path, "nogui"]
println cmd + " ..."
cmd.execute().waitForProcessOutput(System.out, System.err)
println "... " + cmd

// Create a filter for val files
def val_file_filter = new FileFilter() {
	boolean accept(File file) {
		return FilenameUtils.getExtension(file.name) == "val"
	}
}

// Wait for the output val files (must be adapted to the number of generated val files)
while (iter_dir.listFiles(val_file_filter).length == 0) {
    sleep(10000)
    println "no val file"
}
println "val file detected"

// Rename val files before gathering the replicated tasks results into the same dir
iter_dir.listFiles(val_file_filter).each { file ->
	FileUtils.moveFile(file, new File(iter_dir, task_id + "_" + file.name))
}


println "... MACHpro"
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end"></controlFlow>
      <outputFiles>
        <files  includes="$current_time/iter_$optimization_index/**" accessMode="transferToUserSpace"/>
      </outputFiles>
    </task>
    <task name="R_Optimization" >
      <depends>
        <task ref="MACHpro"/>
      </depends>
      <inputFiles>
        <files  includes="$current_time/iter_$optimization_index/**" accessMode="transferFromUserSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="R">
            <![CDATA[
# install.packages("XML")
library("XML")


print("R_Optimization ...")


# FUNCTIONS ##########################

# Integer to bit vector
intToBitVect <- function(x){
  tmp <- rev(as.integer(intToBits(x)))
  id <- seq_len(match(1,tmp,length(tmp))-1)
  tmp[-id]
}

# Bit vector to integer
bitVectToInt <- function(binaryvector) {
  sum(2^(which(rev(binaryvector)==TRUE)-1))
}

random_bit_flipping <- function(bit_vec){
  selected_id <- sample(1:length(bit_vec),1)
  selected_bit <- bit_vec[selected_id]
  bit_vec[selected_id] <- (selected_bit + 1) %% 2
  bit_vec
}

probableMutate <- function(a, mutation_probability) {
  if (runif(n=1, min=0, max=1) < mutation_probability)
  {
    a_as_bit_vec <- intToBitVect(a)
	mutated_a_as_bit_vec <- random_bit_flipping(a_as_bit_vec)
	mutated_a <- bitVectToInt(mutated_a_as_bit_vec)
	mutated_a
  } else
  {
    a
  }
}

# Probable mutation of a in [a_min; a_max]
probableMutateInRange <- function(a, a_min, a_max, mutation_probability) {

  # print(paste("a", a, "a_min", a_min, "a_max", a_max, "mutation_probability", mutation_probability, sep= ' '))

  mutated_a <- probableMutate(a, mutation_probability)
  if (mutated_a >= a_min && mutated_a <= a_max)
	mutated_a
  else
    probableMutateInRange(a, a_min, a_max, mutation_probability)
}


# MAIN ##########################


print(variables["optimization_index"])
print(variables["time_weight"])
print(variables["mrr_weight"])
print(variables["energy_weight"])
print(variables["min_fitness_selection_rate"])
print(variables["mutation_probability"])
print(variables["nb_machpro_runs"])


# Retrieve variables
optimization_index <- as.integer(variables["optimization_index"])
time_weight <- as.double(variables["time_weight"])
mrr_weight <- as.double(variables["mrr_weight"])
energy_weight <- as.double(variables["energy_weight"])
min_fitness_selection_rate <- as.double(variables["min_fitness_selection_rate"])
nb_machpro_runs <- as.integer(variables["nb_machpro_runs"])
current_time <- variables["current_time"]
mutation_probability <- variables["mutation_probability"]
SS_min <- as.integer(variables["SS_min"])
SS_max <- as.integer(variables["SS_max"])
FR_min <- as.integer(variables["FR_min"])
FR_max <- as.integer(variables["FR_max"])


# Create an empty data frame with header
results <- data.frame(SS=integer(0),
                      FR=integer(0),
                      mMRROrigConverted=double(0),
                      mTorqueMaxConverted=double(0),
                      mTimeOrig=double(0),
                      standardized_mMRROrigConverted=double(0),
                      standardized_mTorqueMaxConverted=double(0),
                      standardized_mTimeOrig=double(0))


# Retrieve val file names
iter_dir_path <- file.path(localspace, current_time, paste("iter_", optimization_index, sep=''))
val_file_names <- dir(iter_dir_path, pattern =".val")

# Retrieve the xml header file for data selection in each val file
key_file_name <- dir(iter_dir_path, pattern =".key")[1]
key_file_path = file.path(iter_dir_path, key_file_name)
header_xml <- xmlParse(file = key_file_path)
header_field_values <- xpathApply(header_xml, "//Field", xmlGetAttr, "Name")

# For each val file name
for(i in 1:length(val_file_names)){

  # OUTPUTS ########

  # Retrive each val file relative path
  print(paste("File parsed", val_file_names[i], sep=' '))
  val_file_path = file.path(iter_dir_path, val_file_names[i])

  # val file -> dataframe with header
  val_dataframe <- read.table(val_file_path, header=FALSE, sep="\t", stringsAsFactors=FALSE, dec=",")
  names(val_dataframe) = header_field_values

  # Append outputs columns
  sub_results = val_dataframe[,c("mMRROrigConverted","mTorqueMaxConverted","mTimeOrig")]

  # Append outputs sum and max columns
  sub_results$sum_mMRROrigConverted <- sum(val_dataframe[,"mMRROrigConverted"])
  sub_results$max_mTorqueMaxConverted <- max(val_dataframe[,"mTorqueMaxConverted"])
  sub_results$max_mTimeOrig <- max(val_dataframe[,"mTimeOrig"])

  # INPUTS ########

  # Retrieve the corresponding inputs
  inputs <- variables[paste(c("inputs_", i-1), collapse = "")]
  print(paste("inputs parsed", as.character(inputs), sep=' '))
  inputs_list <- strsplit(as.character(inputs), ";")
  SS_val <- strsplit(as.character(inputs_list[[1]][[1]]), "=")[[1]][[2]]
  FR_val <- strsplit(as.character(inputs_list[[1]][[2]]), "=")[[1]][[2]]

  # Append inputs to sub_results
  sub_results$SS <- as.integer(SS_val)
  sub_results$FR <- as.integer(FR_val)


  # RESULTS += SUB_RESULTS ########
  results <- rbind(results, sub_results)
}

# Standardize outputs
results$standardized_mMRROrigConverted <- (results[,"mMRROrigConverted"] - mean(unique(results[,"sum_mMRROrigConverted"]))) / sd(unique(results[,"sum_mMRROrigConverted"]))
results$standardized_mTorqueMaxConverted <- (results[,"mTorqueMaxConverted"] - mean(unique(results[,"max_mTorqueMaxConverted"]))) / sd(unique(results[,"max_mTorqueMaxConverted"]))
results$standardized_mTimeOrig <- (results[,"mTimeOrig"] - mean(unique(results[,"max_mTimeOrig"]))) / sd(unique(results[,"max_mTimeOrig"]))

# Compute the fitness coeff
results$fitness <- mrr_weight * results$standardized_mMRROrigConverted + energy_weight * results$standardized_mTorqueMaxConverted + time_weight * results$standardized_mTimeOrig

# Sort results by asc fitness
results <- results[order(results$fitness),]
print(paste("nb_rows after all rbind", nrow(results), sep= ' '))


# DEBUG
result_file_name <- paste('results_', optimization_index, '.ext', sep= '')
write.table(results, file=result_file_name)


# Select the min_fitness_selection_rate*100 first % of rows
nb_rows <- trunc (min_fitness_selection_rate * nrow(results))
if (nb_rows < 1)
  nb_rows <- 1
results <- head(results, nb_rows)
print(paste("nb_rows after selection", nb_rows, sep= ' '))


# Crossover of SS and FR
crossed_SS_FR <- data.frame(SS=integer(0), FR=integer(0))
if (nb_rows > 1)
{
	i <- 1
	j <- 2
	while (i < nb_rows) {
	  while (j <= nb_rows) {
		crossed_SS_FR <- rbind(crossed_SS_FR, data.frame(SS=results$SS[i], FR=results$FR[j]))
		crossed_SS_FR <- rbind(crossed_SS_FR, data.frame(SS=results$SS[j], FR=results$FR[i]))
		j <- j+1
	  }
	  i <- i+1
	  j <- i+1
	}
} else
{
  crossed_SS_FR <- data.frame(SS=results$SS[1], FR=results$FR[1])
}
nb_rows <- nrow(crossed_SS_FR)


# For each row, probable mutation on SS or FR
for (i in 1:nb_rows) {
  if (runif(n=1, min=0, max=1) < 0.5)
  {
    crossed_SS_FR[i,'SS'] <- probableMutateInRange(crossed_SS_FR[i,'SS'], SS_min, SS_max, mutation_probability)
  } else
  {
    crossed_SS_FR[i,'FR'] <- probableMutateInRange(crossed_SS_FR[i,'FR'], FR_min, FR_max, mutation_probability)
  }
}

# Remove duplicated SS and FR
if (nb_rows > 1)
{
  crossed_SS_FR <- crossed_SS_FR[!duplicated(crossed_SS_FR[,c('SS','FR')]),]
  nb_rows <- nrow(crossed_SS_FR)
  print(paste("nb_rows after removing duplicated", nb_rows, sep= ' '))
}


# Store SS and FR values
for(task_id in 0:(nb_rows-1))
{
   variables[ paste("inputs_", task_id, sep='') ] = paste("SS=", crossed_SS_FR[task_id+1, "SS"],";FR=", crossed_SS_FR[task_id+1, "FR"],sep='')
   print(variables[ paste("inputs_", task_id, sep='') ])
}

# Geenrate a plot
last_chart_file_path_from_dataspace <- file.path(current_time, paste("inputs_", optimization_index, ".png", sep=''))
last_chart_file_path <- file.path(localspace, last_chart_file_path_from_dataspace)
png(file = last_chart_file_path)
plot(crossed_SS_FR$SS, crossed_SS_FR$FR)
dev.off()

# Update some variables
variables["last_chart_file_path_from_dataspace"] = last_chart_file_path_from_dataspace
variables["optimization_index"] = as.integer(optimization_index + 1)
variables["nb_machpro_runs"] = nb_rows


print("... R_Optimization")
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow  block="end">
        <loop target="Expose_new_inputs">
          <script>
            <code language="groovy">
              <![CDATA[
def nb_optim_iterations = variables.get("nb_optim_iterations")  as Integer
def nb_machpro_runs = variables.get("nb_machpro_runs")  as Integer

if(nb_machpro_runs == 1 || nb_optim_iterations == 1)
	loop = false
else {
	variables["nb_optim_iterations"] = nb_optim_iterations - 1
	loop = true
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <outputFiles>
        <files  includes="*.ext" accessMode="transferToUserSpace"/>
        <files  includes="$last_chart_file_path_from_dataspace" accessMode="transferToUserSpace"/>
      </outputFiles>
    </task>
    <task name="Expose_results" >
      <depends>
        <task ref="R_Optimization"/>
      </depends>
      <inputFiles>
        <files  includes="$last_chart_file_path_from_dataspace" accessMode="transferFromUserSpace"/>
      </inputFiles>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.apache.commons.io.FileUtils

// Retrieve variables
def current_time = variables.get("current_time")
def last_chart_file_path_from_dataspace = variables.get("last_chart_file_path_from_dataspace")

// Expose it as a task output
def last_chart_file = new File(localspace, last_chart_file_path_from_dataspace)
result = last_chart_file.getBytes()
resultMetadata.put("file.name", last_chart_file_path_from_dataspace)
resultMetadata.put("content.type", "image/png")

// And save it into a specific dir
def dest_dir = new File(new File(localspace, "MC_OPTIM"), current_time)
dest_dir.mkdirs()
FileUtils.moveFileToDirectory(last_chart_file, dest_dir, false)
]]>
          </code>
        </script>
      </scriptExecutable>
      <outputFiles>
        <files  includes="MC_OPTIM/**" accessMode="transferToUserSpace"/>
      </outputFiles>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html><head><link rel="stylesheet" href="/studio/styles/studio-standalone.css"><style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:1122px;
            height:915px;
            }
        </style></head><body><div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-108px;left:-479.5px"><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" id="jsPlumb_1_1698" style="top: 113px; left: 528.5px;"><a class="task-name"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Random_inputs</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1701" style="top: 239px; left: 528.5px;"><a class="task-name"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Expose_new_inputs</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1704" style="top: 365px; left: 484.5px;"><a class="task-name"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">useless1</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1707" style="top: 491px; left: 484.5px;"><a class="task-name"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Update_program_file</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1710" style="top: 615px; left: 484.5px;"><a class="task-name"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">MACHpro</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1713" style="top: 739px; left: 528.5px;"><a class="task-name"><img src="/studio/images/R.png" width="20px">&nbsp;<span class="name">R_Optimization</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_1716" style="top: 865px; left: 528.5px;"><a class="task-name"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Expose_results</span></a></div><svg style="position:absolute;left:571px;top:152.5px" width="30.5" height="87" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 9.5 86 C 19.5 36 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M11.544328125,64.94400000000002 L15.38276948225169,44.104941289325495 L9.389619497793696,51.11080692205006 L1.54957640430173,46.2596499165318 L11.544328125,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M11.544328125,64.94400000000002 L15.38276948225169,44.104941289325495 L9.389619497793696,51.11080692205006 L1.54957640430173,46.2596499165318 L11.544328125,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:524.5px;top:278.5px" width="77" height="87" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 86 C -10 36 66 50 56 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M2.943999999999998,62.656000000000006 L21.21048283237332,51.91655844400601 L11.991104500171751,51.97190433574409 L10.526387168117406,42.86945394383425 L2.943999999999998,62.656000000000006" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M2.943999999999998,62.656000000000006 L21.21048283237332,51.91655844400601 L11.991104500171751,51.97190433574409 L10.526387168117406,42.86945394383425 L2.943999999999998,62.656000000000006" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:554.5px;top:394.5px" width="43.39999999999998" height="97" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 22.399999999999977 86 C 32.39999999999998 86 -10 -10 0 0 " transform="translate(10.5,10.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#e5db3d" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M22.846535099999983,75.63705525 L24.318928383989608,54.498652802859816 L19.15100431981592,62.13360931006629 L10.815482444055897,58.19418358304387 L22.846535099999983,75.63705525" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(10.5,10.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M22.846535099999983,75.63705525 L24.318928383989608,54.498652802859816 L19.15100431981592,62.13360931006629 L10.815482444055897,58.19418358304387 L22.846535099999983,75.63705525" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(10.5,10.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_1730" style="position: absolute; transform: translate(-50%, -50%); left: 575.7px; top: 443.75px;">replicate</div><svg style="position:absolute;left:524.5px;top:404.5px" width="35" height="87" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 14 86 C 24 36 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M15.679124999999999,64.94400000000002 L18.30426063415665,43.91761983359284 L12.726903889211487,51.25881127229097 L4.619071906447603,46.86984094438135 L15.679124999999999,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M15.679124999999999,64.94400000000002 L18.30426063415665,43.91761983359284 L12.726903889211487,51.25881127229097 L4.619071906447603,46.86984094438135 L15.679124999999999,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:524.5px;top:530.5px" width="35" height="85" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 84 C -10 34 24 50 14 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M-1.6791250000000004,63.10631250000001 L9.482629641241447,45.094781934034074 L1.3501874812537715,49.43798173538504 L-4.185701123373526,42.065469452780306 L-1.6791250000000004,63.10631250000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M-1.6791250000000004,63.10631250000001 L9.482629641241447,45.094781934034074 L1.3501874812537715,49.43798173538504 L-4.185701123373526,42.065469452780306 L-1.6791250000000004,63.10631250000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:524.5px;top:654.5px" width="66.5" height="85" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 45.5 84 C 55.5 34 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M44.059059000000005,61.742412000000016 L38.44347289747064,41.31044702535602 L36.097596469435786,50.22654840344669 L26.92760930091732,49.27190955592024 L44.059059000000005,61.742412000000016" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M44.059059000000005,61.742412000000016 L38.44347289747064,41.31044702535602 L36.097596469435786,50.22654840344669 L26.92760930091732,49.27190955592024 L44.059059000000005,61.742412000000016" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:621.5px;top:278.5px" width="42" height="461" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 21 0 C 31 50 -10 410 0 460 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M19.643904000000003,101.30176000000003 L25.394593778417494,121.69611135208781 L18.778751896330284,115.27500271017708 L11.421351068240455,120.8309592484181 L19.643904000000003,101.30176000000003" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M19.643904000000003,101.30176000000003 L25.394593778417494,121.69611135208781 L18.778751896330284,115.27500271017708 L11.421351068240455,120.8309592484181 L19.643904000000003,101.30176000000003" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_1745" style="position: absolute; transform: translate(-50%, -50%); left: 642px; top: 508.5px;">loop</div><svg style="position:absolute;left:565.4783554952701px;top:778.5px" width="15.521644504729927" height="87" pointer-events="none" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 86 C -10 36 -10 50 0 0 " transform="translate(15.021644504729927,0.5)" pointer-events="visibleStroke" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M-4.331249999999999,64.94400000000002 L-1.2792764656232984,43.975321988607305 L-7.004697339623629,51.20163196089339 L-15.021644504729927,46.64876932823094 L-4.331249999999999,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(15.021644504729927,0.5)"></path><path pointer-events="all" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" d="M-4.331249999999999,64.94400000000002 L-1.2792764656232984,43.975321988607305 L-7.004697339623629,51.20163196089339 L-15.021644504729927,46.64876932823094 L-4.331249999999999,64.94400000000002" class="" stroke="#666" fill="#666" transform="translate(15.021644504729927,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 571.5px; top: 143px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 581px; top: 269px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 581px; top: 229px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 643px; top: 269px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 525px; top: 395px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 525px; top: 355px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint replicate-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 555px; top: 395px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 539px; top: 521px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint replicate-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 577.4px; top: 481px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 539px; top: 481px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 525px; top: 645px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 525px; top: 605px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 570.5px; top: 769px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 570.5px; top: 729px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 622px; top: 729px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 570.5px; top: 895px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 570.5px; top: 855px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
      xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div></body></html>
 ]]>
    </visualization>
  </metadata>
</job>