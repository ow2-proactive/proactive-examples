<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<job xmlns="urn:proactive:jobdescriptor:3.14" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" maxNumberOfExecution="2" name="MLOps_Drift_Notification_Workflow" onTaskError="continueJobExecution" priority="normal" projectName="3. MLOps Model Server Workflows" tags="MLOps,Drift Detection,Notifications,Monitoring" xsi:schemaLocation="urn:proactive:jobdescriptor:3.14 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.14/schedulerjob.xsd">
  <variables>
    <variable advanced="false" description="The MLOps Dashboard instance that need to be monitored." hidden="false" model="PA:MODEL_FROM_URL(${PA_SCHEDULER_REST_PUBLIC_URL}/rm/model/tokens?name=PSA_mlops-dashboard.*)" name="MLOPS_DASHBOARD_INSTANCE" value=""/>
    <variable advanced="false" description="It includes the global metrics and other performance indicators of the MLOps Dashboard, as it pertains to the ML models themselves, encompassing aspects such as model performance, accuracy, and fairness, which are continually assessed for any deviations from desired behavior." hidden="false" model="PA:LIST(Global, Per Model Server, Per Deployed Model)" name="MONITORING_SCOPE" value="Global"/>
    <variable advanced="false" description="The temporal scope for the chosen drift detection algorithm, intended to encompass a particular historical period for analysis." hidden="false" model="PA:LIST(Last 5 minutes, Last 15 minutes, Last 30 minutes, Last 1 hour, Last 3 hours, Last 9 hours, Last 24 hours, Last 2 days, Last 7 days, Last 15 days, Last 30 days)" name="TIME_FRAME" value="Last 5 minutes"/>
    <variable advanced="false" description="ID of the model server that need to be monitored." hidden="true" model="PA:INTEGER" name="MODEL_SERVER_ID" value="-1"/>
    <variable advanced="false" description="Name of the model that need to be monitored." hidden="true" model="PA:NOT_EMPTY_STRING" name="MODEL_NAME" value="simple"/>
    <variable advanced="false" hidden="true" model="PA:SPEL(variables['MONITORING_SCOPE'].toLowerCase() == 'per model server' ? showVar('MODEL_SERVER_ID') : hideVar('MODEL_SERVER_ID'))" name="PER_MODEL_SERVER_HANDLER" value=""/>
    <variable advanced="false" hidden="true" model="PA:SPEL(variables['MONITORING_SCOPE'].toLowerCase() == 'per deployed model' ? showVar('MODEL_SERVER_ID') &amp;&amp; showVar('MODEL_NAME') : hideVar('MODEL_NAME'))" name="PER_MODEL_HANDLER" value=""/>
    <variable advanced="false" description="Name of the data drift detector to be used in the drift detection process." model="PA:LIST(Threshold based, Statistical threshold, HDDM_W, Page-Hinkley)" name="DRIFT_METHOD" value="HDDM_W"/>
    <variable description="Confidence level for drift detection. Default is 0.001." model="PA:DOUBLE" name="DRIFT_CONFIDENCE" value="0.001"/>
    <variable description="Confidence level for warning detection. Default is 0.005." model="PA:DOUBLE" name="WARNING_CONFIDENCE" value="0.005"/>
    <variable description="Minimum number of instances before detecting change. Default is 30." hidden="true" model="PA:INTEGER" name="MIN_INSTANCES" value="30"/>
    <variable description="Magnitude of change that will cause a signal. Default is 0.005." hidden="true" model="PA:DOUBLE" name="DELTA" value="0.005"/>
    <variable description="Threshold for the Page-Hinkley test. Default is 50." hidden="true" model="PA:INTEGER" name="THRESHOLD" value="50"/>
    <variable description="Forgetting factor, it determines the weight given to newer data. Default is 0.9999." hidden="true" model="PA:DOUBLE" name="ALPHA" value="0.9999"/>
    <variable description="The number of standard deviations to use as the cutoff. Default is 2." hidden="true" model="PA:INTEGER" name="STATISTICAL_THRESHOLD" value="2"/>
    <variable description="Key metrics to consider when monitoring model servers and ML models." model="PA:LIST(avg_inference_time_ms, inference_rate_per_min)" name="METRIC" value="avg_inference_time_ms"/>
    <variable description="It is used to determine whether a value meets a specified threshold." hidden="true" model="PA:SPEL(variables['DRIFT_METHOD'].toLowerCase() == 'threshold based' ? hideVar('MIN_INSTANCES') &amp;&amp; hideVar('DELTA') &amp;&amp; hideVar('THRESHOLD') &amp;&amp; hideVar('ALPHA') &amp;&amp; hideVar('DRIFT_CONFIDENCE') &amp;&amp; hideVar('WARNING_CONFIDENCE') &amp;&amp; hideVar('STATISTICAL_THRESHOLD') &amp;&amp; showVar('COMPARATOR') &amp;&amp; showVar('VALUE') : hideVar('COMPARATOR') &amp;&amp; hideVar('VALUE'))" name="METRIC_HANDLER" value=""/>
    <variable description="It is used to determine whether a value meets a specified threshold." hidden="true" model="PA:LIST(less than, less than or equal to, equal to, greater than or equal to, greater than)" name="COMPARATOR" value="less than"/>
    <variable description="When the performance metrics dosen't meet the predefined threshold value, a notification will be automatically generated. It may also involve taking various actions like retraining the model." hidden="true" model="PA:DOUBLE" name="VALUE" value="0"/>
    <variable advanced="false" description="The notification severity. Depending on the severity level, appropriate actions can be taken to address issues in a timely and effective manner." hidden="false" model="PA:LIST(INFO,WARNING,ERROR,CRITICAL)" name="SEVERITY" value="WARNING"/>
    <variable advanced="false" description="Comma-separated list of channels which will be notified." hidden="false" model="PA:NOT_EMPTY_STRING" name="CHANNELS" value="mlops_dashboard"/>
    <variable advanced="false" description="The notification message" hidden="true" model="PA:NOT_EMPTY_STRING" name="MESSAGE" value="This is a channel notification message"/>
    <variable advanced="false" hidden="true" model="PA:SPEL( variables['MONITORING_SCOPE'] == 'Global'  &amp;&amp; variables['DRIFT_METHOD'] == 'Threshold based' ? t(models['METRIC'] = variables['GLOBAL_METRICS']) : (variables['MONITORING_SCOPE'] == 'Per Model Server' &amp;&amp; variables['DRIFT_METHOD'] == 'Threshold based' ? t(models['METRIC'] = variables['PER_MODEL_SERVER_METRICS']) : (variables['MONITORING_SCOPE'] == 'Per Deployed Model' &amp;&amp; variables['DRIFT_METHOD'] == 'Threshold based' ? t(models['METRIC'] = variables['PER_DEPLOYED_MODEL_METRICS']) : variables['DRIFT_METHOD'] == 'HDDM_W' ? hideVar('STATISTICAL_THRESHOLD') &amp;&amp; showVar('DRIFT_CONFIDENCE') &amp;&amp; showVar('WARNING_CONFIDENCE') &amp;&amp; t(models['METRIC'] = variables['DRIFT_DETECTION_METRICS'])  : variables['DRIFT_METHOD'] == 'Page-Hinkley' ? hideVar('MIN_INSTANCES') &amp;&amp; hideVar('DELTA') &amp;&amp; hideVar('THRESHOLD') &amp;&amp; hideVar('ALPHA') &amp;&amp; hideVar('STATISTICAL_THRESHOLD') &amp;&amp; hideVar('DRIFT_CONFIDENCE') &amp;&amp; hideVar('WARNING_CONFIDENCE') &amp;&amp; showVar('MIN_INSTANCES') &amp;&amp; showVar('DELTA') &amp;&amp; showVar('THRESHOLD') &amp;&amp; showVar('ALPHA') &amp;&amp; t(models['METRIC'] = variables['DRIFT_DETECTION_METRICS']) : variables['DRIFT_METHOD'] == 'Statistical threshold' ? hideVar('MIN_INSTANCES') &amp;&amp; hideVar('DELTA') &amp;&amp; hideVar('THRESHOLD') &amp;&amp; hideVar('ALPHA') &amp;&amp; hideVar('DRIFT_CONFIDENCE') &amp;&amp; hideVar('WARNING_CONFIDENCE') &amp;&amp; showVar('STATISTICAL_THRESHOLD') &amp;&amp; t(models['METRIC'] = variables['DRIFT_DETECTION_METRICS']): true)) )" name="METRIC_LISTS" value=""/>
    <variable advanced="false" hidden="true" name="GLOBAL_METRICS" value="PA:LIST(avg_inference_time_ms, inference_rate_per_min)"/>
    <variable advanced="false" hidden="true" name="PER_MODEL_SERVER_METRICS" value="PA:LIST(avg_inference_time_ms, inference_rate_per_min)"/>
    <variable advanced="false" hidden="true" name="PER_DEPLOYED_MODEL_METRICS" value="PA:LIST(avg_inference_time_ms, inference_rate_per_min)"/>
    <variable advanced="false" hidden="true" name="DRIFT_DETECTION_METRICS" value="PA:LIST(avg_inference_time_ms, inference_rate_per_min)"/>
  </variables>
  <description>
    <![CDATA[ This workflow integrates drift detection algorithms to spot irregular and abnormal behavior on the MLOps Dashboard or within the deployed models. In line with this, users will receive notifications both in the MLOps Dashboard and the Automation Dashboard. ]]>
  </description>
  <genericInformation>
<info name="bucketName" value="ai-mlops-dashboard"/>
<info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/model_server.png"/>
<info name="Documentation" value="PAIO/PAIOUserGuide.html#_mlops_dashboard"/>
<info name="group" value="public-objects"/>
</genericInformation>
  <taskFlow>
    <task fork="true" name="Perform_Drift_Detection">
      <variables>
        <variable advanced="true" description="Container platform used for executing the workflow tasks." group="Container Parameters" hidden="false" inherited="false" model="PA:LIST(no-container,docker,podman,singularity)" name="CONTAINER_PLATFORM" value="docker"/>
        <variable advanced="true" description="Name of the container image being used to run the workflow tasks." group="Container Parameters" hidden="false" inherited="false" model="PA:LIST(docker://activeeon/driftdetection)" name="CONTAINER_IMAGE" value="docker://activeeon/driftdetection"/>
        <variable advanced="true" description="If True, containers will run based on images containing libraries that are compatible with GPU." group="Container Parameters" hidden="false" inherited="false" model="PA:Boolean" name="CONTAINER_GPU_ENABLED" value="false"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
        <info name="task.documentation" value="user/ProActiveUserGuide.html#_branch"/>
      </genericInformation>
      <forkEnvironment javaHome="/usr">
        <envScript>
          <script>
            <file language="groovy" url="${PA_CATALOG_REST_URL}/buckets/scripts/resources/fork_env_ai/raw"/>
          </script>
        </envScript>
      </forkEnvironment>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
import groovy.io.FileType
import com.google.common.base.Splitter;
import org.ow2.proactive.scheduler.common.job.JobVariable;
import groovy.json.JsonSlurper
import java.net.URL

def getMLOpsDashboardPrometheusEndpointUrl(String sessionid, String proactiveUrl, String mlopsDashboardToken, String instanceId) {
    // Define headers
    def headers = ['sessionid': sessionid]

    // Define base URL
    def baseUrl = "$proactiveUrl/cloud-automation-service/serviceInstances/active"

    // Create URL object
    def url = new URL(baseUrl)

    // Open connection
    def connection = url.openConnection()

    // Set headers
    headers.each { key, value ->
        connection.setRequestProperty(key, value)
    }

    // Get response
    def response = connection.getInputStream()

    // Parse JSON response
    def json = new JsonSlurper().parseText(response.text)
    // println "json: $json"
    
    //Get instance name given its id 
    def instance_name = ""
    if (instanceId != "-1") {
        instance_name = json.find{it.instance_id == instanceId.toInteger()}?.variables.INSTANCE_NAME
    }

    // Fetch MLOPS_ENDPOINT_ID
	def mlopsDashboardEndpointID = json.variables.find{ it.PSA_TOKEN == mlopsDashboardToken }?.ENDPOINT_ID
    // println "mlops endpoint id: $mlopsDashboardEndpointID"
    
    // Fetch MLOPS_DASHBOARD_URL & Get PROMETHEUS ENDPOINT URL
    def mlopsEndpointUrl = json.deployments.endpoint.flatten().find{ it.id.contains(mlopsDashboardEndpointID) }?.url
    println "mlopsEndpointUrl: $mlopsEndpointUrl"
    
    def prometheusEndpointUrl = mlopsEndpointUrl.replace("dashboard", "prometheus")
    println "prometheusEndpointUrl: $prometheusEndpointUrl"
    
    return [prometheusEndpointUrl, instance_name]
}

// Usage example
schedulerapi.connect()
connectionInfo = schedulerapi.getConnectionInfo()
ciLogin = connectionInfo.getLogin()
ciPasswd = connectionInfo.getPassword()
String ciUrl = connectionInfo.getUrl()
def sessionId = schedulerapi.getSession()

user_credentials = [
    sessionId: sessionId,
    ciLogin: ciLogin,
    ciPasswd: ciPasswd,
    ciUrl: ciUrl
]

def url = new URL(ciUrl)
def proactiveUrl = url.getProtocol() + "://" + url.getHost() + ":" + url.getPort()
def mlopsDashboardToken = variables.get("MLOPS_DASHBOARD_INSTANCE")

println "mlopsDashboardToken: $mlopsDashboardToken"

def instanceId = variables.get("MODEL_SERVER_ID")
println "MODEL_SERVER_ID: $instanceId"

results = getMLOpsDashboardPrometheusEndpointUrl(sessionId, proactiveUrl, mlopsDashboardToken, instanceId)
println "results: $results"
prometheusEndpointUrl = results[0]
println "prometheusEndpointUrl: $prometheusEndpointUrl"

instanceName = results[1]

variables.put("PROMETHEUS_ENDPOINT_URL", prometheusEndpointUrl)
variables.put("INSTANCE_NAME", instanceName)
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
import numpy as np
import pandas as pd

from datetime import datetime, timedelta
from prometheus_api_client import PrometheusConnect

__file__ = variables.get("PA_TASK_NAME")
print("BEGIN " + __file__)

MLOPS_DASHBOARD_INSTANCE = variables.get('MLOPS_DASHBOARD_INSTANCE')
PROMETHEUS_ENDPOINT_URL = variables.get('PROMETHEUS_ENDPOINT_URL')
MONITORING_SCOPE = variables.get('MONITORING_SCOPE')
TIME_FRAME = variables.get('TIME_FRAME')
MODEL_SERVER_ID = variables.get('MODEL_SERVER_ID')
INSTANCE_NAME = variables.get('INSTANCE_NAME')
MODEL_NAME = variables.get('MODEL_NAME')
METRIC = variables.get('METRIC')
SEVERITY = variables.get('SEVERITY')
DRIFT_METHOD = variables.get('DRIFT_METHOD')
DRIFT_CONFIDENCE = variables.get('DRIFT_CONFIDENCE')
WARNING_CONFIDENCE = variables.get('WARNING_CONFIDENCE')
MIN_INSTANCES = variables.get('MIN_INSTANCES')
DELTA = variables.get('DELTA')
THRESHOLD = variables.get('THRESHOLD')
ALPHA = variables.get('ALPHA')
STATISTICAL_THRESHOLD = variables.get('STATISTICAL_THRESHOLD')
COMPARATOR = variables.get('COMPARATOR')
VALUE = variables.get('VALUE')

print(f'{MLOPS_DASHBOARD_INSTANCE=}')
print(f'{PROMETHEUS_ENDPOINT_URL=}')
print(f'{MONITORING_SCOPE=}')
print(f'{TIME_FRAME=}')
print(f'{MODEL_SERVER_ID=}')
print(f'{INSTANCE_NAME=}')
print(f'{MODEL_NAME=}')
print(f'{METRIC=}')
print(f'{SEVERITY=}')
print(f'{DRIFT_METHOD=}')
print(f'{DRIFT_CONFIDENCE=}')
print(f'{WARNING_CONFIDENCE=}')
print(f'{MIN_INSTANCES=}')
print(f'{DELTA=}')
print(f'{THRESHOLD=}')
print(f'{ALPHA=}')
print(f'{STATISTICAL_THRESHOLD=}')
print(f'{COMPARATOR=}')
print(f'{VALUE=}')

timeframe = {
    'Last 5 minutes':  ['5',  'minutes'],
    'Last 15 minutes': ['15', 'minutes'],
    'Last 30 minutes': ['30', 'minutes'], 
    'Last 1 hour':   ['1', 'hours'], 
    'Last 3 hours':  ['3', 'hours'], 
    'Last 9 hours':  ['9', 'hours'], 
    'Last 24 hours': ['1', 'days'], 
    'Last 2 days':  ['2',  'days'], 
    'Last 7 days':  ['7',  'days'],
    'Last 5 days':  ['5',  'days'], 
    'Last 30 days': ['30', 'days'],
}

# Define metric queries
global_metric_queries = {
    'avg_inference_time_ms': '(avg(rate(nv_inference_compute_infer_duration_us{job="triton"}[1m])!=0))/1000',
    'inference_rate_per_min': '(avg(rate(nv_inference_count{job="triton"}[1m])*60!= 0))'
}

per_model_server_metric_queries = {
    'avg_inference_time_ms': '(avg(rate(nv_inference_compute_infer_duration_us{job="triton", instance_name="'+INSTANCE_NAME+'"}[1m])!=0))/1000',
    'inference_rate_per_min': '(avg(rate(nv_inference_count{job="triton", instance_name="'+INSTANCE_NAME+'"}[1m])*60!= 0))'
}

per_deployed_model_metric_queries = {
    'avg_inference_time_ms': '(avg(rate(nv_inference_compute_infer_duration_us{job="triton", instance_name="'+INSTANCE_NAME+'", model="'+MODEL_NAME+'"}[1m])!=0))/1000',
    'inference_rate_per_min': '(avg(rate(nv_inference_count{job="triton", instance_name="'+INSTANCE_NAME+'", model="'+MODEL_NAME+'"}[1m])*60!= 0))'
}

def query_prometheus(prometheus_url, promql_query, timeframe):
    # Create a PrometheusConnect object
    prom = PrometheusConnect(url=prometheus_url)
    # Define the time range
    end_time = datetime.now()
    if timeframe[1] == 'minutes':
        start_time = end_time - timedelta(minutes = int(timeframe[0]))
    elif timeframe[1] == 'hours':
        start_time = end_time - timedelta(hours = int(timeframe[0]))
    elif timeframe[1] == 'days':
        start_time = end_time - timedelta(days = int(timeframe[0]))
    # Print the PromQL query
    print(f'{promql_query=}')
    # Execute the query with the time range
    result = prom.custom_query_range(promql_query, start_time, end_time, step="1m")
    # Print the result
    # for time_series in result:
    #     # metric = time_series['metric']
    #     values = time_series['values']
    #     formatted_values = [(datetime.utcfromtimestamp(value[0]).strftime('%Y-%m-%d %H:%M:%S'), value[1]) for value in values]
    #     print(f"{formatted_values}")
    # Add an if statement to check whether the variable result isn't empty
    time_series = result[0]
    time_series = time_series['values']
    for cols in time_series:
        metric_timestamp = datetime.utcfromtimestamp(cols[0]).strftime('%Y-%m-%d %H:%M:%S')
        metric_value = float(cols[1])
        print(f"{metric_timestamp} {metric_value}")
    metric_vector = [(datetime.utcfromtimestamp(cols[0]).strftime('%Y-%m-%d %H:%M:%S'), cols[1]) for cols in time_series]
    metric_timestamp_vector = [datetime.utcfromtimestamp(cols[0]).strftime('%Y-%m-%d %H:%M:%S') for cols in time_series]
    metric_value_vector = [float(cols[1]) for cols in time_series]
    # print(f"\n{metric_timestamp_vector=}\n")
    # print(f"\n{metric_value_vector=}\n")
    return metric_vector, metric_timestamp_vector, metric_value_vector


###############################################
# OUTLIER DETECTION USING STATIC THRESHOLD
def detect_outliers_static_threshold(timestamps, values, comparator, threshold_value):
    """
    Detects outliers in the metric values based on the static comparison.
    :param timestamps: List of timestamps corresponding to the metric values.
    :param values: List of metric values.
    :param comparator: Type of comparison used as the cutoff.
    :param threshold_value: The threshold value used as the cutoff.
    :return: A list of tuples containing the timestamp and value of each outlier.
    """
    # Convert values to a numpy array
    values = np.array(values, dtype=np.float32)
    # Identify outliers
    outliers = []
    detected = False
    for timestamp, value in zip(timestamps, values):
        if comparator == 'less_than' and value < threshold_value:
            detected = True
        if comparator == 'less_or_equals_to' and value <= threshold_value:
            detected = True
        if comparator == 'equals_to' and value == threshold_value:
            detected = True
        if comparator == 'higher_or_equals_to' and value >= threshold_value:
            detected = True
        if comparator == 'higher_than' and value > threshold_value:
            detected = True
        if detected:
            print(f"[Static Threshold] Change detected in data stream at {timestamp}: {value}")
            outliers.append((timestamp, value))
            detected = False
    return outliers


###############################################
# OUTLIER DETECTION USING STATISTICAL THRESHOLD
def detect_outliers_statistic_threshold(timestamps, values, threshold):
    """
    Detects outliers in the metric values based on the standard deviation.
    :param timestamps: List of timestamps corresponding to the metric values.
    :param values: List of metric values.
    :param threshold: The number of standard deviations to use as the cutoff. Default is 2.
    :return: A list of tuples containing the timestamp and value of each outlier.
    """
    # Convert values to a numpy array and compute mean and standard deviation
    values = np.array(values, dtype=np.float32)
    mean = np.mean(values)
    std_dev = np.std(values)
    # Identify outliers
    outliers = []
    for timestamp, value in zip(timestamps, values):
        if abs(value - mean) > threshold * std_dev:
            print(f"[Statistical Threshold] Change detected in data stream at {timestamp}: {value}")
            outliers.append((timestamp, value))
    return outliers


######################################
# OUTLIER DETECTION USING PAGE HINKLEY
def detect_outliers_page_hinkley(timestamps, values, min_instances, delta, threshold, alpha):
    """
    Detects outliers in the metric values using the Page-Hinkley method.
    :param timestamps: List of timestamps corresponding to the metric values.
    :param values: List of metric values.
    :param min_instances: Minimum number of instances before detecting change. Default is 30.
    :param delta: Magnitude of change that will cause a signal. Default is 0.005.
    :param threshold: Threshold for the Page-Hinkley test. Default is 50.
    :param alpha: Forgetting factor, it determines the weight given to newer data. Default is 0.9999.
    :return: A list of tuples containing the timestamp and value of each outlier.
    """
    from skmultiflow.drift_detection import PageHinkley
    ph = PageHinkley(min_instances=min_instances, delta=delta, threshold=threshold, alpha=alpha)
    outliers = []
    for timestamp, value in zip(timestamps, values):
        ph.add_element(value)
        if ph.detected_change():
            print(f"[PageHinkley] Change detected in data stream at {timestamp}: {value}")
            outliers.append((timestamp, value))
    return outliers


#################################
# OUTLIER DETECTION USING HDDM_W
def detect_outliers_hddm_w(timestamps, values, drift_confidence, warning_confidence):
    """
    Detects outliers in the metric values using the HDDM_W method.
    :param timestamps: List of timestamps corresponding to the metric values.
    :param values: List of metric values.
    :param drift_confidence: Confidence level for drift detection. Default is 0.001.
    :param warning_confidence: Confidence level for warning detection. Default is 0.005.
    :return: A list of tuples containing the timestamp and value of each outlier.
    """
    from skmultiflow.drift_detection.hddm_w import HDDM_W
    hddm_w = HDDM_W(drift_confidence=drift_confidence, warning_confidence=warning_confidence)
    outliers = []
    for timestamp, value in zip(timestamps, values):
        hddm_w.add_element(value)
        if hddm_w.in_warning_zone:
            print(f"[HDDM_W] Warning zone detected at {timestamp}: {value}")
        if hddm_w.detected_change():
            print(f"[HDDM_W] Change detected in data stream at {timestamp}: {value}")
            outliers.append((timestamp, value))
    return outliers

# Get metrics from Prometheus
if MONITORING_SCOPE == 'Global':
    _, metric_timestamp_vector, metric_value_vector = query_prometheus(PROMETHEUS_ENDPOINT_URL, global_metric_queries[METRIC], timeframe[TIME_FRAME])
elif MONITORING_SCOPE == 'Per Model Server':
    _, metric_timestamp_vector, metric_value_vector = query_prometheus(PROMETHEUS_ENDPOINT_URL, per_model_server_metric_queries[METRIC], timeframe[TIME_FRAME])
else:
    _, metric_timestamp_vector, metric_value_vector = query_prometheus(PROMETHEUS_ENDPOINT_URL, per_deployed_model_metric_queries[METRIC], timeframe[TIME_FRAME])

outliers = []
# Apply drift detection method on the time series data
if DRIFT_METHOD == 'Threshold based':
    # Detect outliers using static threshold
    outliers = detect_outliers_static_threshold(metric_timestamp_vector, metric_value_vector, COMPARATOR, float(VALUE))
elif DRIFT_METHOD == 'Statistical threshold':
    # Detect outliers using statistical threshold
    outliers = detect_outliers_statistic_threshold(metric_timestamp_vector, metric_value_vector, float(STATISTICAL_THRESHOLD))
elif DRIFT_METHOD == 'HDDM_W':
    # Detect outliers using HDDM_W method
    outliers = detect_outliers_hddm_w(metric_timestamp_vector, metric_value_vector, float(DRIFT_CONFIDENCE), float(WARNING_CONFIDENCE))
elif DRIFT_METHOD == 'Page-Hinkley':
    # Detect outliers using Page-Hinkley method
    outliers = detect_outliers_page_hinkley(metric_timestamp_vector, metric_value_vector, float(MIN_INSTANCES), float(DELTA), float(THRESHOLD), float(ALPHA))

alert_message = ''
if outliers:
    for timestamp, value in outliers:
        alert_message += 'Outlier detected by '+str(DRIFT_METHOD)+': Timestamp = '+timestamp+', Value = '+str(value)+'.'
    print(f'{alert_message=}')

variables.put("MESSAGE", alert_message)
print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow>
        <if continuation="Continuation" else="Else" target="If_Drift_Detected">
          <script>
            <code language="groovy">
              <![CDATA[
def outliers = variables.get("MESSAGE")
println('START if')
println(outliers)
if (outliers) {
    branch = 'if'
} else {
    branch = 'else'
}
println('END if')
]]>
            </code>
          </script>
        </if>
      </controlFlow>
      <metadata>
        <positionTop>
            70.59375
        </positionTop>
        <positionLeft>
            482.84375
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="If_Drift_Detected">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
println("START: Drift Detected")
def alert_message = variables.get("MESSAGE")
println(alert_message)
variables.put("MESSAGE", alert_message)
println("END: Drift Detected")
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"/>
      <metadata>
        <positionTop>
            199
        </positionTop>
        <positionLeft>
            335.9375
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Else">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
println("Else")
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            199
        </positionTop>
        <positionLeft>
            482.84375
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Continuation">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
println("Continuation")
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            199
        </positionTop>
        <positionLeft>
            621.25
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="End">
      <description>
        <![CDATA[ The simplest task, ran by a Python engine. ]]>
      </description>
      <depends>
        <task ref="Channel_Notification"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
println("End")
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end"/>
      <metadata>
        <positionTop>
            453.796875
        </positionTop>
        <positionLeft>
            335.9375
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Channel_Notification">
      <description>
        <![CDATA[ A task that sends a notification with a custom message and severity to one or more notification channels ]]>
      </description>
      <variables>
        <variable advanced="false" description="The notification message" hidden="true" inherited="true" model="PA:NOT_EMPTY_STRING" name="MESSAGE" value="This is a channel notification message"/>
        <variable advanced="false" description="The notification severity. It can be one of &lt;b&gt;INFO&lt;/b&gt;,&lt;b&gt;WARNING&lt;/b&gt;,&lt;b&gt;ERROR&lt;/b&gt;,&lt;b&gt;CRITICAL&lt;/b&gt;" hidden="true" inherited="true" model="PA:LIST(INFO,WARNING,ERROR,CRITICAL)" name="SEVERITY" value="WARNING"/>
        <variable advanced="false" description="Comma-separated list of channels which will be notified." hidden="true" inherited="true" model="PA:NOT_EMPTY_STRING" name="CHANNELS" value="mlops_dashboard"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/web_notification.png"/>
        <info name="task.documentation" value="user/ProActiveUserGuide.html#channels_section"/>
      </genericInformation>
      <depends>
        <task ref="If_Drift_Detected"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.notification.client.ApiClient
import org.ow2.proactive.notification.client.api.EventRestApi
import org.ow2.proactive.notification.client.api.SubscriptionRestApi
import org.ow2.proactive.notification.client.api.ChannelRestApi
import org.ow2.proactive.notification.client.model.EventRequest
import org.ow2.proactive.notification.client.model.ChannelSubscriptionUpdate
import org.ow2.proactive.notification.client.model.ChannelSubscriptionUpdate.SubscriptionTypeEnum
import org.ow2.proactive.notification.client.model.ChannelRequest
import org.ow2.proactive.notification.client.model.ChannelSubscription
import org.ow2.proactive.notification.client.model.Subscription
import org.ow2.proactive.notification.client.model.NotificationMethod.TypeEnum
import org.ow2.proactive.notification.client.ApiException

import groovy.json.JsonBuilder
import groovy.json.JsonSlurper
import groovy.json.JsonOutput
import java.net.URL

def jobId = genericInformation.get("PARENT_JOB_ID") != null ? new Long(genericInformation.get("PARENT_JOB_ID")) : new Long(variables.get("PA_JOB_ID"))
def eventMessage = variables.get("MESSAGE")
def eventSeverity = variables.get("SEVERITY")
def channelsToNotify = variables.get("CHANNELS")

// Set channels to notify or exit immediately if none provided
channelsToNotify = (channelsToNotify != null && !channelsToNotify.equals('all')) ? Arrays.asList(channelsToNotify.split(',')): null;
if (channelsToNotify == null || channelsToNotify.isEmpty()) {
    println("No channel to be notified!")
    return
}

// Get notification-service URL
def paSchedulerRestUrl = variables.get('PA_SCHEDULER_REST_URL')
def notifUrl = paSchedulerRestUrl.replaceAll("/rest\\z", "/notification-service")

// Instantiate Notification REST clients
def apiClient = new ApiClient()
apiClient.setBasePath(notifUrl)
def eventRestApi = new EventRestApi(apiClient)
def subscriptionRestApi = new SubscriptionRestApi(apiClient)
def channelRestApi = new ChannelRestApi(apiClient)

// Set notification message
eventMessage = (eventMessage == null || eventMessage.isEmpty()) ? "You have a notification.": eventMessage;

// Set notification severity
eventSeverity = (eventSeverity == null || eventSeverity.isEmpty()) ? EventRequest.EventSeverityEnum.INFO: EventRequest.EventSeverityEnum.valueOf(eventSeverity);

// Get session id
schedulerapi.connect()
def sessionId = schedulerapi.getSession()

// Get proactive url
def connectionInfo = schedulerapi.getConnectionInfo()
String ciUrl = connectionInfo.getUrl()
def url = new URL(ciUrl)
def proactiveUrl = url.getProtocol() + "://" + url.getHost() + ":" + url.getPort()

// Function to create a channel
def createChannel(channelRestApi, String sessionId, String name, List userGroups) {
    println("About to create channel "+ name)
    def channelRequest = new ChannelRequest()
    	.name(name)
    	.userGroups(userGroups);
    try {
    	def result = channelRestApi.createChannel(channelRequest, sessionId)
    	println("Channel "+ name + " created")
        return result;
    } catch (ApiException e) {
        println("Error " + e.getCode() + " when creating channel "+ name)
        println e.getResponseBody();
        return;
    }
}

// Function to fetch available channels
def fetchAvailableChannels(channelRestApi, String sessionId) {
    println("About to retrieve available channels")
    try {
    	def result = channelRestApi.getUserAvailableChannels(sessionId)
    	println("Available channels successfully retrieved");
        return result;
    } catch (ApiException e) {
        println("Error " + e.getCode() + " when retrieving available channels")
        println e.getResponseBody();
        return;
    }
}

// Function to fetch available channels
// TODO when Notification client is updated, do directly eventRestApi.getUserAvailablehannels();
def fetchUserAlreadySubscribedChannels(String sessionId, String proactiveUrl) {
    // URL of the notification service
    def url = new URL("$proactiveUrl/notification-service/subscription/channel")
    
    // Open a connection to the URL
    def connection = url.openConnection()
    
    // Set the request method and properties analogous to the cURL headers
    connection.requestMethod = 'GET'
    connection.setRequestProperty('Accept', '*/*')
    connection.setRequestProperty('sessionid', sessionId)
    
    // Check the response code to determine if the request was successful
    if (connection.responseCode == 200) {
        // Read the response from the input stream
        def response = connection.inputStream.text.trim()
        // println("Response: $response")
        // return response
        def channelSubscription = new JsonSlurper().parseText(response)
        println "Already subscribed channels = "+ channelSubscription.channels
        return channelSubscription.channels;
    } else {
        // Handle the error response
        println("Failed to fetch channels. Response Code: ${connection.responseCode}")
        return null
    }
}

// Get available channels (JSON)
def availableChannels = fetchAvailableChannels(channelRestApi, sessionId)
println "availableChannels: $availableChannels"

// Check if the channel(s) exist(s), if not, create it
def channelsToSubscribe = new ArrayList();

for (channelToNotify in channelsToNotify) {
     def channelExists = availableChannels.find { it.name == channelToNotify }
     println("Found channel: $channelExists")
    if (channelExists == null) {
        println "Channel does not exist: $channelToNotify"
        def newChannel = createChannel(channelRestApi, sessionId, channelToNotify, ["allGroupsAuthorizedForChannel"]);
        channelsToSubscribe.add(newChannel)
    } else {
        channelsToSubscribe.add(channelExists)
    }
}

// This should always be true (checked at the start of script) , but lets keep it.
if (!channelsToSubscribe.isEmpty()) {
    println "Subscribing to channels "+ channelsToSubscribe;

    // Retrieve user's Channel Subscription
    Subscription userChannelSubscription = subscriptionRestApi.getChannelSubscription(sessionId);

    // Compute the new List of subscribed channels (previous subscribed channels + new channels)
    def newSubscribedChannels = new ArrayList();
    newSubscribedChannels.addAll(fetchUserAlreadySubscribedChannels(sessionId, proactiveUrl));
    newSubscribedChannels.addAll(channelsToSubscribe);
    
    // Create the update object that used to query the notif service
    def channelSubscriptionUpdate = new ChannelSubscriptionUpdate()
        .id(userChannelSubscription.id)
        .active(true) // Activate the subscription 
        .cleanPeriod(userChannelSubscription.cleanPeriod)
    
    // Activate the portal notification
    def portalNotification = userChannelSubscription.notificationMethods.find { it.getType() == TypeEnum.PORTAL }
	portalNotification.active = true
    
    channelSubscriptionUpdate.notificationMethods(userChannelSubscription.notificationMethods)
        .subscriptionType(SubscriptionTypeEnum.CHANNEL)
        .channels(newSubscribedChannels)
        .followedEvents(userChannelSubscription.followedEvents);
                          
    println "Update Channel Subscription"
    try {
        subscriptionRestApi.updateChannelSubscription(sessionId, channelSubscriptionUpdate);
    } catch (ApiException e) {
        println ("Error " + e.getCode() + " when update User's Channel Subscription. Please do it manually.")
        println ("You just need to add the channels to the subscription, activate the portal notification method and activate the subscription")
        println e.getResponseBody();
    }        
}

// Create event
println "Creating event that notifies channels "+ channelsToNotify
def eventRequest = new EventRequest()
        .bucketName(genericInformation.get("bucketName"))
        .workflowName(variables.get("PA_JOB_NAME"))
        .eventType(EventRequest.EventTypeEnum.CHANNEL)
        .eventSeverity(eventSeverity)
        .channelsToNotify(channelsToNotify)
        .jobId(jobId)
        .message(eventMessage);

try {
    result = eventRestApi.createEvent(sessionId, eventRequest).toString()
    println(result)
} catch (ApiException e) {
    System.err.println("Exception when calling EventRestApi#createEvent")
    e.printStackTrace();
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            327.390625
        </positionTop>
        <positionLeft>
            335.9375
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2364px;
            height:4884px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-65.59375px;left:-330.9375px"><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_39" style="top: 70.6px; left: 482.85px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Perform_Drift_Detection</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon" class="glyphicon glyphicon-list-alt"></i></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_42" style="top: 199px; left: 335.95px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">If_Drift_Detected</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_45" style="top: 199px; left: 482.85px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Else</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_48" style="top: 199px; left: 621.25px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Continuation</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_51" style="top: 453.8px; left: 335.95px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="The simplest task, ran by a Python engine."><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">End</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_54" style="top: 327.4px; left: 335.95px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task that sends a notification with a custom message and severity to one or more notification channels"><img src="/automation-dashboard/styles/patterns/img/wf-icons/web_notification.png" width="20px">&nbsp;<span class="name">Channel_Notification</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><svg style="position:absolute;left:325.5px;top:110.5px" width="168" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 157 50 147 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M19.317306749999997,60.59109050000001 L40.46362217334927,59.23708015431549 L32.20878849757397,55.13126464636996 L35.00379631971922,46.345598406741516 L19.317306749999997,60.59109050000001" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M19.317306749999997,60.59109050000001 L40.46362217334927,59.23708015431549 L32.20878849757397,55.13126464636996 L35.00379631971922,46.345598406741516 L19.317306749999997,60.59109050000001" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_62" style="position: absolute; transform: translate(-50%, -50%); left: 409px; top: 154.5px;">if</div><svg style="position:absolute;left:467.98171321138256px;top:110.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#00f" fill="#00f" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#00f" fill="#00f" transform="translate(15.018286788617468,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_66" style="position: absolute; transform: translate(-50%, -50%); left: 475px; top: 154.5px;">else</div><svg style="position:absolute;left:472.5px;top:110.5px" width="159" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 138 88 C 148 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M120.038658,60.59109050000001 L104.67550542211094,45.997477415211826 L107.2728299284673,54.843601165684724 L98.92801608779567,58.76330548674452 L120.038658,60.59109050000001" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M120.038658,60.59109050000001 L104.67550542211094,45.997477415211826 L107.2728299284673,54.843601165684724 L98.92801608779567,58.76330548674452 L120.038658,60.59109050000001" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_70" style="position: absolute; transform: translate(-50%, -50%); left: 551.5px; top: 154.5px;">continuation</div><svg style="position:absolute;left:375.5px;top:366.5px" width="37.5" height="88" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 87 C -10 37 26.5 50 16.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.4225760000000007,65.388768 L10.255522775434093,47.70764787170483 L2.000849132624986,51.81378511377463 L-3.3194601107912747,44.284222739079844 L-1.4225760000000007,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.4225760000000007,65.388768 L10.255522775434093,47.70764787170483 L2.000849132624986,51.81378511377463 L-3.3194601107912747,44.284222739079844 L-1.4225760000000007,65.388768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:383px;top:238.5px" width="30" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 9 88 C 19 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M11.064096,66.303232 L15.016942635045325,45.485571144855605 L8.985401777301874,52.45841237934327 L1.1721230143885997,47.56426536755374 L11.064096,66.303232" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M11.064096,66.303232 L15.016942635045325,45.485571144855605 L8.985401777301874,52.45841237934327 L1.1721230143885997,47.56426536755374 L11.064096,66.303232" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 547px; top: 101px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint if-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 473px; top: 101px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 383.5px; top: 229px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 326px; top: 189px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 523px; top: 229px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 473px; top: 189px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 661px; top: 229px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 611px; top: 189px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 376px; top: 484px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 376px; top: 444px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 392.5px; top: 357px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 392.5px; top: 317px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>
