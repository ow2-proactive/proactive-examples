<?xml version="1.0" encoding="UTF-8"?>
<job
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="urn:proactive:jobdescriptor:3.14" xsi:schemaLocation="urn:proactive:jobdescriptor:3.14 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.14/schedulerjob.xsd"  name="Molecular_Dynamics_Simulation" projectName="1. Molecular Dynamics Workflows" tags="bioscience,hpc" priority="normal" onTaskError="continueJobExecution"  maxNumberOfExecution="1"  >
  <variables>
    <variable name="MOLECULE_PROCESSING_STEPS" value="hpc-bioscience/Lysozyme_in_Water_Steps_Short" model="PA:CATALOG_OBJECT" description="CSV file that contains the molecule processing steps (i.e., Gromacs commands)" group="Bioscience Molecule Parameters" advanced="false" hidden="false"/>
    <variable name="BIOSCIENCE_WORKSPACE" value="BioScience-Workspace/Lysozyme-in-Water" model="PA:GLOBAL_FOLDER" description="Name of a folder in the Global Dataspace used to store the input/output files of the current experiment" group="Bioscience Molecule Parameters" advanced="false" hidden="false"/>
    <variable name="BIOSCIENCE_EXECUTION_TAG" value="Lysozyme-in-Water-Cubic-Box-${PA_JOB_ID}" model="PA:NOT_EMPTY_STRING" description="Tag used to identify the current experiment" group="Bioscience Molecule Parameters" advanced="false" hidden="false"/>
    <variable name="PROCESSING_STEPS" value="hpc-bioscience/resources/Lysozyme_in_Water_Steps_Short" model="PA:SPEL(t(variables[&#x27;PROCESSING_STEPS&#x27;] = variables[&#x27;MOLECULE_PROCESSING_STEPS&#x27;].replace(&quot;/&quot;,&quot;/resources/&quot;)))"   advanced="false" hidden="true"/>
    <variable name="EMAIL_RECIPIENT" value="usera.bioscience@gmail.com" model="PA:NOT_EMPTY_STRING" description="Recipient Email that will receive notifications about the experiment progress" group="Notification Parameters" advanced="false" hidden="false"/>
    <variable name="NATIVE_SCHEDULER" value="" description="Name of the native scheduler (if any) that will execute the current experiment" group="Runtime Parameters" advanced="true" hidden="false"/>
    <variable name="NATIVE_SCHEDULER_PARAMS" value=""  description="Parameters to be passed to the native scheduler (if any) that will execute the current experiment" group="Runtime Parameters" advanced="true" hidden="false"/>
    <variable name="CONTAINER_RUNTIME" value="Docker" model="PA:LIST(Docker,Singularity)" description="Container engine used to deploy molecular dynamics applications such as Gromacs and VMD" group="Runtime Parameters" advanced="true" hidden="false"/>
    <variable name="GROMACS_CONTAINER_IMAGE" value="gromacs/gromacs:gmx-2020.3-cuda-10.2" model="PA:LIST(nvcr.io/hpc/gromacs:2021,gromacs/gromacs:gmx-2020.3-cuda-10.2)" description="Container image used to deploy the Gromacs application" group="Runtime Parameters" advanced="true" hidden="false"/>
    <variable name="VMD_CONTAINER_IMAGE" value="activeeon/vmd" model="PA:LIST(activeeon/vmd-gpu, activeeon/vmd)" description="Container image used to deploy the VMD application" group="Runtime Parameters" advanced="true" hidden="false"/>
  </variables>
  <description>
    <![CDATA[ This workflow allows bioscientists to transform molecules and run simulations. It performs the following:
(i) Visualize the molecule structure using the viewing program VMD.
(ii) Use Gromacs to carry out the molecule transformations. The resulting files are placed in the user dataspace.
(iii) Send an email and web notifications to the user after each step of the molecule processing. ]]>
  </description>
  <genericInformation>
    <info name="bucketName" value="hpc-bioscience"/>
    <info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/bioscience.png"/>
    <info name="Documentation" value="http://www.mdtutorials.com/gmx/index.html"/>
    <info name="group" value="public-objects"/>
  </genericInformation>
  <taskFlow>
    <task name="Parse_Molecule_Processing_Steps" maxNumberOfExecution="1"
    
    onTaskError="suspendTask" 
    
    
    fork="true">
      <genericInformation>
        <info name="DISABLE_PTK" value="true"/>
        <info name="PRE_SCRIPT_AS_FILE" value="molecule-processing-steps.csv"/>
      </genericInformation>
      <depends>
        <task ref="Start_Molecule_Processing"/>
      </depends>
      <pre>
        <script>
          <file url="${PA_CATALOG_REST_URL}/buckets/${PROCESSING_STEPS}/raw"></file>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
@Grab('com.xlson.groovycsv:groovycsv:1.3')
import static com.xlson.groovycsv.CsvParser.parseCsv

variables.put("GROMACS_ERROR","false")

def previousTasks = variables.get("PROCESSED_TASKS")

if(previousTasks == null ){
    previousTasks = new ArrayList()
}
 
def steps = parseCsv(new FileReader('molecule-processing-steps.csv'), separator: ';')
numberOfSteps = steps.size()


def CURRENT_TASK = null  

for(line in parseCsv(new FileReader('molecule-processing-steps.csv'), separator: ';')) {   

    if (!previousTasks.contains("$line.Step_ID".trim())){

            variables.put("CURRENT_STEP_ID" , "$line.Step_ID".trim())
            variables.put("CURRENT_STEP_COMMAND" , "$line.Command".trim())
            variables.put("CURRENT_STEP_OUTPUT_FILES" , "$line.Output_Files".trim())
            variables.put("CURRENT_STEP_NOTIFICATION" , "$line.Notification".trim().toLowerCase())
            variables.put("CURRENT_STEP_ACTION" , "$line.Action".trim().toLowerCase())
            
            CURRENT_TASK= variables.get("CURRENT_STEP_ID") 
            previousTasks.add(CURRENT_TASK)
			variables.put("PROCESSED_TASKS",previousTasks)
            break;
    }    
}

if (CURRENT_TASK == null ||  variables.get("CURRENT_STEP_ACTION")=="cancel"){
    variables.put("STOP_LOOP", true)
} else {
    variables.put("STOP_LOOP", false)
    println(variables.get("CURRENT_STEP_ID"))
    println(variables.get("CURRENT_STEP_COMMAND"))
    println(variables.get("CURRENT_STEP_OUTPUT_FILES"))
    println(variables.get("CURRENT_STEP_NOTIFICATION"))
    println(variables.get("CURRENT_STEP_ACTION"))
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"></controlFlow>
      <metadata>
        <positionTop>
            226
        </positionTop>
        <positionLeft>
            599.25
        </positionLeft>
      </metadata>
    </task>
    <task name="Start_Molecule_Processing" 
    
    
    
    
    fork="true">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png"/>
        <info name="Documentation" value="user/ProActiveUserGuide.html#_loop"/>
      </genericInformation>
      <depends>
        <task ref="Start"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="javascript">
            <![CDATA[

]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"></controlFlow>
      <metadata>
        <positionTop>
            128
        </positionTop>
        <positionLeft>
            713
        </positionLeft>
      </metadata>
    </task>
    <task name="Loop_Over_Molecule_Processing_Steps" 
    
    
    
    
    fork="true">
      <variables>
        <variable name="STOP_VNC_SIGNAL" value="Stop-Remote-Visualization" inherited="false"    advanced="false" hidden="false"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png"/>
      </genericInformation>
      <depends>
        <task ref="Send_Notifications"/>
      </depends>
      <selection>
        <script type="static">
          <code language="groovy">
            <![CDATA[
/**
 * Script which verifies that the current node runs on the given machine (defined by its hostname)
 *
 * Arguments:
 * machine host name
 */

import com.google.common.base.Strings;

if (args.length != 1) {
    println "Incorrect number of arguments, expected 1, received " + args.length;
    selected = false;
    return;
}

machineName = args[0]

if (Strings.isNullOrEmpty(machineName)) {
    println "Given host name was empty";
    selected = false;
    return;
}

machineName = machineName.trim().toLowerCase()

println "Hostname " + nodehost.toLowerCase() + " (expected :  " + machineName + ")";

selected = (nodehost.toLowerCase() == machineName)
]]>
          </code>
          <arguments>
            <argument value="${BIOSCIENCE_HOST}"/>
          </arguments>
        </script>
      </selection>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
println(variables.get("STOP_LOOP"))

if (variables.get("STOP_LOOP")){
    signalapi.sendSignal(variables.get("STOP_VNC_SIGNAL"))
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
if [ "$variables_STOP_LOOP" == "true" ]; then
    rm -rf /tmp/$variables_BIOSCIENCE_WORKSPACE
fi
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow  block="end">
        <loop target="Start_Molecule_Processing">
          <script>
            <code language="groovy">
              <![CDATA[
if(!variables.get('STOP_LOOP')) {
    loop = true;
} else {
    loop = false;
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            829
        </positionTop>
        <positionLeft>
            676
        </positionLeft>
      </metadata>
    </task>
    <task name="Send_Signal" 
    
    
    
    
    fork="true">
      <variables>
        <variable name="MESSAGE" value="${CURRENT_STEP_ID} is finished. You can find its result in the  user dataspace in the folder &#x27;${BIOSCIENCE_WORKSPACE}/ ${BIOSCIENCE_EXECUTION_TAG}/${CURRENT_STEP_ID}&#x27;." inherited="false"     />
        <variable name="SIGNAL_TO_CONTINUE" value="Validate ${CURRENT_STEP_ID} and continue" inherited="false"    advanced="false" hidden="false"/>
      </variables>
      <depends>
        <task ref="Check_Errors"/>
      </depends>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[

]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
if(!variables.get("STOP_LOOP") && variables.get("CURRENT_STEP_ACTION").equals("pause")){
    // Declare signals
    Set signalsSet = new HashSet<>()
    signalsSet.add("Terminate_Job")
    signalsSet.add(variables.get("SIGNAL_TO_CONTINUE"))
    
    // Send a ready notification for the specified signal
    signalapi.readyForSignal(variables.get("SIGNAL_TO_CONTINUE"))
    signalapi.readyForSignal("Terminate_Job")

    // Wait until the signal is received
    receivedSignal = signalapi.waitForAny(signalsSet)

    // Remove ready signals
	signalapi.removeManySignals(new HashSet<>(signalsSet.collect { signal -> "ready_"+signal }))
    
    println ("Received Signal: "+receivedSignal.getName())
    
    if (receivedSignal.getName().equals("Terminate_Job")){
        variables.put("STOP_LOOP",true)
    }  
}

println(variables.get("STOP_LOOP"))
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            601
        </positionTop>
        <positionLeft>
            707
        </positionLeft>
      </metadata>
    </task>
    <task name="Gromacs_Execute_Step" maxNumberOfExecution="1"
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ Execute Gromacs commands ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/gromacs.jpeg"/>
        <info name="DISABLE_PTK" value="true"/>
        <info name="NS" value="${NATIVE_SCHEDULER}"/>
        <info name="NS_BATCH" value="${NATIVE_SCHEDULER_PARAMS}"/>
      </genericInformation>
      <depends>
        <task ref="Parse_Molecule_Processing_Steps"/>
      </depends>
      <inputFiles>
        <files  includes="${BIOSCIENCE_WORKSPACE}/inputs/*" accessMode="transferFromGlobalSpace"/>
      </inputFiles>
      <selection>
        <script type="static">
          <code language="groovy">
            <![CDATA[
/**
 * Script which verifies that the current node runs on the given machine (defined by its hostname)
 *
 * Arguments:
 * machine host name
 */

import com.google.common.base.Strings;

if (args.length != 1) {
    println "Incorrect number of arguments, expected 1, received " + args.length;
    selected = false;
    return;
}

machineName = args[0]

if (Strings.isNullOrEmpty(machineName)) {
    println "Given host name was empty";
    selected = false;
    return;
}

machineName = machineName.trim().toLowerCase()

println "Hostname " + nodehost.toLowerCase() + " (expected :  " + machineName + ")";

selected = (nodehost.toLowerCase() == machineName)
]]>
          </code>
          <arguments>
            <argument value="${BIOSCIENCE_HOST}"/>
          </arguments>
        </script>
      </selection>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
echo "========================================================================================"

original_workspace=/tmp/$variables_BIOSCIENCE_WORKSPACE
current_execution_workspace=$original_workspace/$variables_BIOSCIENCE_EXECUTION_TAG
    
if [[ "$variables_STOP_LOOP" == "false" && "$variables_CURRENT_STEP_ACTION" == "skip" ]]; then
    echo "Skipping $variables_CURRENT_STEP_ID"
    
elif [ "$variables_STOP_LOOP" == "false" ]; then
    echo "Executing $variables_CURRENT_STEP_ID"

    ### Prepare Docker params for Gromacs
    docker_image=$variables_GROMACS_CONTAINER_IMAGE
    inside_workspace=/$variables_BIOSCIENCE_WORKSPACE
    gpuOptions=""
    if [ "$docker_image" == "nvcr.io/hpc/gromacs:2021" ]; then
	    gpuOptions="--gpus all"
        echo "using Gromacs image $docker_image"
    fi
    
    current_step_workspace=$current_execution_workspace/$variables_CURRENT_STEP_ID
    tmp_workspace=$current_step_workspace/temporary
  
    ### Copy original input files
    mkdir -p $current_step_workspace/inputs
    cp -R $variables_BIOSCIENCE_WORKSPACE/inputs/* $current_step_workspace/inputs
    #chmod -R ugo+rw $current_execution_workspace

        
    ### Add previous output files    
    if [ -d  $current_execution_workspace ]; then  
        for i in `find $current_execution_workspace -type f -print | grep -i "result/*" | sort` ; do cp $i $current_step_workspace/inputs ; done
    fi
    
 	### Execute Gromacs command and get its status
    mkdir -p $current_step_workspace/temporary
    cp -R $current_step_workspace/inputs/*  $current_step_workspace/temporary
    
    docker run -i --rm --name gromacs-$variables_PA_JOB_ID  -v $current_step_workspace/temporary:$inside_workspace $gpuOptions $docker_image sh -c "cd $inside_workspace && $variables_CURRENT_STEP_COMMAND && chmod -R ugo+rw $inside_workspace"
     
    if [ $? -ne 0 ] 
    then 
        echo "GROMACS_ERROR=true" > .variables
    	echo "Error occurred in $variables_CURRENT_STEP_ID. Please check the submitted Gromacs command." && exit 0 
    fi
    
    ### Add execution parameters to be transferred to the user data space
    touch $current_step_workspace/parameters
    echo "Workspace:  $variables_BIOSCIENCE_WORKSPACE" >> $current_step_workspace/parameters
    echo "Executed command:  $variables_CURRENT_STEP_COMMAND" >> $current_step_workspace/parameters
    echo "Email of recipient: $variables_EMAIL_RECIPIENT" >> $current_step_workspace/parameters
    echo "Output folder: $current_step_workspace" >> $current_step_workspace/parameters

    ### Add result files to be transferred to the user data space
    mkdir -p $current_step_workspace/result
    
    IFS=',' read -ra FILES <<< "$variables_CURRENT_STEP_OUTPUT_FILES"
	for i in "${FILES[@]}"; do
    	if [ ! -f  $current_step_workspace/temporary/$i ]; then
        	echo "Error: output file $i is not found."
            exit 1
        else
        	cp $current_step_workspace/temporary/$i $current_step_workspace/result
    	fi        
	done
        
    rm -R $current_step_workspace/temporary/   

    cp -R $original_workspace/* $variables_BIOSCIENCE_WORKSPACE
    
    echo "Step $variables_CURRENT_STEP_ID is accomplished"
   
fi

rm -rf $variables_BIOSCIENCE_WORKSPACE/inputs
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="none"></controlFlow>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
def varFile=new File(localspace, ".variables")
if (varFile.exists()){
    varFile.eachLine { line ->
        keyvalue = line.split("\\s*=\\s*")
        if (keyvalue.length == 2) {
            variables.put(keyvalue[0], keyvalue[1])
        }
    }
    if ("true"==variables.get("GROMACS_ERROR")){
        previousTasks = variables.get("PROCESSED_TASKS")
        previousTasks.remove(variables.get("CURRENT_STEP_ID"))
        variables.put("PROCESSED_TASKS", previousTasks)
    }
}
]]>
          </code>
        </script>
      </post>
      <outputFiles>
        <files  includes="${BIOSCIENCE_WORKSPACE}/**" accessMode="transferToGlobalSpace"/>
      </outputFiles>
      <metadata>
        <positionTop>
            358
        </positionTop>
        <positionLeft>
            605.75
        </positionLeft>
      </metadata>
    </task>
    <task name="Check_Errors" maxNumberOfExecution="1"
    
    onTaskError="suspendTask" 
    
    
    fork="true">
      <depends>
        <task ref="Gromacs_Execute_Step"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
if ("true"==variables.get("GROMACS_ERROR")){
    
    schedulerapi.connect()
    taskState = schedulerapi.getTaskState(org.ow2.proactive.scheduler.job.JobIdImpl.makeJobId(variables.get("PA_JOB_ID")), variables.get("PA_TASK_NAME"))
    
	if (taskState.getNumberOfExecutionLeft() > 0) {
        throw new Exception ("Error occurred in "+variables.get("CURRENT_STEP_ID")+". Please check the submitted Gromacs command.")
    }
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow  block="end">
        <loop target="Parse_Molecule_Processing_Steps">
          <script>
            <code language="groovy">
              <![CDATA[
if ("true"==variables.get("GROMACS_ERROR")){
    loop = true
} else {
    loop = false
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            490
        </positionTop>
        <positionLeft>
            703
        </positionLeft>
      </metadata>
    </task>
    <task name="Send_Notifications" 
    
    
    
    
    fork="true">
      <variables>
        <variable name="MESSAGE" value="${CURRENT_STEP_ID} is finished. You can find its result in the  user dataspace in the folder &#x27;${BIOSCIENCE_WORKSPACE}/ ${BIOSCIENCE_EXECUTION_TAG}/${CURRENT_STEP_ID}&#x27;." inherited="false"     />
        <variable name="STOP_VNC_SIGNAL" value="Stop-Remote-Visualization" inherited="false"     />
        <variable name="SIGNAL_TO_CONTINUE" value="Terminate ${CURRENT_STEP_ID} and continue" inherited="false"     />
      </variables>
      <depends>
        <task ref="Send_Signal"/>
      </depends>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.notification.client.ApiClient
import org.ow2.proactive.notification.client.api.EventRestApi
import org.ow2.proactive.notification.client.model.EventRequest
import org.ow2.proactive.notification.client.model.Event
import org.ow2.proactive.notification.client.ApiException

if(!variables.get("STOP_LOOP") && variables.get("CURRENT_STEP_NOTIFICATION").equals("true")){

    //Get notification-service URL
    def notifUrl = variables.get('PA_NOTIFICATION_SERVICE_REST_URL')

    // Instantiate EventRestApi instance
    def apiClient = new ApiClient()
    apiClient.setBasePath(notifUrl)
    def eventRestApi = new EventRestApi(apiClient)

    //Get job id
    def jobId = new Long(variables.get("PA_JOB_ID"))

    //Get event message or set default
    def eventMessage = variables.get("MESSAGE")
    if (variables.get("CURRENT_STEP_ACTION").equals("pause")){
            eventMessage+=" To resume the workflow execution, please trigger the action '" +variables.get("SIGNAL_TO_CONTINUE")+ "'."
    }
    if (eventMessage == null || eventMessage.isEmpty()) {
        eventMessage = "You have a notification."
    }

    // Get event severity or set default
    def eventSeverity = "INFO"
    if (eventSeverity == null || eventSeverity.isEmpty()) {
        eventSeverity = EventRequest.EventSeverityEnum.INFO
    } else {
        eventSeverity = EventRequest.EventSeverityEnum.valueOf(eventSeverity)
    }

    //Get session id
    schedulerapi.connect()
    def sessionId = schedulerapi.getSession()

    //Create event
    def eventRequest = new EventRequest()
            .bucketName(genericInformation.get("bucketName"))
            .workflowName(variables.get("PA_JOB_NAME"))
            .eventType(EventRequest.EventTypeEnum.CUSTOM)
            .eventSeverity(eventSeverity)
            .jobId(jobId)
            .message(eventMessage);

    try {
        result = eventRestApi.createEventUsingPOST(sessionId, eventRequest).toString()
        println("Web notification sent to current user." )
    } catch (ApiException e) {
        System.err.println("Exception when calling EventRestApi#createEventUsingPOST")
        System.err.println(e.getMessage())
    }    
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.addons.email.EmailSender;

if(!variables.get("STOP_LOOP") && variables.get("CURRENT_STEP_NOTIFICATION").equals("true")){
    
    try {
        // Note that you must configure SMTP connection a priori !!

        // Email parameters
        //from = variables.get("EMAIL_SENDER")
        from = "noreply@activeeon.com"
        to = variables.get("EMAIL_RECIPIENT")
        subject = variables.get("BIOSCIENCE_EXECUTION_TAG")
        content = variables.get("MESSAGE")
        if (variables.get("CURRENT_STEP_ACTION").equals("pause")){
            content+="To resume the workflow execution, please trigger the action '" +variables.get("SIGNAL_TO_CONTINUE")+ "'."
        }
        
        // Send email
        EmailSender.Builder builder = new EmailSender.Builder(credentials);
        builder.setFrom(from)
        builder.addRecipient(to)
        builder.setSubject(subject)
        builder.setBody(content)
        builder.build().sendPlainTextEmail();
        
        println "Email notification sent to user "+ to + "."
        
    } catch(Exception e){
    	System.err.println "Email notification failed, no email was sent to user "+ to + "."
        System.err.println(e.getMessage())
    }
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[

]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            713
        </positionTop>
        <positionLeft>
            699
        </positionLeft>
      </metadata>
    </task>
    <task name="Start" 
    
    
    
    
    fork="true">
      <variables>
        <variable name="GROMACS_SIGNAL" value="Start_Gromacs_Processing" inherited="false"     />
      </variables>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[

]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
variables.put("BIOSCIENCE_HOST",variables.get("PA_NODE_HOST"))
//variables.put("PROCESSING_STEPS",variables.get("MOLECULE_PROCESSING_STEPS").replace("/","/resources/"))
println(variables.get("PROCESSING_STEPS"))
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            22
        </positionTop>
        <positionLeft>
            879
        </positionLeft>
      </metadata>
    </task>
    <task name="Remote_Visualization_for_VMD" 
    
    
    
    
    fork="true">
      <description>
        <![CDATA[ Execute VMD container ]]>
      </description>
      <variables>
        <variable name="NS" value="" inherited="false"     />
        <variable name="NS_BATCH" value="" inherited="false"     />
        <variable name="STOP_VNC_SIGNAL" value="Stop-Remote-Visualization" inherited="false"     />
        <variable name="VISU_COMMAND" value="Xvnc :${DISPLAY} -geometry 1280x1024 -SecurityTypes None" inherited="false" model="PA:NOT_EMPTY_STRING"    />
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/remote-visualization.png"/>
        <info name="DISABLE_PTK" value="true"/>
        <info name="NS" value="${NS}"/>
        <info name="NS_BATCH" value="${NS_BATCH}"/>
      </genericInformation>
      <depends>
        <task ref="Start"/>
      </depends>
      <selection>
        <script type="static">
          <code language="groovy">
            <![CDATA[
/**
 * Script which verifies that the current node runs on the given machine (defined by its hostname)
 *
 * Arguments:
 * machine host name
 */

import com.google.common.base.Strings;

if (args.length != 1) {
    println "Incorrect number of arguments, expected 1, received " + args.length;
    selected = false;
    return;
}

machineName = args[0]

if (Strings.isNullOrEmpty(machineName)) {
    println "Given host name was empty";
    selected = false;
    return;
}

machineName = machineName.trim().toLowerCase()

println "Hostname " + nodehost.toLowerCase() + " (expected :  " + machineName + ")";

selected = (nodehost.toLowerCase() == machineName)
]]>
          </code>
          <arguments>
            <argument value="${BIOSCIENCE_HOST}"/>
          </arguments>
        </script>
      </selection>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
/**
 * Pre-Script which enables Remote Visualization using a VNC command and X terminal session
 *
 * This script creates the variable 'VISU_PID' containing the process id of the VNC session started
 * This session should be terminated with a kill command (otherwise the task will remain running)
 *
 * Arguments:
 * display : X display number (e.g. 12)
 * visu_command : command used to start the VNC session (e.g. "Xvnc :${DISPLAY} -geometry 1280x1024 -SecurityTypes None")
 */

// Generate random port for remote visualization
def findPort() {
    findPortScript = new File("find_port.sh")
    findPortScript << '''
    while :
        do
            RND_PORT="`shuf -i 5911-5999 -n 1`"
	        ss -lpn | grep -q ":$RND_PORT " || break
        done
    echo $RND_PORT
    '''
    'chmod u+x find_port.sh'.execute().text
    port = "./find_port.sh".execute().text
    findPortScript.delete() 
    return port
}

    // Prepare remote visualization command
    def visu_command = args[0]
    port = findPort()
    display = port.trim().substring(2)
    variables.put("DISPLAY", display)
    visu_command_final = visu_command.replace('$DISPLAY',display).replace('${DISPLAY}',display)
    println "visu_command = " + visu_command_final

    // Start remote visualization
    def processVisu = visu_command_final.execute()
    processVisu.consumeProcessOutput(System.out, System.err)
    Thread.sleep(1000)
    grepProc = 'ps -aux'.execute() | ['grep', visu_command_final].execute() | 'grep -v grep'.execute() | ['awk', '{ print $2 }'].execute()
    grepProc.waitFor()
    visu_pidText = grepProc.text

    println "Visu process id: " + visu_pidText

    try {
        Integer visuPid = visu_pidText.trim() as Integer
        variables.put("VISU_PID", visuPid)
    } catch (Exception e) {
        throw new IllegalStateException("Visu process cannot be found", e)
    }    

    remoteConnectionString = String.format("PA_REMOTE_CONNECTION;%s;%s;vnc;%s:59%s", variables.get("PA_JOB_ID"), variables.get("PA_TASK_ID"), variables.get("PA_NODE_HOST"), display)
    println remoteConnectionString

    schedulerapi.connect()
    schedulerapi.enableRemoteVisualization(variables.get("PA_JOB_ID"), variables.get("PA_TASK_NAME"), remoteConnectionString)
]]>
          </code>
          <arguments>
            <argument value="${VISU_COMMAND}"/>
          </arguments>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
#!/bin/bash

docker_image=$variables_VMD_CONTAINER_IMAGE

gpuOptions=""
if [ "$docker_image" == "activeeon/vmd-gpu" ]; then
	gpuOptions="--gpus all"
    echo "using VMD image $docker_image"
fi

# set the display to be used
export DISPLAY=:${variables_DISPLAY}
#export LIBGL_ALWAYS_INDIRECT=1

outside_workspace=/tmp/$variables_BIOSCIENCE_WORKSPACE
inside_workspace=/$variables_BIOSCIENCE_WORKSPACE
tmp_workspace=$(pwd)/visu_script

mkdir -p $outside_workspace
chmod -R 777 $outside_workspace

mkdir -p $tmp_workspace
touch $tmp_workspace/connect_to_sim.tcl
echo "menu main on" > $tmp_workspace/connect_to_sim.tcl
echo "display background gradient" >> $tmp_workspace/connect_to_sim.tcl
echo "wait 100000" >> $tmp_workspace/connect_to_sim.tcl


docker run -d --name vmd-$variables_PA_JOB_ID --net=host -e DISPLAY=$DISPLAY -v $outside_workspace:$inside_workspace -v $tmp_workspace:/visu_script $gpuOptions $docker_image /bin/bash -c "vmd -startup /visu_script/connect_to_sim.tcl"

sleep 2

docker logs vmd-$variables_PA_JOB_ID
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
def stopVMD(){    
     // Remove VMD Docker container
	def removeContainerCmd = "docker rm -f vmd-"+variables.get("PA_JOB_ID")
	def removeContainer = removeContainerCmd.execute()
	removeContainer.consumeProcessOutput(System.out, System.err)
	removeContainer.waitForOrKill(10000)
	Thread.sleep(1000)
}

def stopVNC(){
    
    stopVMD()
    
    // Kill remote visualization process (Xvnc) 
	def VISU_PID = variables.get("VISU_PID")
	def killVisCmd = "kill -9 "+VISU_PID
	def killVis = killVisCmd.execute()
	killVis.consumeProcessOutput(System.out, System.err)
	killVis.waitForOrKill(1000)
	Thread.sleep(1000)
    
    def DISPLAY = variables.get("DISPLAY")
	def DISPLAY_LOCK_FILE = new File("/tmp/.X"+DISPLAY+"-lock")
	DISPLAY_LOCK_FILE.delete()
    
    println("Remote visualization stopped")
}

// Read the signal variables
stopVNCSignal = variables.get("STOP_VNC_SIGNAL")

Set<String> signalsSet1 = [stopVNCSignal]
//signalapi.readyForSignal(stopVNCSignal)
receivedSignal = signalapi.waitForAny(signalsSet1)
if(receivedSignal.getName() == stopVNCSignal){
	println("Stopping Remote Visualization ..")
	stopVNC()
}
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            129
        </positionTop>
        <positionLeft>
            1000.5
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2725px;
            height:3364px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-17px;left:-594.25px"><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_517" style="top: 226px; left: 599.25px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Parse_Molecule_Processing_Steps</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon" class="glyphicon glyphicon-list-alt"></i></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_520" style="top: 128px; left: 713px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png" width="20px">&nbsp;<span class="name">Start_Molecule_Processing</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_523" style="top: 829px; left: 676px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png" width="20px">&nbsp;<span class="name">Loop_Over_Molecule_Processing_Steps</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_526" style="top: 601px; left: 707px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Send_Signal</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_529" style="top: 358px; left: 605.75px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Execute Gromacs commands"><img src="/automation-dashboard/styles/patterns/img/wf-icons/gromacs.jpeg" width="20px">&nbsp;<span class="name">Gromacs_Execute_Step</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_532" style="top: 490px; left: 703px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Check_Errors</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_535" style="top: 713px; left: 699px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Send_Notifications</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" id="jsPlumb_1_538" style="top: 22px; left: 879px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Start</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_541" style="top: 129px; left: 1000.5px; z-index: 24;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Execute VMD container"><img src="/automation-dashboard/styles/patterns/img/wf-icons/remote-visualization.png" width="20px">&nbsp;<span class="name">Remote_Visualization_for_VMD</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><svg style="position:absolute;left:687.5px;top:167.5px" width="117" height="59" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 58 C -10 8 106 50 96 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M8.518579499999996,36.679439 L29.693336759422678,35.88593096316203 L21.55013461142144,31.562939085215916 L24.576836844638592,22.854375851740585 L8.518579499999996,36.679439" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M8.518579499999996,36.679439 L29.693336759422678,35.88593096316203 L21.55013461142144,31.562939085215916 L24.576836844638592,22.854375851740585 L8.518579499999996,36.679439" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:783.5px;top:61.5px" width="156" height="67" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 66 C -10 16 145 50 135 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M16.75008,42.192768 L37.924685067414636,42.99032692510744 L30.1288109432887,38.06850341742416 L33.8004204848388,29.611595981818738 L16.75008,42.192768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M16.75008,42.192768 L37.924685067414636,42.99032692510744 L30.1288109432887,38.06850341742416 L33.8004204848388,29.611595981818738 L16.75008,42.192768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:750.5px;top:752.5px" width="47" height="77" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 26 76 C 36 26 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M26.795056,56.188676 L25.45532180467739,35.041451305353114 L21.34393440809415,43.29351127091422 L12.560157075591611,40.49257289725896 L26.795056,56.188676" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M26.795056,56.188676 L25.45532180467739,35.041451305353114 L21.34393440809415,43.29351127091422 L12.560157075591611,40.49257289725896 L26.795056,56.188676" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:874.5px;top:117.5px" width="51" height="762" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 0 C 50 -50 13 711 23 661 " transform="translate(0.5,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M24.652257750000004,117.32254425000005 L32.38721710964706,137.04994660572362 L25.170082226258945,131.31296446569718 L18.39679689394992,137.56777108198258 L24.652257750000004,117.32254425000005" class="" stroke="#316b31" fill="#316b31" transform="translate(0.5,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M24.652257750000004,117.32254425000005 L32.38721710964706,137.04994660572362 L25.170082226258945,131.31296446569718 L18.39679689394992,137.56777108198258 L24.652257750000004,117.32254425000005" class="" stroke="#316b31" fill="#316b31" transform="translate(0.5,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_558" style="position: absolute; transform: translate(-50%, -50%); left: 901px; top: 498px;">loop</div><svg style="position:absolute;left:743px;top:529.5px" width="24.5" height="72" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 3.5 71 C 13.5 21 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M5.964875,53.299250000000015 L11.582188724068097,32.86775992890152 L5.008442518421859,39.33195831878342 L-2.385102957148499,33.82419241047967 L5.964875,53.299250000000015" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M5.964875,53.299250000000015 L11.582188724068097,32.86775992890152 L5.008442518421859,39.33195831878342 L-2.385102957148499,33.82419241047967 L5.964875,53.299250000000015" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:670px;top:265.5px" width="38.5" height="93" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 92 C -10 42 27.5 50 17.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.2744418750000013,69.4706815 L10.448788759796182,51.81945311545474 L2.1836521028563376,55.9044887385686 L-3.1174040016352165,48.361359137598406 L-1.2744418750000013,69.4706815" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.2744418750000013,69.4706815 L10.448788759796182,51.81945311545474 L2.1836521028563376,55.9044887385686 L-3.1174040016352165,48.361359137598406 L-1.2744418750000013,69.4706815" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:670px;top:397.5px" width="94" height="93" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 73 92 C 83 42 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M67.21378025,66.6402985 L57.5663481995294,47.77426937801589 L57.079811813282376,56.98096706746229 L47.90701676699169,57.90823781473351 L67.21378025,66.6402985" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M67.21378025,66.6402985 L57.5663481995294,47.77426937801589 L57.079811813282376,56.98096706746229 L47.90701676699169,57.90823781473351 L67.21378025,66.6402985" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:793.5px;top:215.5px" width="54" height="325" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 0 C 50 -50 -3 274 7 224 " transform="translate(3.5,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M21.139672750000003,25.122450500000006 L29.128313887091192,44.74849474693817 L21.837817921905557,39.10503228302366 L15.145732104067537,45.44663991884372 L21.139672750000003,25.122450500000006" class="" stroke="#316b31" fill="#316b31" transform="translate(3.5,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M21.139672750000003,25.122450500000006 L29.128313887091192,44.74849474693817 L21.837817921905557,39.10503228302366 L15.145732104067537,45.44663991884372 L21.139672750000003,25.122450500000006" class="" stroke="#316b31" fill="#316b31" transform="translate(3.5,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_573" style="position: absolute; transform: translate(-50%, -50%); left: 815px; top: 377.5px;">loop</div><svg style="position:absolute;left:746.5px;top:640.5px" width="25" height="73" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 4 72 C 14 22 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M6.452673499999999,53.79092550000001 L11.83293743928239,33.29573679768117 L5.33451183000406,39.8356499928754 L-2.1223380678422163,34.413898467677114 L6.452673499999999,53.79092550000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M6.452673499999999,53.79092550000001 L11.83293743928239,33.29573679768117 L5.33451183000406,39.8356499928754 L-2.1223380678422163,34.413898467677114 L6.452673499999999,53.79092550000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:918.5px;top:61.5px" width="183.5" height="68" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 162.5 67 C 172.5 17 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M139.921875,42.46875 L122.2609867311117,30.76007690891732 L126.3528356275839,39.02184261658776 L118.81407934769945,44.32911628133342 L139.921875,42.46875" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M139.921875,42.46875 L122.2609867311117,30.76007690891732 L126.3528356275839,39.02184261658776 L118.81407934769945,44.32911628133342 L139.921875,42.46875" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 688px; top: 256px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 688px; top: 216px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 787px; top: 256px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 784px; top: 158px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 784px; top: 118px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 865px; top: 158px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 777px; top: 859px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 777px; top: 819px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 888px; top: 819px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 747px; top: 631px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 747px; top: 591px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 670.5px; top: 388px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 670.5px; top: 348px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 743.5px; top: 520px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 743.5px; top: 480px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 794px; top: 480px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 751px; top: 743px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 751px; top: 703px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 919px; top: 52px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 1081.5px; top: 159px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 1081.5px; top: 119px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>
