<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<job xmlns="urn:proactive:jobdescriptor:3.14" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" maxNumberOfExecution="1" name="Molecular_Dynamics_Simulation" onTaskError="continueJobExecution" priority="normal" projectName="1. Molecular Dynamics Workflows" tags="bioscience,hpc" xsi:schemaLocation="urn:proactive:jobdescriptor:3.14 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.14/schedulerjob.xsd">
  <variables>
    <variable advanced="false" description="CSV file that contains the molecule processing steps (i.e., Gromacs commands)" group="Bioscience Molecule Parameters" hidden="false" model="PA:CATALOG_OBJECT" name="MOLECULE_PROCESSING_STEPS" value="hpc-bioscience/Lysozyme_in_Water_Steps_Short"/>
    <variable advanced="false" description="Name of a folder in the Global Dataspace used to store the input/output files of the current experiment" group="Bioscience Molecule Parameters" hidden="false" model="PA:GLOBAL_FOLDER" name="BIOSCIENCE_WORKSPACE" value="BioScience-Workspace/Lysozyme-in-Water"/>
    <variable advanced="false" description="Tag used to identify the current experiment" group="Bioscience Molecule Parameters" hidden="false" model="PA:NOT_EMPTY_STRING" name="BIOSCIENCE_EXECUTION_TAG" value="Lysozyme-in-Water-Cubic-Box-${PA_JOB_ID}"/>
    <variable advanced="false" hidden="true" model="PA:SPEL(t(variables['PROCESSING_STEPS'] = variables['MOLECULE_PROCESSING_STEPS'].replace(&quot;/&quot;,&quot;/resources/&quot;)))" name="PROCESSING_STEPS" value="hpc-bioscience/resources/Lysozyme_in_Water_Steps_Short"/>
    <variable advanced="false" description="Recipient Email that will receive notifications about the experiment progress" group="Notification Parameters" hidden="false" model="PA:NOT_EMPTY_STRING" name="EMAIL_RECIPIENT" value="usera.bioscience@gmail.com"/>
    <variable advanced="false" description="Compute infrastructure where the workflow tasks will be executed" group="Runtime Parameters" hidden="false" model="PA:MODEL_FROM_URL(${PA_SCHEDULER_REST_PUBLIC_URL}/rm/model/nodesources?infrastructure=%5E(%3F!(Default)).*$)" name="TARGET_INFRASTRUCTURE" value=""/>
    <variable advanced="true" description="Name of the native scheduler (if any) that will execute the current experiment" group="Runtime Parameters" hidden="false" name="NATIVE_SCHEDULER" value=""/>
    <variable advanced="true" description="Parameters to be passed to the native scheduler (if any) that will execute the current experiment" group="Runtime Parameters" hidden="false" name="NATIVE_SCHEDULER_PARAMS" value=""/>
    <variable advanced="true" description="Container engine used to deploy molecular dynamics applications such as Gromacs and VMD" group="Runtime Parameters" hidden="false" model="PA:LIST(Docker,Singularity)" name="CONTAINER_RUNTIME" value="Docker"/>
    <variable advanced="true" description="Container image used to deploy the Gromacs application" group="Runtime Parameters" hidden="false" model="PA:LIST(nvcr.io/hpc/gromacs:2021,gromacs/gromacs:gmx-2020.3-cuda-10.2)" name="GROMACS_CONTAINER_IMAGE" value="gromacs/gromacs:gmx-2020.3-cuda-10.2"/>
    <variable advanced="true" description="Container image used to deploy the VMD application" group="Runtime Parameters" hidden="false" model="PA:LIST(activeeon/vmd-gpu, activeeon/vmd)" name="VMD_CONTAINER_IMAGE" value="activeeon/vmd"/>
  </variables>
  <description>
    <![CDATA[ This workflow allows bioscientists to transform molecules and run simulations. It performs the following:
(i) Visualize the molecule structure using the viewing program VMD.
(ii) Use Gromacs to carry out the molecule transformations. The resulting files are placed in the user dataspace.
(iii) Send an email and web notifications to the user after each step of the molecule processing. ]]>
  </description>
  <genericInformation>
<info name="bucketName" value="hpc-bioscience"/>
<info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/bioscience.png"/>
<info name="NODE_SOURCE" value="${TARGET_INFRASTRUCTURE}"/>
<info name="Documentation" value="http://www.mdtutorials.com/gmx/index.html"/>
<info name="group" value="public-objects"/>
</genericInformation>
  <taskFlow>
    <task fork="true" maxNumberOfExecution="1" name="Parse_Molecule_Processing_Steps" onTaskError="suspendTask">
      <genericInformation>
        <info name="DISABLE_PTK" value="true"/>
        <info name="PRE_SCRIPT_AS_FILE" value="molecule-processing-steps.csv"/>
      </genericInformation>
      <depends>
        <task ref="Start_Molecule_Processing"/>
      </depends>
      <pre>
        <script>
          <file url="${PA_CATALOG_REST_URL}/buckets/${PROCESSING_STEPS}/raw"/>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
@Grab('com.xlson.groovycsv:groovycsv:1.3')
import static com.xlson.groovycsv.CsvParser.parseCsv
import org.ow2.proactive.scheduler.common.job.JobVariable

variables.put("GROMACS_ERROR","false")

int stepIndex = variables.get("STEP_INDEX") == null ? 0 : variables.get("STEP_INDEX") as int
boolean reexecute = variables.get("REEXECUTE_STEP") == null ? false : variables.get("REEXECUTE_STEP") as boolean
variables.put("STOP_LOOP", false)

def lineIterator = parseCsv(new FileReader('molecule-processing-steps.csv'), separator: ';')
def rows = []
while (lineIterator.hasNext()) rows << lineIterator.next()

//println(variables.get("REEXECUTE_STEP"))
//println(reexecute)

if (stepIndex == rows.size()){
    variables.put("STOP_LOOP", true)
} else if (!reexecute) {
    currentLine = rows[stepIndex]
    nextLine = rows[stepIndex+1]

    println currentLine
    //println nextLine

    variables.put("CURRENT_STEP_ID" , "$currentLine.Step_ID".trim())
    variables.put("CURRENT_STEP_COMMAND" , "$currentLine.Command".trim())
    variables.put("CURRENT_STEP_OUTPUT_FILES" , "$currentLine.Output_Files".trim())
    variables.put("CURRENT_STEP_NOTIFICATION" , "$currentLine.Notification".trim().toLowerCase())
    variables.put("CURRENT_STEP_ACTION" , "$currentLine.Action".trim().toLowerCase())

    /*variables.put("NEXT_STEP_ID" , "$nextLine.Step_ID".trim())
    variables.put("NEXT_STEP_COMMAND" , "$nextLine.Command".trim())
    variables.put("NEXT_STEP_OUTPUT_FILES" , "$nextLine.Output_Files".trim())
    variables.put("NEXT_STEP_NOTIFICATION" , "$nextLine.Notification".trim().toLowerCase())
    variables.put("NEXT_STEP_ACTION" , "$nextLine.Action".trim().toLowerCase())*/
    
    variables.put("STEP_INDEX", stepIndex+1)
    println(variables.get("STEP_INDEX"))
}

println(variables.get("CURRENT_STEP_ID"))
println(variables.get("CURRENT_STEP_COMMAND"))
println(variables.get("CURRENT_STEP_OUTPUT_FILES"))
println(variables.get("CURRENT_STEP_NOTIFICATION"))
println(variables.get("CURRENT_STEP_ACTION"))

/*println(variables.get("NEXT_STEP_ID"))
println(variables.get("NEXT_STEP_COMMAND"))
println(variables.get("NEXT_STEP_OUTPUT_FILES"))
println(variables.get("NEXT_STEP_NOTIFICATION"))
println(variables.get("NEXT_STEP_ACTION"))*/
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"/>
      <metadata>
        <positionTop>
            225
        </positionTop>
        <positionLeft>
            599.25
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Start_Molecule_Processing">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png"/>
        <info name="Documentation" value="user/ProActiveUserGuide.html#_loop"/>
      </genericInformation>
      <depends>
        <task ref="Start"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="javascript">
            <![CDATA[

]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"/>
      <metadata>
        <positionTop>
            128
        </positionTop>
        <positionLeft>
            713
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Loop_Over_Molecule_Processing_Steps">
      <variables>
        <variable advanced="false" hidden="false" inherited="false" name="STOP_VNC_SIGNAL" value="Stop-Remote-Visualization"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png"/>
      </genericInformation>
      <depends>
        <task ref="Send_Signal"/>
      </depends>
      <selection>
        <script type="static">
          <code language="groovy">
            <![CDATA[
/**
 * Script which verifies that the current node runs on the given machine (defined by its hostname)
 *
 * Arguments:
 * machine host name
 */

import com.google.common.base.Strings;

if (args.length != 1) {
    println "Incorrect number of arguments, expected 1, received " + args.length;
    selected = false;
    return;
}

machineName = args[0]

if (Strings.isNullOrEmpty(machineName)) {
    println "Given host name was empty";
    selected = false;
    return;
}

machineName = machineName.trim().toLowerCase()

println "Hostname " + nodehost.toLowerCase() + " (expected :  " + machineName + ")";

selected = (nodehost.toLowerCase() == machineName)
]]>
          </code>
          <arguments>
            <argument value="${BIOSCIENCE_HOST}"/>
          </arguments>
        </script>
      </selection>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
println(variables.get("STOP_LOOP"))

if (variables.get("STOP_LOOP")){
    signalapi.sendSignal(variables.get("STOP_VNC_SIGNAL"))
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
if [ "$variables_STOP_LOOP" == "true" ]; then
    rm -rf /tmp/$variables_BIOSCIENCE_WORKSPACE
fi
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end">
        <loop target="Start_Molecule_Processing">
          <script>
            <code language="groovy">
              <![CDATA[
if(!variables.get('STOP_LOOP')) {
    loop = true;
} else {
    loop = false;
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            829
        </positionTop>
        <positionLeft>
            676
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Send_Signal">
      <variables>
        <variable inherited="false" name="MESSAGE" value="${CURRENT_STEP_ID} is finished. You can find its result in the  user dataspace in the folder '${BIOSCIENCE_WORKSPACE}/ ${BIOSCIENCE_EXECUTION_TAG}/${CURRENT_STEP_ID}'."/>
        <variable advanced="false" hidden="false" inherited="false" name="CONTINUATION_SIGNAL" value="Approve ${CURRENT_STEP_ID} and continue"/>
        <variable advanced="false" hidden="false" inherited="false" name="RESTART_SIGNAL" value="Re-execute ${CURRENT_STEP_ID}"/>
        <variable advanced="false" hidden="false" inherited="false" name="TERMINATION_SIGNAL" value="Terminate_Job"/>
      </variables>
      <depends>
        <task ref="Send_Notifications"/>
      </depends>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[

]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.scheduler.common.job.JobVariable

variables.put("REEXECUTE_STEP",false)

if(!variables.get("STOP_LOOP") && variables.get("CURRENT_STEP_ACTION").equals("validate")){
    // Declare signals
    Set signalsSet = new HashSet<>()
    signalsSet.add(variables.get("TERMINATION_SIGNAL"))
    signalsSet.add(variables.get("CONTINUATION_SIGNAL"))
    signalsSet.add(variables.get("RESTART_SIGNAL"))
    
    // Declare step variables to be associated with the RESTART_SIGNAL
    List <JobVariable> stepVariables = new java.util.ArrayList<JobVariable>()
	stepVariables.add(new JobVariable("STEP_ID", variables.get("CURRENT_STEP_ID"), "PA:NOT_EMPTY_STRING", "Step ID", "Step Parameters", false, false))
	stepVariables.add(new JobVariable("COMMAND", variables.get("CURRENT_STEP_COMMAND"), "PA:NOT_EMPTY_STRING", "Command to execute", "Step Parameters", false, false))
	stepVariables.add(new JobVariable("OUTPUT_FILES",variables.get("CURRENT_STEP_OUTPUT_FILES"), "PA:NOT_EMPTY_STRING", "Output files to be saved", "Step Parameters", false, false))
	stepVariables.add(new JobVariable("NOTIFICATION", variables.get("CURRENT_STEP_NOTIFICATION"),"PA:BOOLEAN", "Whether to send notification or not", "Step Parameters", false, false))
    stepVariables.add(new JobVariable("ACTION", variables.get("CURRENT_STEP_ACTION"),"PA:LIST(validate,continue,skip)", "Action to perform when executing this step", "Step Parameters", false, false))
    
    // Send a ready notification for the specified signal
    signalapi.readyForSignal(variables.get("CONTINUATION_SIGNAL"))
    signalapi.readyForSignal(variables.get("TERMINATION_SIGNAL"))
    signalapi.readyForSignal(variables.get("RESTART_SIGNAL"),stepVariables)

    // Wait until the signal is received
    receivedSignal = signalapi.waitForAny(signalsSet)

    // Remove ready signals
	signalapi.removeManySignals(new HashSet<>(signalsSet.collect { signal -> "ready_"+signal }))
    
    println ("Received Signal: "+receivedSignal.getName())
    
    if (receivedSignal.getName().equals(variables.get("TERMINATION_SIGNAL"))){
        variables.put("STOP_LOOP",true)
    } else if (receivedSignal.getName().equals(variables.get("RESTART_SIGNAL"))){
        
        variables.put("REEXECUTE_STEP",true)
        
        variables.put("CURRENT_STEP_ID",receivedSignal.getUpdatedVariables().get("STEP_ID"))
        variables.put("CURRENT_STEP_COMMAND",receivedSignal.getUpdatedVariables().get("COMMAND"))
        variables.put("CURRENT_STEP_OUTPUT_FILES",receivedSignal.getUpdatedVariables().get("OUTPUT_FILES"))
        variables.put("CURRENT_STEP_NOTIFICATION",receivedSignal.getUpdatedVariables().get("NOTIFICATION"))
        variables.put("CURRENT_STEP_ACTION",receivedSignal.getUpdatedVariables().get("ACTION"))
        
        println("Re-executing Step ${variables.get("CURRENT_STEP_ID")} ...")        
    }
}

//println(variables.get("REEXECUTE_STEP"))
println(variables.get("STOP_LOOP"))
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            717
        </positionTop>
        <positionLeft>
            703
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" maxNumberOfExecution="1" name="Gromacs_Execute_Step">
      <description>
        <![CDATA[ Execute Gromacs commands ]]>
      </description>
      <variables>
        <variable advanced="false" description="Signal to be displayed before executing a step that requires validation" group="Signal Parameters" hidden="false" inherited="false" model="PA:NOT_EMPTY_STRING" name="EXECUTION_SIGNAL" value="Execute ${CURRENT_STEP_ID}"/>
        <variable advanced="false" description="Signal to be displayed for terminating the job" group="Signal Parameters" hidden="false" inherited="false" model="PA:NOT_EMPTY_STRING" name="TERMINATION_SIGNAL" value="Terminate_Job"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/gromacs.jpeg"/>
        <info name="DISABLE_PTK" value="true"/>
        <info name="NS" value="${NATIVE_SCHEDULER}"/>
        <info name="NS_BATCH" value="${NATIVE_SCHEDULER_PARAMS}"/>
      </genericInformation>
      <depends>
        <task ref="Parse_Molecule_Processing_Steps"/>
      </depends>
      <inputFiles>
        <files accessMode="transferFromGlobalSpace" includes="${BIOSCIENCE_WORKSPACE}/inputs/*"/>
      </inputFiles>
      <selection>
        <script type="static">
          <code language="groovy">
            <![CDATA[
/**
 * Script which verifies that the current node runs on the given machine (defined by its hostname)
 *
 * Arguments:
 * machine host name
 */

import com.google.common.base.Strings;

if (args.length != 1) {
    println "Incorrect number of arguments, expected 1, received " + args.length;
    selected = false;
    return;
}

machineName = args[0]

if (Strings.isNullOrEmpty(machineName)) {
    println "Given host name was empty";
    selected = false;
    return;
}

machineName = machineName.trim().toLowerCase()

println "Hostname " + nodehost.toLowerCase() + " (expected :  " + machineName + ")";

selected = (nodehost.toLowerCase() == machineName)
]]>
          </code>
          <arguments>
            <argument value="${BIOSCIENCE_HOST}"/>
          </arguments>
        </script>
      </selection>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.scheduler.common.job.JobVariable

if(!variables.get("REEXECUTE_STEP") && !variables.get("STOP_LOOP") && variables.get("CURRENT_STEP_ACTION").equals("validate")){
    
    // Declare signals
    Set signalsSet = new HashSet<>()
    signalsSet.add(variables.get("TERMINATION_SIGNAL"))     
    signalsSet.add(variables.get("EXECUTION_SIGNAL"))
    
    List <JobVariable> stepVariables = new java.util.ArrayList<JobVariable>()
	stepVariables.add(new JobVariable("STEP_ID", variables.get("CURRENT_STEP_ID"), "PA:NOT_EMPTY_STRING", "Step ID", "Step Parameters", false, false))
	stepVariables.add(new JobVariable("COMMAND", variables.get("CURRENT_STEP_COMMAND"), "PA:NOT_EMPTY_STRING", "Command to execute", "Step Parameters", false, false))
	stepVariables.add(new JobVariable("OUTPUT_FILES",variables.get("CURRENT_STEP_OUTPUT_FILES"), "PA:NOT_EMPTY_STRING", "Output files to be saved", "Step Parameters", false, false))
	stepVariables.add(new JobVariable("NOTIFICATION", variables.get("CURRENT_STEP_NOTIFICATION"),"PA:BOOLEAN", "Whether to send notification or not", "Step Parameters", false, false))
    stepVariables.add(new JobVariable("ACTION", variables.get("CURRENT_STEP_ACTION"),"PA:LIST(validate,continue,skip)", "Action to perform when executing this step", "Step Parameters", false, false))
       
    // Send a ready notification for the specified signal
	signalapi.readyForSignal(variables.get("EXECUTION_SIGNAL"), stepVariables)
    signalapi.readyForSignal(variables.get("TERMINATION_SIGNAL"))

    // Wait until the signal is received
    receivedSignal = signalapi.waitForAny(signalsSet)

    // Remove ready signals
	signalapi.removeManySignals(new HashSet<>(signalsSet.collect { signal -> "ready_"+signal }))
    
    println ("Received Signal: "+receivedSignal.getName())
    
    if (receivedSignal.getName().equals(variables.get("TERMINATION_SIGNAL"))){
        variables.put("STOP_LOOP",true)
    }  else if (receivedSignal.getName() == variables.get("EXECUTION_SIGNAL")){
        variables.put("CURRENT_STEP_ID",receivedSignal.getUpdatedVariables().get("STEP_ID"))
        variables.put("CURRENT_STEP_COMMAND",receivedSignal.getUpdatedVariables().get("COMMAND"))
        variables.put("CURRENT_STEP_OUTPUT_FILES",receivedSignal.getUpdatedVariables().get("OUTPUT_FILES"))
        variables.put("CURRENT_STEP_NOTIFICATION",receivedSignal.getUpdatedVariables().get("NOTIFICATION"))
        variables.put("CURRENT_STEP_ACTION",receivedSignal.getUpdatedVariables().get("ACTION"))
        println("Executing Step ${variables.get("CURRENT_STEP_ID")} ...")
    }
}

println(variables.get("CURRENT_STEP_ID"))
println(variables.get("CURRENT_STEP_COMMAND"))
println(variables.get("CURRENT_STEP_OUTPUT_FILES"))
println(variables.get("CURRENT_STEP_NOTIFICATION"))
println(variables.get("CURRENT_STEP_ACTION"))
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
echo "========================================================================================"

original_workspace=/tmp/$variables_BIOSCIENCE_WORKSPACE
current_execution_workspace=$original_workspace/$variables_BIOSCIENCE_EXECUTION_TAG
    
if [[ "$variables_STOP_LOOP" == "false" && "$variables_CURRENT_STEP_ACTION" == "skip" ]]; then
    echo "Skipping $variables_CURRENT_STEP_ID"
    
elif [ "$variables_STOP_LOOP" == "false" ]; then
    echo "Executing $variables_CURRENT_STEP_ID"

    ### Prepare Docker params for Gromacs
    docker_image=$variables_GROMACS_CONTAINER_IMAGE
    inside_workspace=/$variables_BIOSCIENCE_WORKSPACE
    gpuOptions=""
    if [ "$docker_image" == "nvcr.io/hpc/gromacs:2021" ]; then
	    gpuOptions="--gpus all"
        echo "using Gromacs image $docker_image"
    fi
    
    current_step_workspace=$current_execution_workspace/$variables_CURRENT_STEP_ID
    tmp_workspace=$current_step_workspace/temporary
  
    ### Copy original input files
    mkdir -p $current_step_workspace/inputs
    cp -R $variables_BIOSCIENCE_WORKSPACE/inputs/* $current_step_workspace/inputs
    #chmod -R ugo+rw $current_execution_workspace

        
    ### Add previous output files    
    if [ -d  $current_execution_workspace ]; then  
        for i in `find $current_execution_workspace -type f -print | grep -i "result/*" | sort` ; do cp $i $current_step_workspace/inputs ; done
    fi
    
 	### Execute Gromacs command and get its status
    mkdir -p $current_step_workspace/temporary
    cp -R $current_step_workspace/inputs/*  $current_step_workspace/temporary
    
    docker run -i --rm --name gromacs-$variables_PA_JOB_ID  -v $current_step_workspace/temporary:$inside_workspace $gpuOptions $docker_image sh -c "cd $inside_workspace && $variables_CURRENT_STEP_COMMAND && chmod -R ugo+rw $inside_workspace"
     
    if [ $? -ne 0 ] 
    then 
        echo "GROMACS_ERROR=true" > .variables
    	echo "Error occurred in $variables_CURRENT_STEP_ID. Please check the submitted Gromacs command." && exit 0 
    fi
    
    ### Add execution parameters to be transferred to the user data space
    touch $current_step_workspace/parameters
    echo "Workspace:  $variables_BIOSCIENCE_WORKSPACE" >> $current_step_workspace/parameters
    echo "Executed command:  $variables_CURRENT_STEP_COMMAND" >> $current_step_workspace/parameters
    echo "Email of recipient: $variables_EMAIL_RECIPIENT" >> $current_step_workspace/parameters
    echo "Output folder: $current_step_workspace" >> $current_step_workspace/parameters

    ### Add result files to be transferred to the user data space
    mkdir -p $current_step_workspace/result
    
    IFS=',' read -ra FILES <<< "$variables_CURRENT_STEP_OUTPUT_FILES"
	for i in "${FILES[@]}"; do
    	if [ ! -f  $current_step_workspace/temporary/$i ]; then
        	echo "Error: output file $i is not found."
            exit 1
        else
        	cp $current_step_workspace/temporary/$i $current_step_workspace/result
    	fi        
	done
        
    rm -R $current_step_workspace/temporary/   

    cp -R $original_workspace/* $variables_BIOSCIENCE_WORKSPACE
    
    echo "Step $variables_CURRENT_STEP_ID is accomplished"
   
fi

rm -rf $variables_BIOSCIENCE_WORKSPACE/inputs
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="none"/>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
def varFile=new File(localspace, ".variables")
if (varFile.exists()){
    varFile.eachLine { line ->
        keyvalue = line.split("\\s*=\\s*")
        if (keyvalue.length == 2) {
            variables.put(keyvalue[0], keyvalue[1])
        }
    }
    if ("true"==variables.get("GROMACS_ERROR")){
        previousTasks = variables.get("PROCESSED_TASKS")
        previousTasks.remove(variables.get("CURRENT_STEP_ID"))
        variables.put("PROCESSED_TASKS", previousTasks)
    }
}
]]>
          </code>
        </script>
      </post>
      <outputFiles>
        <files accessMode="transferToGlobalSpace" includes="${BIOSCIENCE_WORKSPACE}/**"/>
      </outputFiles>
      <metadata>
        <positionTop>
            359
        </positionTop>
        <positionLeft>
            605.75
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" maxNumberOfExecution="2" name="Check_Errors" onTaskError="suspendTask">
      <depends>
        <task ref="Gromacs_Execute_Step"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
if ("true"==variables.get("GROMACS_ERROR")){
    
    schedulerapi.connect()
    taskState = schedulerapi.getTaskState(org.ow2.proactive.scheduler.job.JobIdImpl.makeJobId(variables.get("PA_JOB_ID")), variables.get("PA_TASK_NAME"))
    
	if (taskState.getNumberOfExecutionLeft() > 0) {
        throw new Exception ("Error occurred in "+variables.get("CURRENT_STEP_ID")+". Please check the submitted Gromacs command.")
    }
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end">
        <loop target="Parse_Molecule_Processing_Steps">
          <script>
            <code language="groovy">
              <![CDATA[
if ("true"==variables.get("GROMACS_ERROR")){
    loop = true
} else {
    loop = false
}
]]>
            </code>
          </script>
        </loop>
      </controlFlow>
      <metadata>
        <positionTop>
            490
        </positionTop>
        <positionLeft>
            703
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Send_Notifications">
      <variables>
        <variable inherited="false" name="MESSAGE" value="${CURRENT_STEP_ID} is finished. You can find its result in the  user dataspace in the folder '${BIOSCIENCE_WORKSPACE}/ ${BIOSCIENCE_EXECUTION_TAG}/${CURRENT_STEP_ID}'."/>
        <variable inherited="false" name="STOP_VNC_SIGNAL" value="Stop-Remote-Visualization"/>
        <variable advanced="false" hidden="false" inherited="false" name="CONTINUATION_SIGNAL" value="Approve ${CURRENT_STEP_ID} and continue"/>
      </variables>
      <depends>
        <task ref="Check_Errors"/>
      </depends>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.notification.client.ApiClient
import org.ow2.proactive.notification.client.api.EventRestApi
import org.ow2.proactive.notification.client.model.EventRequest
import org.ow2.proactive.notification.client.model.Event
import org.ow2.proactive.notification.client.ApiException

if(!variables.get("STOP_LOOP") && variables.get("CURRENT_STEP_NOTIFICATION").equals("true")){

    //Get notification-service URL
    def notifUrl = variables.get('PA_NOTIFICATION_SERVICE_REST_URL')

    // Instantiate EventRestApi instance
    def apiClient = new ApiClient()
    apiClient.setBasePath(notifUrl)
    def eventRestApi = new EventRestApi(apiClient)

    //Get job id
    def jobId = new Long(variables.get("PA_JOB_ID"))

    //Get event message or set default
    def eventMessage = variables.get("MESSAGE")
    if (variables.get("CURRENT_STEP_ACTION").equals("validate")){
            eventMessage+=" To resume the workflow execution, please trigger the action '" +variables.get("CONTINUATION_SIGNAL")+ "'."
    }
    if (eventMessage == null || eventMessage.isEmpty()) {
        eventMessage = "You have a notification."
    }

    // Get event severity or set default
    def eventSeverity = "INFO"
    if (eventSeverity == null || eventSeverity.isEmpty()) {
        eventSeverity = EventRequest.EventSeverityEnum.INFO
    } else {
        eventSeverity = EventRequest.EventSeverityEnum.valueOf(eventSeverity)
    }

    //Get session id
    schedulerapi.connect()
    def sessionId = schedulerapi.getSession()

    //Create event
    def eventRequest = new EventRequest()
            .bucketName(genericInformation.get("bucketName"))
            .workflowName(variables.get("PA_JOB_NAME"))
            .eventType(EventRequest.EventTypeEnum.CUSTOM)
            .eventSeverity(eventSeverity)
            .jobId(jobId)
            .message(eventMessage);

    try {
        result = eventRestApi.createEventUsingPOST(sessionId, eventRequest).toString()
        println("Web notification sent to current user." )
    } catch (ApiException e) {
        System.err.println("Exception when calling EventRestApi#createEventUsingPOST")
        System.err.println(e.getMessage())
    }    
}
]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
import org.ow2.proactive.addons.email.EmailSender;

if(!variables.get("STOP_LOOP") && variables.get("CURRENT_STEP_NOTIFICATION").equals("true")){
    
    try {
        // Note that you must configure SMTP connection a priori !!

        // Email parameters
        //from = variables.get("EMAIL_SENDER")
        from = "noreply@activeeon.com"
        to = variables.get("EMAIL_RECIPIENT")
        subject = variables.get("BIOSCIENCE_EXECUTION_TAG")
        content = variables.get("MESSAGE")
        if (variables.get("CURRENT_STEP_ACTION").equals("validate")){
            content+="To resume the workflow execution, please trigger the action '" +variables.get("CONTINUATION_SIGNAL")+ "'."
        }
        
        // Send email
        EmailSender.Builder builder = new EmailSender.Builder(credentials);
        builder.setFrom(from)
        builder.addRecipient(to)
        builder.setSubject(subject)
        builder.setBody(content)
        builder.build().sendPlainTextEmail();
        
        println "Email notification sent to user "+ to + "."
        
    } catch(Exception e){
    	System.err.println "Email notification failed, no email was sent to user "+ to + "."
        System.err.println(e.getMessage())
    }
}
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[

]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            605
        </positionTop>
        <positionLeft>
            694
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Start">
      <variables>
        <variable inherited="false" name="GROMACS_SIGNAL" value="Start_Gromacs_Processing"/>
      </variables>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[

]]>
          </code>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="groovy">
            <![CDATA[
variables.put("BIOSCIENCE_HOST",variables.get("PA_NODE_HOST"))
//variables.put("PROCESSING_STEPS",variables.get("MOLECULE_PROCESSING_STEPS").replace("/","/resources/"))
println(variables.get("PROCESSING_STEPS"))
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            22
        </positionTop>
        <positionLeft>
            879
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Remote_Visualization_for_VMD">
      <description>
        <![CDATA[ Execute VMD container ]]>
      </description>
      <variables>
        <variable inherited="false" name="NS" value=""/>
        <variable inherited="false" name="NS_BATCH" value=""/>
        <variable inherited="false" name="STOP_VNC_SIGNAL" value="Stop-Remote-Visualization"/>
        <variable inherited="false" model="PA:NOT_EMPTY_STRING" name="VISU_COMMAND" value="Xvnc :${DISPLAY} -geometry 1280x1024 -SecurityTypes None"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/remote-visualization.png"/>
        <info name="DISABLE_PTK" value="true"/>
        <info name="NS" value="${NS}"/>
        <info name="NS_BATCH" value="${NS_BATCH}"/>
      </genericInformation>
      <depends>
        <task ref="Start"/>
      </depends>
      <selection>
        <script type="static">
          <code language="groovy">
            <![CDATA[
/**
 * Script which verifies that the current node runs on the given machine (defined by its hostname)
 *
 * Arguments:
 * machine host name
 */

import com.google.common.base.Strings;

if (args.length != 1) {
    println "Incorrect number of arguments, expected 1, received " + args.length;
    selected = false;
    return;
}

machineName = args[0]

if (Strings.isNullOrEmpty(machineName)) {
    println "Given host name was empty";
    selected = false;
    return;
}

machineName = machineName.trim().toLowerCase()

println "Hostname " + nodehost.toLowerCase() + " (expected :  " + machineName + ")";

selected = (nodehost.toLowerCase() == machineName)
]]>
          </code>
          <arguments>
            <argument value="${BIOSCIENCE_HOST}"/>
          </arguments>
        </script>
      </selection>
      <pre>
        <script>
          <code language="groovy">
            <![CDATA[
/**
 * Pre-Script which enables Remote Visualization using a VNC command and X terminal session
 *
 * This script creates the variable 'VISU_PID' containing the process id of the VNC session started
 * This session should be terminated with a kill command (otherwise the task will remain running)
 *
 * Arguments:
 * display : X display number (e.g. 12)
 * visu_command : command used to start the VNC session (e.g. "Xvnc :${DISPLAY} -geometry 1280x1024 -SecurityTypes None")
 */

// Generate random port for remote visualization
def findPort() {
    findPortScript = new File("find_port.sh")
    findPortScript << '''
    while :
        do
            RND_PORT="`shuf -i 5911-5999 -n 1`"
	        ss -lpn | grep -q ":$RND_PORT " || break
        done
    echo $RND_PORT
    '''
    'chmod u+x find_port.sh'.execute().text
    port = "./find_port.sh".execute().text
    findPortScript.delete() 
    return port
}

    // Prepare remote visualization command
    def visu_command = args[0]
    port = findPort()
    display = port.trim().substring(2)
    variables.put("DISPLAY", display)
    visu_command_final = visu_command.replace('$DISPLAY',display).replace('${DISPLAY}',display)
    println "visu_command = " + visu_command_final

    // Start remote visualization
    def processVisu = visu_command_final.execute()
    processVisu.consumeProcessOutput(System.out, System.err)
    Thread.sleep(1000)
    grepProc = 'ps -aux'.execute() | ['grep', visu_command_final].execute() | 'grep -v grep'.execute() | ['awk', '{ print $2 }'].execute()
    grepProc.waitFor()
    visu_pidText = grepProc.text

    println "Visu process id: " + visu_pidText

    try {
        Integer visuPid = visu_pidText.trim() as Integer
        variables.put("VISU_PID", visuPid)
    } catch (Exception e) {
        throw new IllegalStateException("Visu process cannot be found", e)
    }    

    remoteConnectionString = String.format("PA_REMOTE_CONNECTION;%s;%s;vnc;%s:59%s", variables.get("PA_JOB_ID"), variables.get("PA_TASK_ID"), variables.get("PA_NODE_HOST"), display)
    println remoteConnectionString

    schedulerapi.connect()
    schedulerapi.enableRemoteVisualization(variables.get("PA_JOB_ID"), variables.get("PA_TASK_NAME"), remoteConnectionString)
]]>
          </code>
          <arguments>
            <argument value="${VISU_COMMAND}"/>
          </arguments>
        </script>
      </pre>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
#!/bin/bash

docker_image=$variables_VMD_CONTAINER_IMAGE

gpuOptions=""
if [ "$docker_image" == "activeeon/vmd-gpu" ]; then
	gpuOptions="--gpus all"
    echo "using VMD image $docker_image"
fi

# set the display to be used
export DISPLAY=:${variables_DISPLAY}
#export LIBGL_ALWAYS_INDIRECT=1

outside_workspace=/tmp/$variables_BIOSCIENCE_WORKSPACE/$variables_BIOSCIENCE_EXECUTION_TAG
inside_workspace=/$variables_BIOSCIENCE_WORKSPACE
tmp_workspace=$(pwd)/visu_script

mkdir -p $outside_workspace
chmod -R 777 $outside_workspace

mkdir -p $tmp_workspace
touch $tmp_workspace/connect_to_sim.tcl
echo "menu main on" > $tmp_workspace/connect_to_sim.tcl
echo "display background gradient" >> $tmp_workspace/connect_to_sim.tcl
echo "wait 100000" >> $tmp_workspace/connect_to_sim.tcl


docker run -d --name vmd-$variables_PA_JOB_ID --net=host -e DISPLAY=$DISPLAY -v $outside_workspace:$inside_workspace -v $tmp_workspace:/visu_script $gpuOptions $docker_image /bin/bash -c "vmd -startup /visu_script/connect_to_sim.tcl"

sleep 2

docker logs vmd-$variables_PA_JOB_ID
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
def stopVMD(){    
     // Remove VMD Docker container
	def removeContainerCmd = "docker rm -f vmd-"+variables.get("PA_JOB_ID")
	def removeContainer = removeContainerCmd.execute()
	removeContainer.consumeProcessOutput(System.out, System.err)
	removeContainer.waitForOrKill(10000)
	Thread.sleep(1000)
}

def stopVNC(){
    
    stopVMD()
    
    // Kill remote visualization process (Xvnc) 
	def VISU_PID = variables.get("VISU_PID")
	def killVisCmd = "kill -9 "+VISU_PID
	def killVis = killVisCmd.execute()
	killVis.consumeProcessOutput(System.out, System.err)
	killVis.waitForOrKill(1000)
	Thread.sleep(1000)
    
    def DISPLAY = variables.get("DISPLAY")
	def DISPLAY_LOCK_FILE = new File("/tmp/.X"+DISPLAY+"-lock")
	DISPLAY_LOCK_FILE.delete()
    
    println("Remote visualization stopped")
}

// Read the signal variables
stopVNCSignal = variables.get("STOP_VNC_SIGNAL")

Set<String> signalsSet1 = [stopVNCSignal]
//signalapi.readyForSignal(stopVNCSignal)
receivedSignal = signalapi.waitForAny(signalsSet1)
if(receivedSignal.getName() == stopVNCSignal){
	println("Stopping Remote Visualization ..")
	stopVNC()
}
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            129
        </positionTop>
        <positionLeft>
            1000.5
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2725px;
            height:3120px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-17px;left:-594.25px"><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_127" style="top: 225px; left: 599.25px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Parse_Molecule_Processing_Steps</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon" class="glyphicon glyphicon-list-alt"></i></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_130" style="top: 128px; left: 713px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png" width="20px">&nbsp;<span class="name">Start_Molecule_Processing</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_133" style="top: 829px; left: 676px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_loop.png" width="20px">&nbsp;<span class="name">Loop_Over_Molecule_Processing_Steps</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_136" style="top: 717px; left: 703px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Send_Signal</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_139" style="top: 359px; left: 605.75px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Execute Gromacs commands"><img src="/automation-dashboard/styles/patterns/img/wf-icons/gromacs.jpeg" width="20px">&nbsp;<span class="name">Gromacs_Execute_Step</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_142" style="top: 490px; left: 703px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Check_Errors</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_145" style="top: 605px; left: 694px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Send_Notifications</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" id="jsPlumb_1_148" style="top: 22px; left: 879px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/studio/images/Groovy.png" width="20px">&nbsp;<span class="name">Start</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_151" style="top: 129px; left: 1000.5px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Execute VMD container"><img src="/automation-dashboard/styles/patterns/img/wf-icons/remote-visualization.png" width="20px">&nbsp;<span class="name">Remote_Visualization_for_VMD</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><svg style="position:absolute;left:687.5px;top:167.5px" width="117" height="58" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 57 C -10 7 106 50 96 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M8.518579499999996,35.79823725 L29.69944747763124,35.189277715913136 L21.59422537838805,30.795489518703377 L24.696699746334616,22.113631837525084 L8.518579499999996,35.79823725" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M8.518579499999996,35.79823725 L29.69944747763124,35.189277715913136 L21.59422537838805,30.795489518703377 L24.696699746334616,22.113631837525084 L8.518579499999996,35.79823725" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:783.5px;top:61.5px" width="156" height="67" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 66 C -10 16 145 50 135 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M16.75008,42.192768 L37.924685067414636,42.99032692510744 L30.1288109432887,38.06850341742416 L33.8004204848388,29.611595981818738 L16.75008,42.192768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M16.75008,42.192768 L37.924685067414636,42.99032692510744 L30.1288109432887,38.06850341742416 L33.8004204848388,29.611595981818738 L16.75008,42.192768" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:742.5px;top:756.5px" width="55" height="73" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 34 72 C 44 22 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M34.180064,52.496172000000016 L30.222321298227584,31.67944140399702 L27.16846588217245,40.37851992403756 L18.10466922226513,38.69103952182457 L34.180064,52.496172000000016" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M34.180064,52.496172000000016 L30.222321298227584,31.67944140399702 L27.16846588217245,40.37851992403756 L18.10466922226513,38.69103952182457 L34.180064,52.496172000000016" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:874.5px;top:117.5px" width="51" height="762" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 0 C 50 -50 13 711 23 661 " transform="translate(0.5,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M24.652257750000004,117.32254425000005 L32.38721710964706,137.04994660572362 L25.170082226258945,131.31296446569718 L18.39679689394992,137.56777108198258 L24.652257750000004,117.32254425000005" class="" stroke="#316b31" fill="#316b31" transform="translate(0.5,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M24.652257750000004,117.32254425000005 L32.38721710964706,137.04994660572362 L25.170082226258945,131.31296446569718 L18.39679689394992,137.56777108198258 L24.652257750000004,117.32254425000005" class="" stroke="#316b31" fill="#316b31" transform="translate(0.5,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_168" style="position: absolute; transform: translate(-50%, -50%); left: 901px; top: 498px;">loop</div><svg style="position:absolute;left:742.5px;top:644.5px" width="24" height="73" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 72 C -10 22 13 50 3 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.49525,54.238500000000016 L5.6896923602362435,34.693507839356656 L-1.6569991556278412,40.26361769201941 L-8.285189947744362,33.8552569949845 L-2.49525,54.238500000000016" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-2.49525,54.238500000000016 L5.6896923602362435,34.693507839356656 L-1.6569991556278412,40.26361769201941 L-8.285189947744362,33.8552569949845 L-2.49525,54.238500000000016" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:670px;top:264.5px" width="38.5" height="95" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 94 C -10 44 27.5 50 17.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.2073550000000008,70.796592 L10.506685790111908,53.139263539341115 L2.2436766972979125,57.22860098348451 L-3.0613052264035847,49.68823184204321 L-1.2073550000000008,70.796592" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-1.2073550000000008,70.796592 L10.506685790111908,53.139263539341115 L2.2436766972979125,57.22860098348451 L-3.0613052264035847,49.68823184204321 L-1.2073550000000008,70.796592" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:670px;top:398.5px" width="94" height="92" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 73 91 C 83 41 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M67.21378025,65.75909675 L57.43696555077132,46.95979106237031 L57.013691000174305,56.16961400609821 L47.847482806869536,57.159880312196 L67.21378025,65.75909675" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M67.21378025,65.75909675 L57.43696555077132,46.95979106237031 L57.013691000174305,56.16961400609821 L47.847482806869536,57.159880312196 L67.21378025,65.75909675" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:793.5px;top:214.5px" width="54" height="326" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 0 C 50 -50 -3 275 7 225 " transform="translate(3.5,50.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M21.139672750000003,25.295906250000005 L29.12442860498396,44.923531525012244 L21.835049949207818,39.27862596223131 L15.141708892752655,45.618908724220056 L21.139672750000003,25.295906250000005" class="" stroke="#316b31" fill="#316b31" transform="translate(3.5,50.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M21.139672750000003,25.295906250000005 L29.12442860498396,44.923531525012244 L21.835049949207818,39.27862596223131 L15.141708892752655,45.618908724220056 L21.139672750000003,25.295906250000005" class="" stroke="#316b31" fill="#316b31" transform="translate(3.5,50.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_183" style="position: absolute; transform: translate(-50%, -50%); left: 815px; top: 377px;">loop</div><svg style="position:absolute;left:743px;top:529.5px" width="23.5" height="76" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 2.5 75 C 12.5 25 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M5.049614374999998,56.597043750000005 L10.945049628130437,36.244062563546095 L4.2837562783497525,42.618007253309855 L-3.0339868685597153,37.00992066019634 L5.049614374999998,56.597043750000005" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M5.049614374999998,56.597043750000005 L10.945049628130437,36.244062563546095 L4.2837562783497525,42.618007253309855 L-3.0339868685597153,37.00992066019634 L5.049614374999998,56.597043750000005" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:918.5px;top:61.5px" width="184" height="68" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 163 67 C 173 17 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M140.34375,42.46875 L122.67454395990217,30.772632784762713 L126.77226407946404,39.03148802152148 L119.23728198142365,44.344118705298676 L140.34375,42.46875" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M140.34375,42.46875 L122.67454395990217,30.772632784762713 L126.77226407946404,39.03148802152148 L119.23728198142365,44.344118705298676 L140.34375,42.46875" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 688px; top: 255px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 688px; top: 215px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 787px; top: 255px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 784px; top: 158px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 784px; top: 118px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 865px; top: 158px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 777px; top: 859px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 777px; top: 819px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 888px; top: 819px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 743px; top: 747px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 743px; top: 707px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 670.5px; top: 389px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 670.5px; top: 349px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 743.5px; top: 520px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 743.5px; top: 480px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 794px; top: 480px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 746px; top: 635px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 746px; top: 595px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 919px; top: 52px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 1082px; top: 159px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 1082px; top: 119px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>
