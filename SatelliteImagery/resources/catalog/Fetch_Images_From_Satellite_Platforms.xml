<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<job xmlns="urn:proactive:jobdescriptor:3.14" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" maxNumberOfExecution="2" name="Fetch_Images_From_Satellite_Platforms" onTaskError="continueJobExecution" priority="normal" tags="imagery,satellite" projectName="Satellite Imagery" xsi:schemaLocation="urn:proactive:jobdescriptor:3.14 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.14/schedulerjob.xsd">
  <variables>
    <variable advanced="false" description="Defines an engine to search and download satellite images." hidden="false" model="PA:LIST(Copernicus,Creodias,Mundi,Onda,Peps,Sobloo,Wekeo,All)" name="SEARCH_ENGINE" value="Peps"/>
    <variable advanced="false" description="Selects the type of data source." hidden="false" model="PA:LIST(PA:URL,PA:URI,PA:USER_FILE,PA:GLOBAL_FILE)" name="IMPORT_FROM" value="PA:GLOBAL_FILE"/>
    <variable advanced="false" description="Path or name of the file that contains the dataset." hidden="false" model="PA:GLOBAL_FILE" name="FILE_PATH" value="geojson_example.json"/>
    <variable advanced="false" description="Defines time in seconds to request an offline product from the Long Term Archive (LTA) in the Copernicus Open Access Hub’s." hidden="false" name="TIME_TO_RETRIEVE_IN_SECONDS" value="900"/>
    <variable advanced="false" description="Defines time in seconds to check if a product is online." hidden="false" name="TIME_TO_CHECK_ONLINE_IN_SECONDS" value="1800"/>
    <variable advanced="false" description="Defines the maximum execution time of a task." hidden="false" name="WALLTIME" value="24:00:00"/>
    <variable advanced="false" description="Specifies the path where the data should be downloaded." hidden="false" name="OUTPUT_PATH" value="/tmp/"/>
    <variable advanced="false" description="Determines the policy used by the ProActive Scheduler to determine how Jobs and Tasks are scheduled." hidden="false" name="REQUIRED_LICENSES" value="software_A"/>
  </variables>
  <description>
    <![CDATA[ Search and download Earth Observation products from different providers, such as Copernicus, Creodias, Mundi, Onda, Peps, Sobloo and Wekeo. Find more information about the EODAG  and Copernicus Open Access Hub can be found at https://eodag.readthedocs.io and https://scihub.copernicus.eu ]]>
  </description>
  <genericInformation>
<info name="bucketName" value="satellite-imagery"/>
<info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/sentinel_image.jpg"/>
<info name="Documentation" value="PAIO/PAIOUserGuide.html#_satellite_imagery_bucket"/>
<info name="group" value="public-objects"/>
</genericInformation>
  <taskFlow>
    <task fork="false" name="Condition">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <depends>
        <task ref="Import_GeoData"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
print('Checking platform...')
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow>
        <if continuation="Continuation" else="Else" target="Fetch_Satellite_Images_From_EODAG">
          <script>
            <code language="cpython">
              <![CDATA[
SEARCH_ENGINE  = variables.get("SEARCH_ENGINE") 		 # Option host sites

if SEARCH_ENGINE.lower() == "creodias" or SEARCH_ENGINE.lower() == "mundi" or SEARCH_ENGINE.lower() == "peps" or SEARCH_ENGINE.lower() == "sobloo" or SEARCH_ENGINE.lower() == "onda" or SEARCH_ENGINE.lower() == "wekeo" or SEARCH_ENGINE.lower() == "all":
    branch = "if"
else:
    branch = "else"
]]>
            </code>
          </script>
        </if>
      </controlFlow>
      <metadata>
        <positionTop>
            233.5625
        </positionTop>
        <positionLeft>
            460.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Fetch_Satellite_Images_From_EODAG">
      <description>
        <![CDATA[ Load and return a dataset including a
'metadata folder' with metadata files and 'images folder' containing satellite images.

Please access: https://eodag.readthedocs.io/en/stable/ ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/eodag.png"/>
        <info name="task.documentation" value="PAIO/PAIOUserGuide.html#_satellite_imagery_bucket"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

print('Starting download....')
print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"/>
      <metadata>
        <positionTop>
            361.5625
        </positionTop>
        <positionLeft>
            332.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Else">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[

]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            361.5625
        </positionTop>
        <positionLeft>
            460.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Continuation">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[

]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            361.5625
        </positionTop>
        <positionLeft>
            588.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Condition2">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <depends>
        <task ref="Import_GeoData"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
print('Searching satellite images...')
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow>
        <if continuation="Continuation2" else="Else2" target="Fetch_Satellite_Images_From_Copernicus">
          <script>
            <code language="cpython">
              <![CDATA[
SEARCH_ENGINE  = variables.get("SEARCH_ENGINE") 		 # Option host sites

if SEARCH_ENGINE.lower() == "copernicus" or SEARCH_ENGINE.lower() == "all":
    branch = "if"
else:
    branch = "else"
]]>
            </code>
          </script>
        </if>
      </controlFlow>
      <metadata>
        <positionTop>
            233.5625
        </positionTop>
        <positionLeft>
            844.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Fetch_Satellite_Images_From_Copernicus">
      <description>
        <![CDATA[ Load and return a Copernicus dataset including a 'metadata folder' with metadata files and 'images folder' containing satellite images according to the resolution & image band selected by user.

Please access:
https://peps.cnes.fr/rocket/#/register to create a new user account from Copernicus website.

Please add third party credentials (USER_NAME_COP and USER_PASS_COP) in the Scheduling & Orchestration interface → Manage Third-Party Credentials to connect to Copernicus. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/copernicus.png"/>
        <info name="task.documentation" value="PAIO/PAIOUserGuide.html#_satellite_imagery_bucket"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

print('Starting download....')
print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"/>
      <metadata>
        <positionTop>
            361.5625
        </positionTop>
        <positionLeft>
            716.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Else2">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[

]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            361.5625
        </positionTop>
        <positionLeft>
            844.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Continuation2">
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[

]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            361.5625
        </positionTop>
        <positionLeft>
            972.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Import_GeoData">
      <description>
        <![CDATA[ Import geo dataset. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/geodata.jpg"/>
        <info name="task.documentation" value="PAIO/PAIOUserGuide.html#_satellite_imagery_bucket"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import json
import uuid
from os.path import join, os

from sentinelsat.sentinel import read_geojson

if 'variables' in locals():
    IMPORT_FROM = variables.get("IMPORT_FROM")
    FILE_PATH = variables.get("FILE_PATH")  # Geojson file search_footprints.geojson with footprints of the query result
    OUTPUT_PATH = variables.get("OUTPUT_PATH")  # Folder output path
    SEARCH_ENGINE = variables.get("SEARCH_ENGINE")  # search engine

# Get an unique ID
ID = str(uuid.uuid4())

# Get current job ID
PA_JOB_ID = variables.get("PA_JOB_ID")

# Get an unique ID
#ID = str(uuid.uuid4())
ID_JOB = 'Job_' + str(PA_JOB_ID)

# Define the current 'dataset_path'
os.chdir(OUTPUT_PATH)
dataset_path = join(OUTPUT_PATH, ID, ID_JOB)

# Create the folders tmp
os.makedirs(dataset_path, exist_ok = True)
os.chmod(dataset_path, mode=0o770)

# Define path to download the dataset
os.chdir(dataset_path)

print('The path input dataset:', dataset_path)

# -------------------------------------------------------------
# Load file
#
if IMPORT_FROM.upper() == "PA:USER_FILE":
    print("Importing file from the user space")
    userspaceapi.connect()
    out_file = gateway.jvm.java.io.File(os.path.join(dataset_path, FILE_PATH))
    userspaceapi.pullFile(FILE_PATH, out_file)

if IMPORT_FROM.upper() == "PA:GLOBAL_FILE":
    print("Importing file from the global space")
    globalspaceapi.connect()
    out_file = gateway.jvm.java.io.File(os.path.join(dataset_path, FILE_PATH))
    globalspaceapi.pullFile(FILE_PATH, out_file)

gjson = read_geojson(os.path.join(dataset_path, FILE_PATH))
n_acq = len(gjson.features)
print('{s:{c}^{n}}'.format(s=' GEOJSON DATA ', n=75, c='#'))
print('{s:{c}^{n}}'.format(s='#', n=75, c='#'))
print(gjson)

gjson_data = json.dumps(gjson).encode('utf-8')

if 'variables' in locals():
    variables.put("DATASET_PATH", dataset_path)
    variables.put("GJSON_DATA", gjson_data)
    variables.put("N_acq", n_acq)
    
print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            105.5625
        </positionTop>
        <positionLeft>
            652.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Split">
      <description>
        <![CDATA[ This task defines some input, here strings to be processed. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
        <info name="Documentation" value="user/ProActiveUserGuide.html#_replicate"/>
      </genericInformation>
      <depends>
        <task ref="Fetch_Satellite_Images_From_EODAG"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import os
import sys
import json
import time
import shutil
import subprocess
import random as r
from zipfile import ZipFile
from os.path import join, os
from collections import OrderedDict
from ast import literal_eval as make_tuple

from distutils.dir_util import copy_tree
from geojson import FeatureCollection

try:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt
except ImportError:
    subprocess.call([sys.executable, "-m", "pip", "install", 'sentinelsat'])
finally:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt


if 'variables' in locals():
    DATASET_PATH = variables.get("DATASET_PATH")  # folder dataset path
    GJSON_DATA = variables.get("GJSON_DATA")  # gson data
    N_acq = variables.get("N_acq")  # number of features
    SEARCH_ENGINE = variables.get("SEARCH_ENGINE")  # gson data

if SEARCH_ENGINE.lower() == 'peps' or SEARCH_ENGINE.lower() == 'all':
    provider = 'peps'
    
if SEARCH_ENGINE.lower() == 'creodias':
    provider = 'creodias'  
    
if SEARCH_ENGINE.lower() == 'sobloo':
    provider = 'sobloo'  
    
if SEARCH_ENGINE.lower() == 'onda':
    provider = 'onda'  
    
if SEARCH_ENGINE.lower() == 'mundi':
    provider = 'mundi'

if SEARCH_ENGINE.lower() == 'wekeo':
    provider = 'wekeo'

gjson_dec = json.loads(GJSON_DATA.decode('utf-8'))
gjson = FeatureCollection(gjson_dec)
gjson['features'] = list(gjson['features'])

# Loop for each trial
result = {}
for i in range(N_acq):
    result[i] =  json.dumps(gjson[i])
    print(result[i])

variables.put("PROVIDER", provider)  

print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow>
        <replicate>
          <script>
            <code language="groovy">
              <![CDATA[
runs=result.size()
]]>
            </code>
          </script>
        </replicate>
      </controlFlow>
      <metadata>
        <positionTop>
            489.5625
        </positionTop>
        <positionLeft>
            332.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" maxNumberOfExecution="2" name="Process" taskRetryDelay="1:00">
      <description>
        <![CDATA[ This task will be replicated according to the 'runs' value specified in the replication script. The replication index is used in each task's instance to select the input. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
      </genericInformation>
      <depends>
        <task ref="Split"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import os
import sys
import json
import time
import copy
import shutil
import psutil
import pickle
import subprocess
import random as r
from pathlib import Path
from zipfile import ZipFile
from os.path import join, os
from collections import OrderedDict
from geojson import FeatureCollection

import eodag
import geojson
from pprint import pprint
from eodag.utils import ProgressCallback
from eodag.utils.logging import setup_logging
from eodag.api.core import EODataAccessGateway

from distutils.dir_util import copy_tree
from ast import literal_eval as make_tuple

try:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt
except ImportError:
    subprocess.call([sys.executable, "-m", "pip", "install", 'sentinelsat'])
finally:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt
    
    
USER_NAME_PEPS = credentials.get("USER_NAME_PEPS")  # user email
USER_PASS_PEPS = credentials.get("USER_PASS_PEPS")  # user password
USER_NAME_CREODIAS = credentials.get("USER_NAME_CREODIAS")  # user email
USER_PASS_CREODIAS = credentials.get("USER_PASS_CREODIAS")  # user password
USER_NAME_SOBLOO = credentials.get("USER_NAME_SOBLOO")  # user email
USER_PASS_SOBLOO = credentials.get("USER_PASS_SOBLOO")  # user password
APIKEY_SOBLOO = credentials.get("APIKEY_SOBLOO")  # user key
USER_NAME_ONDA = credentials.get("USER_NAME_ONDA")  # user email
USER_PASS_ONDA = credentials.get("USER_PASS_ONDA")  # user password
USER_NAME_MUNDI = credentials.get("USER_NAME_MUNDI")  # user email
USER_PASS_MUNDI = credentials.get("USER_PASS_MUNDI")  # user password
APIKEY_MUNDI = credentials.get("APIKEY_MUNDI")  # user key
USER_NAME_WEKEO = credentials.get("USER_NAME_WEKEO")  # user name
USER_PASS_WEKEO = credentials.get("USER_PASS_WEKEO")  # user password
DATASET_PATH = variables.get("DATASET_PATH")  # folder dataset path
PROVIDER = variables.get("PROVIDER")
TIME_TO_RETRIEVE_IN_SECONDS = int(variables.get("TIME_TO_RETRIEVE_IN_SECONDS"))   # try product download in seconds
TIME_TO_CHECK_IN_SECONDS = int(variables.get("TIME_TO_CHECK_ONLINE_IN_SECONDS"))  # check online product download in seconds

# PEPS
if PROVIDER.lower() == "peps" or PROVIDER.lower() == "all":
    os.environ["EODAG__PEPS__AUTH__CREDENTIALS__USERNAME"] = USER_NAME_PEPS 
    os.environ["EODAG__PEPS__AUTH__CREDENTIALS__PASSWORD"] = USER_PASS_PEPS

# CREODIAS
if PROVIDER.lower() == "creodias":
    os.environ["EODAG__CREODIAS__AUTH__CREDENTIALS__USERNAME"] = USER_NAME_CREODIAS
    os.environ["EODAG__CREODIAS__AUTH__CREDENTIALS__PASSWORD"] = USER_PASS_CREODIAS

# SOBLOO
if PROVIDER.lower() == "sobloo":
    os.environ["EODAG__SOBLOO__AUTH__CREDENTIALS__APIKEY"] = APIKEY_SOBLOO
    os.environ["EODAG__SOBLOO__AUTH__CREDENTIALS__USERNAME"] = USER_NAME_SOBLOO
    os.environ["EODAG__SOBLOO__AUTH__CREDENTIALS__PASSWORD"] = USER_PASS_SOBLOO

# ONDA
if PROVIDER.lower() == "onda":
    os.environ["EODAG__ONDA__AUTH__CREDENTIALS__USERNAME"] = USER_NAME_ONDA
    os.environ["EODAG__ONDA__AUTH__CREDENTIALS__PASSWORD"] = USER_PASS_ONDA

# MUNDI
if PROVIDER.lower() == "mundi":
    os.environ["EODAG__MUNDI__AUTH__CREDENTIALS__APIKEY"] = APIKEY_MUNDI
    os.environ["EODAG__MUNDI__AUTH__CREDENTIALS__USERNAME"] = USER_NAME_MUNDI
    os.environ["EODAG__MUNDI__AUTH__CREDENTIALS__PASSWORD"] = USER_PASS_MUNDI
    
# WEKEO
if PROVIDER.lower() == "wekeo":
    os.environ["EODAG__WEKEO__AUTH__CREDENTIALS__USERNAME"] =  USER_NAME_WEKEO
    os.environ["EODAG__WEKEO__AUTH__CREDENTIALS__PASSWORD"] =  USER_PASS_WEKEO

# Get current job ID
PA_JOB_ID = variables.get("PA_JOB_ID")

# Print task replication number
i = int(variables.get('PA_TASK_REPLICATION'))

# Get data from the split task
features_dec = json.loads(str(results[0].value()[i]))
print("Task id: ", i, " ", features_dec)
features = FeatureCollection(features_dec)

# Define the current 'dataset_path'
os.chdir(DATASET_PATH)

TASK_NUMBER = 'Process_' + str(i)
output_path = join(DATASET_PATH, TASK_NUMBER, PROVIDER)

# Create the folders
os.makedirs(output_path, exist_ok=True)
# Change the permission
os.chmod(output_path, mode=0o770)

filename = os.path.join(output_path, 'output.json')
json_object = json.dumps(features, sort_keys=True, indent=4)
# writing to filename.json
with open(filename, "w") as outfile:
    outfile.write(json_object)

dicfile = {}
def get_info_json(features, cont, product_tmp, filename):
    ditc = {"Folder_" + str(cont): output_path + '/' + product_tmp}
    dicfile.update(ditc)
    features['features'].update({'output_path': dicfile})

                                 
print('The path output dataset:', output_path)

# -------------------------------------------------------------

try:
    footprint = features['geometry']
    product_type = features['properties']["producttype"]
    start_date = features['properties']["beginposition"]
    end_date = features['properties']["endposition"]
except:
    footprint = features['geometry']
    product_type = 'S2_MSI_L1C'
    start_date = None
    end_date = None
    print('The latformname is defined by Sentinel-2!')
    print('The producttype is defined by S2_MSI_L1C!')
    print('The beginposition and endposition are defined by None!')

try:
    cloud_cover_percentage = features['properties']["cloudcoverpercentage"]
    cloud_cover_percentage =  make_tuple(cloud_cover_percentage)
except:
    cloud_cover_percentage = None

print('{s:{c}^{n}}'.format(s=' GEOJSON SETTINGS ', n=75, c='#'))
print('{s:{c}^{n}}'.format(s='#', n=75, c='#'))
print("Footprint:", footprint)
print("Product Type:", product_type)
print("Start Date:", start_date)
print("End Date:", end_date)
print("Cloud Cover Percentage:", cloud_cover_percentage)

# To have some basic feedback on what eodag is doing, we configure logging to output minimum information
setup_logging(verbose=3)
dag = EODataAccessGateway()

print(dag.available_providers())
dag.set_preferred_provider(PROVIDER.lower()) 
curr_prov, _ = dag.get_preferred_provider()
print("Current provider:", curr_prov)

def bbox(coord_list):
    box = []
    for i in (0,1):
        res = sorted(coord_list, key=lambda x:x[i])
        box.append((res[0][i],res[-1][i]))
    extent =  {
        'lonmin': box[0][1],
        'lonmax': box[0][0],
        'latmin':  box[1][0],
        'latmax': box[1][1]
    }
    return extent

# you need to parse your json here
poly= footprint
extent= bbox(list(geojson.utils.coords(poly)))
print('Bounding box:', extent)

footbox = dict()
for key in extent:
    # rounding to K using round()
    footbox[key] = round(extent[key], 6) 

if product_type =='S2MSI1C':
    product_type = 'S2_MSI_L1C'
    
# get data %Y - year %m - month %d - day 
if PROVIDER.lower() == "sobloo" or PROVIDER.lower() == "onda" or PROVIDER.lower() == "mundi":
    start = start_date.split("T")[0]
    end = end_date.split("T")[0]
else:
    start = start_date
    end = end_date

products, estimated_total_nbr_of_results = dag.search(productType=product_type, start=start,end=end, geom=footbox, cloudCover=cloud_cover_percentage)
pprint(products)

# Checking if the list is empty or not
if len(products) == 0:
	raise SystemExit('Unexpected error occurred! No online products were download!')

def request_analysis(products):
    requests_online = []
    requests_offline = []
    
    if len(products) > 0:
        cont = 0
        print("Total products:", len(products))
        for p in products:
            if p.properties["storageStatus"] == "ONLINE":
                requests_online.append(products[cont])
            else: 
                requests_offline.append(products[cont])
            cont +=1
    else:
        print('No products were found')
    return requests_online, requests_offline
   
    
# list of the online and offline products
requests_online, requests_offline = request_analysis(products)

if len(requests_online) > 0:
    print("Total online products:", len(requests_online))
    path_on = dag.download_all(requests_online, wait=0.1, timeout=1, outputs_prefix=output_path,progress_callback=ProgressCallback())
    
if len(requests_offline) > 0:
    print("Total offline products:", len(requests_offline))
    path_off = dag.download_all(requests_offline, wait=(TIME_TO_RETRIEVE_IN_SECONDS/60), timeout=(TIME_TO_CHECK_IN_SECONDS/60), outputs_prefix=output_path,progress_callback=ProgressCallback())


def check_online(products):
    requests_online, requests_offline = request_analysis(products)
    total_prod_size = 0
    cont = 0
    if len(requests_online) > 0:
        for p in requests_online:
            if p.properties["storageStatus"] == "ONLINE":
                get_info_json(features, cont+1, p.properties["id"], filename)
                # in bytes
                try:
                    total_prod_size += p.properties["resourceSize"]
                except:
                    total_prod_size += 0
            cont +=1    
    return total_prod_size   
    
        
print('{s:{c}^{n}}'.format(s='CHECK DISC SPACE ', n=75, c='#'))
total, used, free, percent = psutil.disk_usage(DATASET_PATH)
print('Total: {}B'.format(round(total)))
print('Used: {}B'.format((round(used))))
print('Free: {}B'.format((round(free))))
print('Total used (%): {}%'.format(round(percent)))
print('{s:{c}^{n}}'.format(s='', n=75, c='#'))


# check if there is enough disk space (bytes)
total_prod_size  = check_online(products)
if free < total_prod_size:
    print('Disk space available: {}B'.format(free))
    print('Total products size: {}B'.format(total_prod_size))
    raise SystemExit('No space left on device: %s' % DATASET_PATH)    


# List all .zip folders
folder_zip = [i for i in [os.path.relpath(os.path.join(output_path, p)) for p in os.listdir(output_path)] if i.endswith('.zip')]

# remove all .zip files 
for file_name in folder_zip:
	print('Deleting the file: {}.'.format(join(output_path, file_name)))
	os.remove(file_name)
        
print('All zip file names: {} '.format(folder_zip))
   

# Checking if online products downloaded
if len(path_on) == 0:
	feature_data =  json.dumps(features).encode('utf-8')
	raise SystemExit('Unexpected error occurred! No online products were download!')
else: 
	feature_data =  json.dumps(features).encode('utf-8')
	variables.put("FEATURE_DATA"+str(i), feature_data)


print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"/>
      <metadata>
        <positionTop>
            617.5625
        </positionTop>
        <positionLeft>
            332.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Merge">
      <description>
        <![CDATA[ As a merge operation, we simply print the results from previous tasks. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
      </genericInformation>
      <depends>
        <task ref="PostProcess"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import json
import shutil
import pickle
from os.path import join, os
from geojson import FeatureCollection

i = int(variables.get('PA_TASK_REPLICATION'))    # task replication number
TASK_NUMBER = 'Process_' + str(i)
DATASET_PATH = variables.get("DATASET_PATH")  # folder dataset path
PROVIDER = variables.get('PROVIDER')          # provider name
output_path_corrupted_files = join(DATASET_PATH, 'corrupted_files', PROVIDER)
output_path_suc_files = join(DATASET_PATH, 'suc_files', PROVIDER)

# add info json
def create_json(features, filename):
    json_object = json.dumps(features, sort_keys=True, indent=4)
    # writing to filename.json
    with open(filename, "w") as outfile:
        outfile.write(json_object)

def read_files(output_path_files):
    features = []
    corrupted_files = os.listdir(output_path_files)
    for f in corrupted_files:
        fp = os.path.join(output_path_files, f)
        content = pickle.load(open(fp,'rb'))
        features.append(content)
    return features


if  os.path.isdir(output_path_corrupted_files):
    features = read_files(output_path_corrupted_files)
    feature_collection = FeatureCollection(features)
    filename = os.path.join(DATASET_PATH, PROVIDER+'_output_error.json')
    create_json(feature_collection, filename)
    shutil.rmtree(output_path_corrupted_files)


if os.path.isdir(output_path_suc_files):
    features2 = read_files(output_path_suc_files)
    feature_collection2 = FeatureCollection(features2)
    filename = os.path.join(DATASET_PATH, PROVIDER+'_output.json')
    create_json(feature_collection2, filename)
    shutil.rmtree(output_path_suc_files)

print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end"/>
      <metadata>
        <positionTop>
            873.5625
        </positionTop>
        <positionLeft>
            332.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Split2">
      <description>
        <![CDATA[ This task defines some input, here strings to be processed. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
        <info name="Documentation" value="user/ProActiveUserGuide.html#_replicate"/>
      </genericInformation>
      <depends>
        <task ref="Fetch_Satellite_Images_From_Copernicus"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import os
import sys
import json
import time
import shutil
import subprocess
import random as r
from zipfile import ZipFile
from os.path import join, os
from collections import OrderedDict
from ast import literal_eval as make_tuple

from distutils.dir_util import copy_tree
from geojson import FeatureCollection

try:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt
except ImportError:
    subprocess.call([sys.executable, "-m", "pip", "install", 'sentinelsat'])
finally:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt

    
if 'variables' in locals():
    DATASET_PATH = variables.get("DATASET_PATH")  # folder dataset path
    GJSON_DATA = variables.get("GJSON_DATA")  # gson data
    N_acq = variables.get("N_acq")  # number of features
    SEARCH_ENGINE = variables.get("SEARCH_ENGINE")  # search provider

if SEARCH_ENGINE.lower() == 'copernicus' or SEARCH_ENGINE.lower() == 'all':
    provider = 'copernicus'

gjson_dec = json.loads(GJSON_DATA.decode('utf-8'))
gjson = FeatureCollection(gjson_dec)
gjson['features'] = list(gjson['features'])

# Loop for each trial
result = {}
for i in range(N_acq):
    result[i] =  json.dumps(gjson[i])
    print(result[i])
    
variables.put("PROVIDER", provider) 

print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow>
        <replicate>
          <script>
            <code language="groovy">
              <![CDATA[
runs=result.size()
]]>
            </code>
          </script>
        </replicate>
      </controlFlow>
      <metadata>
        <positionTop>
            489.5625
        </positionTop>
        <positionLeft>
            716.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" maxNumberOfExecution="2" name="Process2" taskRetryDelay="1:00">
      <description>
        <![CDATA[ This task will be replicated according to the 'runs' value specified in the replication script. The replication index is used in each task's instance to select the input. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
        <info name="REQUIRED_LICENSES" value="$REQUIRED_LICENSES"/>
        <info name="WALLTIME" value="$WALLTIME"/>
      </genericInformation>
      <depends>
        <task ref="Split2"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import os
import sys
import json
import time
import copy
import shutil
import psutil
import pickle
import subprocess
import random as r
from pathlib import Path
from zipfile import ZipFile
from os.path import join, os
from collections import OrderedDict
from geojson import FeatureCollection

from distutils.dir_util import copy_tree
from ast import literal_eval as make_tuple

try:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt
except ImportError:
    subprocess.call([sys.executable, "-m", "pip", "install", 'sentinelsat'])
finally:
    from sentinelsat.sentinel import SentinelAPI, read_geojson, geojson_to_wkt

USER_NAME = credentials.get("USER_NAME_COP")  # user email
USER_PASS = credentials.get("USER_PASS_COP")  # user password
DATASET_PATH = variables.get("DATASET_PATH")  # folder dataset path
PROVIDER = variables.get("PROVIDER")
TIME_TO_RETRIEVE_IN_SECONDS = int(variables.get("TIME_TO_RETRIEVE_IN_SECONDS"))   # try product download in seconds
TIME_TO_CHECK_IN_SECONDS = int(variables.get("TIME_TO_CHECK_ONLINE_IN_SECONDS"))  # check online product download in seconds

# Get current job ID
PA_JOB_ID = variables.get("PA_JOB_ID")

# Print task replication number
i = int(variables.get('PA_TASK_REPLICATION'))

# Get data from the split task
features_dec = json.loads(str(results[0].value()[i]))
print("Task id: ", i, " ", features_dec)
features = FeatureCollection(features_dec)

# Define the current 'dataset_path'
os.chdir(DATASET_PATH)

TASK_NUMBER = 'Process_' + str(i)
output_path = join(DATASET_PATH, TASK_NUMBER, PROVIDER)

# Create the folders
os.makedirs(output_path, exist_ok=True)
# Change the permission
os.chmod(output_path, mode=0o770)

print('The path output Copernicus dataset:', output_path)

# -------------------------------------------------------------

#  SentinelAPI
api = SentinelAPI(USER_NAME, USER_PASS, 'https://scihub.copernicus.eu/dhus')
# get dic with product filenames
def get_filename(product):
    dicfile = {}
    cont = 1
    query_id = list(product.keys())
    for i in query_id:
        ditc = {"Folder_" + str(cont): output_path + '/' + product[i]['filename']}
        dicfile.update(ditc)
        cont += 1
    return dicfile

filename = os.path.join(output_path, 'output.json')

def add_info_json(features, filename):
    json_object = json.dumps(features, sort_keys=True, indent=4)
    # writing to filename.json
    with open(filename, "w") as outfile:
        outfile.write(json_object)

    with open(filename, 'a+') as f:
        print('Creating output.json file!')

# Create .json for each query
add_info_json(features, filename)

def get_info_json(features, product_tmp):
    dicfile = get_filename(product_tmp)
    features['features'].update({'output_path': dicfile})

# list of the online and offline products
def request_analysis(product):
    requests_online = OrderedDict()
    requests_offline = OrderedDict()
    for k in product.keys():  # print all keys
        product_info = api.get_product_odata(k)
        if product_info['Online']:
            requests_online[k] = product[k]
        else:
            requests_offline[k] = product[k]
    return requests_online, requests_offline

# download the online
def download_daemon(requests_online):
    if len(requests_online) > 0:
        for i in requests_online:
            print('Product {} is online. Starting download.'.format(i))
            api.download(i, directory_path=output_path, checksum=True)
    else:
        print('There are no products online.')

# retrieve the products from LTA
def retrieve_from_lta(requests_offline):
    requests_pending = OrderedDict()
    for k in requests_offline:
        req_pend = api.download(k, directory_path=output_path, checksum=True)  # download or retrieve product from LTA
        requests_pending[k] = req_pend
    if len(requests_pending) > 0:
        print("%d Retreiving offline product, lets's wait {} seconds before trying again".format(TIME_TO_RETRIEVE_IN_SECONDS))
        time.sleep(TIME_TO_RETRIEVE_IN_SECONDS)  # Delay in seconds
    return requests_pending

# check the online products regularly every time
def check_online(requests_pending):
    requests_online_pending, requests_offline_pending = request_analysis(requests_pending)
    if len(requests_online_pending) > 0:
        download_daemon(requests_online_pending)

    if len(requests_offline_pending) > 0:
        print("%d Check status product, lets's wait {} seconds.".format(TIME_TO_CHECK_IN_SECONDS))
        time.sleep(TIME_TO_CHECK_IN_SECONDS)
        check_online(requests_offline_pending)
    else:
        print('All products were downloaded')


queries = []
Nprods = []
queries_json = []
total_prod_size = 0
product = OrderedDict()
product_tmp = OrderedDict()

try:
    footprint = geojson_to_wkt(features['geometry'], decimals=6)
    platform_name = features['properties']["platformname"]
    product_type = features['properties']["producttype"]
    start_date = features['properties']["beginposition"]
    end_date = features['properties']["endposition"]
except:
    footprint = geojson_to_wkt(features['geometry'], decimals=6)
    platform_name = 'Sentinel-2'
    product_type = 'S2MSI1C'
    start_date = None
    end_date = None
    print('The latformname is defined by Sentinel-2!')
    print('The producttype is defined by S2MSI1C!')
    print('The beginposition and endposition are defined by None!')

try:
    cloud_cover_percentage = features['properties']["cloudcoverpercentage"]
    cloud_cover_percentage =  make_tuple(cloud_cover_percentage)
except:
    cloud_cover_percentage =  (None, None)

print('{s:{c}^{n}}'.format(s=' GEOJSON SETTINGS ', n=75, c='#'))
print('{s:{c}^{n}}'.format(s='#', n=75, c='#'))
print("Footprint:", footprint)
print("Platform Name:", platform_name)
print("Product Type:", product_type)
print("Start Date:", start_date)
print("End Date:", end_date)
print("Cloud Cover Percentage:", cloud_cover_percentage)

# query the OpenSearch API with the coordinates of an area, a date interval and any other search keywords accepted by the API.
query_ac = api.query(area=footprint, producttype=product_type, date=(start_date, end_date),
                         platformname=platform_name, cloudcoverpercentage=cloud_cover_percentage)
queries.append(query_ac)
# save the query results in an orderedDict
product.update(query_ac)

# api.count get the number of products matching a query
Nprods.append(api.count(area=footprint, producttype=product_type, date=(start_date, end_date), platformname=platform_name))
# geoJSON FeatureCollection containing footprints and metadata of the scenes
queries_json.append(api.to_geojson(query_ac))

# return the total file size in GB of all products in the OpenSearch response.
total_prod_size += api.get_products_size(query_ac)


# convert bytes to gigabytes
print('{s:{c}^{n}}'.format(s=' CHECK DISC SPACE ', n=75, c='#'))
total, used, free, percent = psutil.disk_usage(DATASET_PATH)
print('Total: {}GB'.format(round(total/1024.0/1024.0/1024.0,1)))
print('Used: {}GB'.format((round(used/1024.0/1024.0/1024.0,1))))
print('Free: {}GB'.format((round(free/1024.0/1024.0/1024.0,1))))
print('Total used (%): {}%'.format(round(percent)))
print('{s:{c}^{n}}'.format(s='', n=75, c='#'))


# check if there is enough disk space
if free < total_prod_size:
    print('Disk space available: {}B'.format(free))
    print('Total products size: {}B'.format(total_prod_size))
    raise SystemExit('No space left on device: %s' % DATASET_PATH)

# Number of product(s)
print('Total number of products available: {} '.format(len(product)))

# list of the online and offline products
requests_online, requests_offline = request_analysis(product)

# Number of on versus off product(s)
print('Online numnber of product(s): {} '.format(len(requests_online)))
print('Offline numnber of product(s): {} '.format(len(requests_offline)))

if requests_online:
    try:
        download_daemon(requests_online)
        print('Download finished!')
    except Exception as err:
        print("Unexpected error:", err, sys.exc_info()[0])
        raise
else:
    print("There no online product!")

if requests_offline:
    try:
        # retrieve the products from LTA
        requests_pending = retrieve_from_lta(requests_offline)
        # check the online products regularly every time
        check_online(requests_pending)
        print('Download finished!')
    except Exception as err:
        print("Unexpected error:", err, sys.exc_info()[0])
        raise
else:
    print("There no offline product!")

# List all .zip folders
folder_zip = [i for i in [os.path.relpath(os.path.join(output_path, p)) for p in os.listdir(output_path)] if
              i.endswith('.zip')]

# Unzip folders
print('**********************************************************************************************************')
print('Extracting all the files...')
print('**********************************************************************************************************')

def unzip_files(folder_zip, output_path):
    corrupted_file = []
    for file_name in folder_zip:
        try:
            shutil.unpack_archive(file_name, output_path)
            print('Unzip file name: {} '.format(file_name))
            # remove each successful zip file
            os.remove(file_name)
        except:
            corrupted_file.append(file_name)
            print('Error while unzip file name: {}. Try to unzip it manually...'.format(file_name))
            # remove each corrupted zip file
            os.remove(file_name)
    return corrupted_file


# call unzip_files function
corrupted_file = unzip_files(folder_zip, output_path)


if len(corrupted_file) > 0:
    feature_data =  json.dumps(features).encode('utf-8')

    print('Deleting the folder: {}.'.format(join(DATASET_PATH, TASK_NUMBER)))
    # Remove the "dataset_path" directory
    shutil.rmtree(join(DATASET_PATH, TASK_NUMBER))
    raise SystemExit('Error caused by corrupted or incomplete products: {}'.format(corrupted_file))

else:
	# add info filename and save output json file
    product_tmp.update(query_ac)
    get_info_json(features, product_tmp)
    product_tmp = OrderedDict()

    feature_data =  json.dumps(features).encode('utf-8')
    variables.put("FEATURE_DATA"+str(i), feature_data)

    print('All files were successfully unzipped')
    # List all .safe folders
    folder_safe = [i for i in [os.path.relpath(os.path.join(output_path, p)) for p in os.listdir(output_path)] if
               i.endswith('.SAFE')]

    print('All zip file names: {} '.format( folder_zip))
    print('All safe file names: {} '.format(folder_safe))

    # call again to save the outuput path in the json file

print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="start"/>
      <metadata>
        <positionTop>
            617.5625
        </positionTop>
        <positionLeft>
            716.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="Merge2">
      <description>
        <![CDATA[ As a merge operation, we simply print the results from previous tasks. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
      </genericInformation>
      <depends>
        <task ref="PostProcess2"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import json
import shutil
import pickle
from os.path import join, os
from geojson import FeatureCollection

i = int(variables.get('PA_TASK_REPLICATION'))    # task replication number
TASK_NUMBER = 'Process_' + str(i)
DATASET_PATH = variables.get("DATASET_PATH")  # folder dataset path
PROVIDER = variables.get('PROVIDER')          # provider name
output_path_corrupted_files = join(DATASET_PATH, 'corrupted_files', PROVIDER)
output_path_suc_files = join(DATASET_PATH, 'suc_files', PROVIDER)

# add info json
def create_json(features, filename):
    json_object = json.dumps(features, sort_keys=True, indent=4)
    # writing to filename.json
    with open(filename, "w") as outfile:
        outfile.write(json_object)

def read_files(output_path_files):
    features = []
    corrupted_files = os.listdir(output_path_files)
    for f in corrupted_files:
        fp = os.path.join(output_path_files, f)
        content = pickle.load(open(fp,'rb'))
        features.append(content)
    return features


if  os.path.isdir(output_path_corrupted_files):
    features = read_files(output_path_corrupted_files)
    feature_collection = FeatureCollection(features)
    filename = os.path.join(DATASET_PATH, PROVIDER+'_output_error.json')
    create_json(feature_collection, filename)
    shutil.rmtree(output_path_corrupted_files)


if os.path.isdir(output_path_suc_files):
    features2 = read_files(output_path_suc_files)
    feature_collection2 = FeatureCollection(features2)
    filename = os.path.join(DATASET_PATH, PROVIDER+'_output.json')
    create_json(feature_collection2, filename)
    shutil.rmtree(output_path_suc_files)

print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end"/>
      <metadata>
        <positionTop>
            873.5625
        </positionTop>
        <positionLeft>
            716.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="PostProcess2">
      <description>
        <![CDATA[ The simplest task, ran by a Python engine. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/postprocess.png"/>
      </genericInformation>
      <depends>
        <task ref="Process2"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import os
import sys
import json
import time
import copy
import shutil
import psutil
import pickle
import subprocess
import random as r
from pathlib import Path
from zipfile import ZipFile
from os.path import join, os
from collections import OrderedDict
from geojson import FeatureCollection


i = int(variables.get('PA_TASK_REPLICATION'))    # task replication number
DATASET_PATH = variables.get("DATASET_PATH")     # folder dataset path
TASK_NUMBER = 'Process_' + str(i)
PROVIDER = variables.get("PROVIDER")

task_exception = results[0].hadException()
print("task_exception: ", task_exception)

if task_exception == True:
    GJSON_DATA = variables.get("GJSON_DATA")      # gson data
    gjson_dec = json.loads(GJSON_DATA.decode('utf-8'))
    gjson = FeatureCollection(gjson_dec)
    gjson['features'] = list(gjson['features'])
    feature = gjson[int(i)]
    corrup_features = copy.deepcopy(feature)

    output_path_corrupted_files = join(DATASET_PATH, 'corrupted_files', PROVIDER)
    os.makedirs(output_path_corrupted_files, exist_ok=True)
    os.chmod(output_path_corrupted_files, mode=0o770)

    # generate error file
    name_error =  TASK_NUMBER + '_output_error.ob'
    filename_error = os.path.join(output_path_corrupted_files, name_error)

    with open(filename_error, 'wb') as fp:
        pickle.dump(corrup_features, fp)
        
    output_path = join(DATASET_PATH, TASK_NUMBER, PROVIDER)
    shutil.rmtree(output_path)
else:
    FEATURE_DATA = variables.get("FEATURE_DATA"+str(i))  # gson data
    feature = json.loads(FEATURE_DATA.decode('utf-8'))
    succ_features = copy.deepcopy(feature)

    output_path_suc_files = join(DATASET_PATH, 'suc_files', PROVIDER)
    os.makedirs(output_path_suc_files, exist_ok=True)
    os.chmod(output_path_suc_files, mode=0o770)

    name_suc =  TASK_NUMBER + '_output.ob'
    filename_suc = os.path.join(output_path_suc_files, name_suc)

    with open(filename_suc, 'wb') as fp:
        pickle.dump(succ_features['features'], fp)
        
print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end"/>
      <metadata>
        <positionTop>
            745.5625
        </positionTop>
        <positionLeft>
            716.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="false" name="PostProcess">
      <description>
        <![CDATA[ The simplest task, ran by a Python engine. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/postprocess.png"/>
      </genericInformation>
      <depends>
        <task ref="Process"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import os
import sys
import json
import time
import copy
import shutil
import psutil
import pickle
import subprocess
import random as r
from pathlib import Path
from zipfile import ZipFile
from os.path import join, os
from collections import OrderedDict
from geojson import FeatureCollection


i = int(variables.get('PA_TASK_REPLICATION'))    # task replication number
DATASET_PATH = variables.get("DATASET_PATH")     # folder dataset path
TASK_NUMBER = 'Process_' + str(i)
PROVIDER = variables.get("PROVIDER")

task_exception = results[0].hadException()
print("task_exception: ", task_exception)

if task_exception == True:
    GJSON_DATA = variables.get("GJSON_DATA")      # gson data
    gjson_dec = json.loads(GJSON_DATA.decode('utf-8'))
    gjson = FeatureCollection(gjson_dec)
    gjson['features'] = list(gjson['features'])
    feature = gjson[int(i)]
    corrup_features = copy.deepcopy(feature)

    output_path_corrupted_files = join(DATASET_PATH, 'corrupted_files', PROVIDER)
    os.makedirs(output_path_corrupted_files, exist_ok=True)
    os.chmod(output_path_corrupted_files, mode=0o770)

    # generate error file
    name_error =  TASK_NUMBER + '_output_error.ob'
    filename_error = os.path.join(output_path_corrupted_files, name_error)

    with open(filename_error, 'wb') as fp:
        pickle.dump(corrup_features, fp)
        
    output_path = join(DATASET_PATH, TASK_NUMBER, PROVIDER)
    shutil.rmtree(output_path)
else:
    FEATURE_DATA = variables.get("FEATURE_DATA"+str(i))  # gson data
    feature = json.loads(FEATURE_DATA.decode('utf-8'))
    succ_features = copy.deepcopy(feature)

    output_path_suc_files = join(DATASET_PATH, 'suc_files', PROVIDER)
    os.makedirs(output_path_suc_files, exist_ok=True)
    os.chmod(output_path_suc_files, mode=0o770)

    name_suc =  TASK_NUMBER + '_output.ob'
    filename_suc = os.path.join(output_path_suc_files, name_suc)

    with open(filename_suc, 'wb') as fp:
        pickle.dump(succ_features['features'], fp)
        
print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <controlFlow block="end"/>
      <metadata>
        <positionTop>
            745.5625
        </positionTop>
        <positionLeft>
            332.46875
        </positionLeft>
      </metadata>
    </task>
    <task fork="true" name="Final_Merge">
      <description>
        <![CDATA[ The simplest task, ran by a Python engine. ]]>
      </description>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
      </genericInformation>
      <depends>
        <task ref="Continuation"/>
        <task ref="Continuation2"/>
      </depends>
      <scriptExecutable>
        <script>
          <code language="cpython">
            <![CDATA[
__file__ = variables.get("PA_TASK_NAME")

import os
import json
import shutil
import pickle
from pathlib import Path
from os.path import join, os
from geojson import FeatureCollection

i = int(variables.get('PA_TASK_REPLICATION'))    # task replication number
TASK_NUMBER = 'Process_' + str(i)
DATASET_PATH = variables.get("DATASET_PATH")  # folder dataset path
output_path_corrupted_files = join(DATASET_PATH, 'corrupted_files')
output_path_suc_files = join(DATASET_PATH, 'suc_files')

if  os.path.isdir(output_path_corrupted_files):
    shutil.rmtree(output_path_corrupted_files)

if os.path.isdir(output_path_suc_files):
    shutil.rmtree(output_path_suc_files)    

# delete emppty directory
os.chdir(DATASET_PATH)
directory_contents = os.listdir(DATASET_PATH)

for item in directory_contents:
    if os.path.isdir(item):
        if len(os.listdir(item)) == 0:
            shutil.rmtree(item)
            
print("END " + __file__)
]]>
          </code>
        </script>
      </scriptExecutable>
      <metadata>
        <positionTop>
            489.5625
        </positionTop>
        <positionLeft>
            972.46875
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2506px;
            height:3088px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-100.5625px;left:-327.46875px"><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_129" style="top: 233.562px; left: 460.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Condition</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_132" style="top: 361.562px; left: 332.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Load and return a dataset including a
'metadata folder' with metadata files and 'images folder' containing satellite images.

Please access: https://eodag.readthedocs.io/en/stable/"><img src="/automation-dashboard/styles/patterns/img/wf-icons/eodag.png" width="20px">&nbsp;<span class="name">Fetch_Satellite_Images_From_EODAG</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_135" style="top: 361.562px; left: 460.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Else</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_138" style="top: 361.562px; left: 588.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Continuation</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_141" style="top: 233.562px; left: 844.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Condition2</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_144" style="top: 361.562px; left: 716.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Load and return a Copernicus dataset including a 'metadata folder' with metadata files and 'images folder' containing satellite images according to the resolution &amp; image band selected by user.

Please access:
https://peps.cnes.fr/rocket/#/register to create a new user account from Copernicus website.

Please add third party credentials (USER_NAME_COP and USER_PASS_COP) in the Scheduling &amp; Orchestration interface → Manage Third-Party Credentials to connect to Copernicus."><img src="/automation-dashboard/styles/patterns/img/wf-icons/copernicus.png" width="20px">&nbsp;<span class="name">Fetch_Satellite_Images_From_Copernicus</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_147" style="top: 361.562px; left: 844.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Else2</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_150" style="top: 361.562px; left: 972.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task has no description"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_if.png" width="20px">&nbsp;<span class="name">Continuation2</span></a></div><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" id="jsPlumb_1_153" style="top: 105.562px; left: 652.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="Import geo dataset."><img src="/automation-dashboard/styles/patterns/img/wf-icons/geodata.jpg" width="20px">&nbsp;<span class="name">Import_GeoData</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_156" style="top: 489.562px; left: 332.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task defines some input, here strings to be processed."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Split</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_159" style="top: 617.562px; left: 332.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task will be replicated according to the 'runs' value specified in the replication script. The replication index is used in each task's instance to select the input."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Process</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_162" style="top: 873.562px; left: 332.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="As a merge operation, we simply print the results from previous tasks."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Merge</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_165" style="top: 489.562px; left: 716.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task defines some input, here strings to be processed."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Split2</span></a></div><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_168" style="top: 617.562px; left: 716.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="This task will be replicated according to the 'runs' value specified in the replication script. The replication index is used in each task's instance to select the input."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Process2</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_171" style="top: 873.562px; left: 716.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="As a merge operation, we simply print the results from previous tasks."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Merge2</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_174" style="top: 745.562px; left: 716.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="The simplest task, ran by a Python engine."><img src="/automation-dashboard/styles/patterns/img/wf-icons/postprocess.png" width="20px">&nbsp;<span class="name">PostProcess2</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_177" style="top: 745.562px; left: 332.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="The simplest task, ran by a Python engine."><img src="/automation-dashboard/styles/patterns/img/wf-icons/postprocess.png" width="20px">&nbsp;<span class="name">PostProcess</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" id="jsPlumb_1_180" style="top: 489.562px; left: 972.469px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="The simplest task, ran by a Python engine."><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Final_Merge</span></a></div><svg style="position:absolute;left:499.5px;top:145.5px" width="217.5" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 206.5 50 196.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M30.172271999999996,59.394175999999995 L51.346577432048974,60.1996506863191 L43.55254380452781,55.274913148838635 L47.22731458088762,46.819378881791295 L30.172271999999996,59.394175999999995" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M30.172271999999996,59.394175999999995 L51.346577432048974,60.1996506863191 L43.55254380452781,55.274913148838635 L47.22731458088762,46.819378881791295 L30.172271999999996,59.394175999999995" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:321.5px;top:273.5px" width="149" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 138 50 128 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M15.734015999999999,60.999424000000005 L36.77298385959016,58.47715688426225 L28.30356794508451,54.834493838204 L30.608053697794155,45.90760493917774 L15.734015999999999,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M15.734015999999999,60.999424000000005 L36.77298385959016,58.47715688426225 L28.30356794508451,54.834493838204 L30.608053697794155,45.90760493917774 L15.734015999999999,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_191" style="position: absolute; transform: translate(-50%, -50%); left: 395.5px; top: 317.5px;">if</div><svg style="position:absolute;left:444.98171321138256px;top:273.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#00f" fill="#00f" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#00f" fill="#00f" transform="translate(15.018286788617468,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_195" style="position: absolute; transform: translate(-50%, -50%); left: 452px; top: 317.5px;">else</div><svg style="position:absolute;left:449.5px;top:273.5px" width="149" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 128 88 C 138 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M112.265984,60.999424000000005 L97.39194630220584,45.90760493917774 L99.69643205491549,54.834493838204 L91.22701614040983,58.47715688426225 L112.265984,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M112.265984,60.999424000000005 L97.39194630220584,45.90760493917774 L99.69643205491549,54.834493838204 L91.22701614040983,58.47715688426225 L112.265984,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_199" style="position: absolute; transform: translate(-50%, -50%); left: 523.5px; top: 317.5px;">continuation</div><svg style="position:absolute;left:696px;top:145.5px" width="208.5" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 187.5 88 C 197.5 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M159.934085625,59.788559500000005 L143.09037171683312,46.93207079663212 L146.6241172793056,55.44750632863551 L138.74931854546864,60.24203914232649 L159.934085625,59.788559500000005" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M159.934085625,59.788559500000005 L143.09037171683312,46.93207079663212 L146.6241172793056,55.44750632863551 L138.74931854546864,60.24203914232649 L159.934085625,59.788559500000005" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:705.5px;top:273.5px" width="149" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 138 50 128 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M15.734015999999999,60.999424000000005 L36.77298385959016,58.47715688426225 L28.30356794508451,54.834493838204 L30.608053697794155,45.90760493917774 L15.734015999999999,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M15.734015999999999,60.999424000000005 L36.77298385959016,58.47715688426225 L28.30356794508451,54.834493838204 L30.608053697794155,45.90760493917774 L15.734015999999999,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_208" style="position: absolute; transform: translate(-50%, -50%); left: 779.5px; top: 317.5px;">if</div><svg style="position:absolute;left:828.9817132113825px;top:273.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#00f" fill="#00f" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#00f" fill="#00f" transform="translate(15.018286788617468,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_212" style="position: absolute; transform: translate(-50%, -50%); left: 836px; top: 317.5px;">else</div><svg style="position:absolute;left:833.5px;top:273.5px" width="149" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 128 88 C 138 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#00f" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M112.265984,60.999424000000005 L97.39194630220584,45.90760493917774 L99.69643205491549,54.834493838204 L91.22701614040983,58.47715688426225 L112.265984,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M112.265984,60.999424000000005 L97.39194630220584,45.90760493917774 L99.69643205491549,54.834493838204 L91.22701614040983,58.47715688426225 L112.265984,60.999424000000005" class="" stroke="#00f" fill="#00f" transform="translate(10.5,0.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_216" style="position: absolute; transform: translate(-50%, -50%); left: 907.5px; top: 317.5px;">continuation</div><svg style="position:absolute;left:371.5px;top:401.5px" width="76" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 65 50 55 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M2.839999999999998,64.44800000000001 L20.86340542224991,53.30543041371461 L11.647531623104692,53.56556522151359 L9.980970643763493,44.497898790609916 L2.839999999999998,64.44800000000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M2.839999999999998,64.44800000000001 L20.86340542224991,53.30543041371461 L11.647531623104692,53.56556522151359 L9.980970643763493,44.497898790609916 L2.839999999999998,64.44800000000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:397.46578674770865px;top:519.5px" width="15.034213252291345" height="99" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 88 -10 -10 0 0 " transform="translate(14.534213252291345,10.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#e5db3d" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.889249999999999,77.41936575 L-0.6632823303137547,56.65542592021898 L-6.785898453911784,63.54843482802241 L-14.534213252291345,58.55207437413076 L-4.889249999999999,77.41936575" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(14.534213252291345,10.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.889249999999999,77.41936575 L-0.6632823303137547,56.65542592021898 L-6.785898453911784,63.54843482802241 L-14.534213252291345,58.55207437413076 L-4.889249999999999,77.41936575" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(14.534213252291345,10.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_225" style="position: absolute; transform: translate(-50%, -50%); left: 404px; top: 569.75px;">replicate</div><svg style="position:absolute;left:366.98171321138256px;top:529.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path></svg><svg style="position:absolute;left:366.98171321138256px;top:785.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path></svg><svg style="position:absolute;left:755.5px;top:401.5px" width="83.5" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 72.5 50 62.5 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M3.9181393749999978,63.998374500000004 L22.655876611475385,54.10407294522597 L13.443584528330181,53.738457607992615 L12.395959719467998,44.57862779189579 L3.9181393749999978,63.998374500000004" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M3.9181393749999978,63.998374500000004 L22.655876611475385,54.10407294522597 L13.443584528330181,53.738457607992615 L12.395959719467998,44.57862779189579 L3.9181393749999978,63.998374500000004" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:781.4657867477086px;top:519.5px" width="15.034213252291345" height="99" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 88 -10 -10 0 0 " transform="translate(14.534213252291345,10.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#e5db3d" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.889249999999999,77.41936575 L-0.6632823303137547,56.65542592021898 L-6.785898453911784,63.54843482802241 L-14.534213252291345,58.55207437413076 L-4.889249999999999,77.41936575" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(14.534213252291345,10.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.889249999999999,77.41936575 L-0.6632823303137547,56.65542592021898 L-6.785898453911784,63.54843482802241 L-14.534213252291345,58.55207437413076 L-4.889249999999999,77.41936575" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(14.534213252291345,10.5)"></path></svg><div class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_240" style="position: absolute; transform: translate(-50%, -50%); left: 788px; top: 569.75px;">replicate</div><svg style="position:absolute;left:750.9817132113825px;top:529.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path></svg><svg style="position:absolute;left:750.9817132113825px;top:785.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path></svg><svg style="position:absolute;left:750.9817132113825px;top:657.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path></svg><svg style="position:absolute;left:366.98171321138256px;top:657.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path></svg><svg style="position:absolute;left:627.5px;top:401.5px" width="405" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 384 88 C 394 38 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M315.54356249999995,58.23743749999999 L296.8440045221951,48.27116781497169 L301.7071022262402,56.1038098162961 L294.7103768384912,62.10762808873146 L315.54356249999995,58.23743749999999" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M315.54356249999995,58.23743749999999 L296.8440045221951,48.27116781497169 L301.7071022262402,56.1038098162961 L294.7103768384912,62.10762808873146 L315.54356249999995,58.23743749999999" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:1006.9817132113825px;top:401.5px" width="15.518286788617468" height="89" pointer-events="none" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 88 C -10 38 -10 50 0 0 " transform="translate(15.018286788617468,0.5)" pointer-events="visibleStroke" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path><path pointer-events="all" version="1.1" xmlns="http://www.w3.org/1999/xhtml" d="M-4.427999999999998,66.303232 L-1.2615185838583702,45.35154005301801 L-7.026331880366543,52.546463795240896 L-15.018286788617468,47.94987193338456 L-4.427999999999998,66.303232" class="" stroke="#666" fill="#666" transform="translate(15.018286788617468,0.5)"></path></svg><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 500px; top: 264px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 500px; top: 224px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint if-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 450px; top: 264px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 427px; top: 392px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 322px; top: 352px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 500px; top: 392px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 450px; top: 352px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 628px; top: 392px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 578px; top: 352px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 884px; top: 264px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 884px; top: 224px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint if-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 834px; top: 264px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 818.5px; top: 392px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 706px; top: 352px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 884px; top: 392px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 834px; top: 352px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 1012px; top: 392px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint if-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 962px; top: 352px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#00f" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 696.5px; top: 136px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 520px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 480px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint replicate-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 402px; top: 520px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 648px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint replicate-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 402px; top: 608px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 608px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 904px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 864px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 520px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 480px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint replicate-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 786px; top: 520px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 648px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint replicate-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full" style="position: absolute; height: 20px; width: 20px; left: 786px; top: 608px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 608px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 904px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 864px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 776px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 756px; top: 736px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 776px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 372px; top: 736px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 1012px; top: 520px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected" style="position: absolute; height: 20px; width: 20px; left: 1012px; top: 480px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>
